<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>相続税調査分析システム v3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Yu Gothic', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            transform: rotate(30deg);
            pointer-events: none;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .upload-section {
            padding: 40px;
            background: #fafbfc;
            border-bottom: 2px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .file-input-group {
            background: white;
            padding: 30px;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-group:hover {
            border-color: #3498db;
            background: #f8fbff;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.15);
        }
        
        .file-input-group.uploaded {
            border-color: #27ae60;
            border-style: solid;
            background: #f0fdf4;
        }
        
        .file-input-group.uploaded::after {
            content: '✓';
            position: absolute;
            top: 15px;
            right: 15px;
            color: #27ae60;
            font-size: 28px;
            font-weight: bold;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            background: #f8f9fa;
            font-size: 15px;
        }
        
        .file-label {
            display: block;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        
        .file-description {
            font-size: 0.9em;
            color: #718096;
            line-height: 1.6;
            margin-bottom: 12px;
            text-align: left;
        }
        
        .file-status {
            margin-top: 15px;
            font-size: 0.95em;
            color: #27ae60;
            font-weight: 600;
            display: none;
        }
        
        .config-section {
            margin-top: 35px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .config-item label {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-item input, .config-item select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #7f8c8d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5f6a6a;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin: 25px 0 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                45deg,
                rgba(255,255,255,0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.2) 50%,
                rgba(255,255,255,0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progress-animation 1s linear infinite;
        }
        
        @keyframes progress-animation {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }
        
        .status-message {
            padding: 16px 24px;
            border-radius: 8px;
            margin: 25px 0;
            font-weight: 600;
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-15px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .status-success { 
            background: #d5f4e6; 
            color: #27ae60; 
            border: 2px solid #a9dfbf;
            border-left: 5px solid #27ae60;
        }
        
        .status-error { 
            background: #fadbd8; 
            color: #e74c3c; 
            border: 2px solid #f5b7b1;
            border-left: 5px solid #e74c3c;
        }
        
        .status-warning { 
            background: #fef5e7; 
            color: #f39c12; 
            border: 2px solid #fad7a0;
            border-left: 5px solid #f39c12;
        }
        
        .status-info { 
            background: #d6eaf8; 
            color: #2980b9; 
            border: 2px solid #aed6f1;
            border-left: 5px solid #3498db;
        }
        
        .analysis-container {
            padding: 40px;
            display: none;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 3px solid #e9ecef;
            margin-bottom: 35px;
            overflow-x: auto;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            padding: 8px;
            gap: 8px;
        }
        
        .tab {
            padding: 16px 28px;
            background: transparent;
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: 700;
            color: #7f8c8d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border-radius: 8px 8px 0 0;
            position: relative;
            flex-shrink: 0;
        }
        
        .tab:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .tab.active {
            background: white;
            color: #3498db;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
        }
        
        .tab-content {
            display: none;
            min-height: 500px;
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* カード型コンポーネント */
        .info-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .info-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-card {
            padding: 20px 30px;
            margin: 25px 0;
            border-radius: 12px;
            border-left: 6px solid;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .alert-card.warning {
            background: #fef5e7;
            color: #f39c12;
            border-color: #f39c12;
        }
        
        .alert-card.danger {
            background: #fadbd8;
            color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .alert-card.info {
            background: #d6eaf8;
            color: #2980b9;
            border-color: #3498db;
        }
        
        .alert-card.success {
            background: #d5f4e6;
            color: #27ae60;
            border-color: #27ae60;
        }
        
        /* データテーブル */
        .data-table-wrapper {
            overflow-x: auto;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 700px;
        }
        
        .data-table th {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 16px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 15px;
            border-bottom: 3px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f3f6;
            font-size: 15px;
        }
        
        .data-table tr:hover {
            background: #f8fbff;
        }
        
        .data-table tr.highlighted {
            background: #fef5e7;
            font-weight: 600;
        }
        
        /* 注記・フラグスタイル（改良版） */
        .annotation-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 700;
            margin: 3px;
            white-space: nowrap;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        /* 金額関連（赤系） */
        .badge-large-amount {
            background: #fee;
            color: #c00;
            border: 2px solid #fcc;
        }
        
        .badge-unknown-source {
            background: #fdd;
            color: #a00;
            border: 2px solid #fbb;
        }
        
        /* 資金移動関連（青系） */
        .badge-money-shift {
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #90caf9;
        }
        
        .badge-suspicious-shift {
            background: #bbdefb;
            color: #0d47a1;
            border: 2px solid #64b5f6;
        }
        
        /* 時期関連（橙系） */
        .badge-inheritance-period {
            background: #fff3e0;
            color: #e65100;
            border: 2px solid #ffcc80;
        }
        
        /* 口座関連（緑系） */
        .badge-account-open {
            background: #e8f5e9;
            color: #1b5e20;
            border: 2px solid #81c784;
        }
        
        .badge-account-close {
            background: #fce4ec;
            color: #880e4f;
            border: 2px solid #f48fb1;
        }
        
        /* 人物関連（紫系） */
        .badge-minor {
            background: #f3e5f5;
            color: #4a148c;
            border: 2px solid #ba68c8;
        }
        
        .badge-cohabit {
            background: #e8eaf6;
            color: #283593;
            border: 2px solid #7986cb;
        }
        
        /* その他（黄系） */
        .badge-blank-memo {
            background: #fffde7;
            color: #f57f17;
            border: 2px solid #fff176;
        }
        
        /* 残高推移表（改良版） */
        .balance-table-wrapper {
            overflow-x: auto;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .balance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 900px;
        }
        
        .balance-table th {
            background: #2c3e50;
            color: white;
            padding: 16px 14px;
            text-align: center;
            font-weight: 700;
            font-size: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .balance-table td {
            padding: 14px;
            text-align: right;
            border: 1px solid #f0f3f6;
            font-size: 15px;
        }
        
        .balance-table tr:nth-child(even) {
            background: #fafbfc;
        }
        
        .balance-table tr:hover {
            background: #e3f2fd;
        }
        
        .balance-table .person-name {
            font-weight: 700;
            text-align: left;
            background: #f8f9fa;
            color: #2c3e50;
        }
        
        .balance-table .account-row {
            padding-left: 35px;
            text-align: left;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .balance-table .total-row {
            font-weight: 700;
            background: #e8f5e9;
            border-top: 3px solid #27ae60;
        }
        
        .balance-table .inheritance-date {
            background: #2c3e50;
            color: white;
            font-weight: 700;
        }
        
        .balance-positive {
            color: #27ae60;
            font-weight: 700;
        }
        
        .balance-negative {
            color: #e74c3c;
            font-weight: 700;
        }
        
        .balance-change {
            font-size: 12px;
            color: #7f8c8d;
            display: block;
            margin-top: 3px;
        }
        
        .balance-interpolated {
            font-style: italic;
            color: #9b59b6;
        }
        
        /* 家系図スタイル（改良版） */
        .family-tree-wrapper {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 50px;
            margin: 25px 0;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .family-tree-title {
            text-align: center;
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 50px;
            color: #2c3e50;
        }
        
        .family-tree-svg {
            width: 100%;
            min-height: 700px;
            display: block;
        }
        
        .member-box {
            fill: white;
            stroke: #3498db;
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .member-box:hover {
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.2));
        }
        
        .member-box.deceased {
            fill: #fadbd8;
            stroke: #e74c3c;
        }
        
        .member-box.male {
            /* 男性は角張った四角形 */
        }
        
        .member-box.female {
            rx: 35;
            ry: 35;
        }
        
        .member-text {
            font-family: 'Yu Gothic', 'Meiryo', sans-serif;
            font-size: 15px;
            fill: #34495e;
        }
        
        .member-name {
            font-weight: 800;
            font-size: 18px;
            fill: #2c3e50;
        }
        
        .relation-line {
            stroke: #95a5a6;
            stroke-width: 3;
            fill: none;
        }
        
        .spouse-line {
            stroke: #e91e63;
            stroke-width: 4;
        }
        
        /* 判定基準説明（改良版） */
        .criteria-explanation {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .criteria-explanation h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .criteria-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .criteria-category {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .criteria-category h5 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .criteria-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .criteria-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px;
            background: #fafbfc;
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        .criteria-badge {
            flex-shrink: 0;
        }
        
        /* ズームコントロール（新規追加） */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }
        
        /* 印刷スタイル */
        @media print {
            body {
                padding: 0;
                background: white;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .btn, .file-input-group, .config-section {
                display: none !important;
            }
            
            .tab-container {
                display: none;
            }
            
            .tab-content {
                display: block !important;
                page-break-after: always;
            }
            
            .data-table {
                font-size: 11px;
            }
            
            @page {
                size: A3 landscape;
                margin: 15mm;
            }
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .file-grid, .config-grid {
                grid-template-columns: 1fr;
            }
            
            .tab {
                font-size: 14px;
                padding: 12px 20px;
            }
            
            .data-table {
                font-size: 13px;
            }
            
            .data-table th, .data-table td {
                padding: 10px;
            }
        }
        
        /* ローディングアニメーション */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 6px solid #ecf0f1;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ユーティリティクラス */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .highlight-row {
            background: #fef5e7 !important;
            font-weight: 700;
        }
        
        .danger-highlight {
            background: #fadbd8 !important;
            color: #e74c3c;
        }
        
        .success-highlight {
            background: #d5f4e6 !important;
            color: #27ae60;
        }
        
        /* 信頼度表示（新規追加） */
        .confidence-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .confidence-high {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .confidence-medium {
            background: #fef5e7;
            color: #f39c12;
        }
        
        .confidence-low {
            background: #fadbd8;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">データを分析しています...</div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>相続税調査分析システム v3</h1>
            <p>高精度な資金移動検出と家族関係分析により、相続税調査に必要な網羅的分析を実施します</p>
        </div>
        
        <div class="upload-section">
            <h2 class="section-title">📁 データファイルアップロード</h2>
            
            <div class="file-grid">
                <div class="file-input-group" id="group1">
                    <label class="file-label">📊 元データ（取引データ）</label>
                    <p class="file-description">
                        A列:銀行名 B列:支店名 C列:氏名 D列:科目<br>
                        E列:口座番号 F列:日付 G列:時刻 H列:出金<br>
                        I列:入金 J列:取扱店 K列:機番 L列:摘要 M列:残高
                    </p>
                    <input type="file" class="file-input" id="transactionFile" accept=".csv">
                    <div class="file-status" id="status1"></div>
                </div>
                
                <div class="file-input-group" id="group2">
                    <label class="file-label">👨‍👩‍👧‍👦 家族構成</label>
                    <p class="file-description">
                        A列:氏名 B列:続柄 C列:生年月日<br>
                        D列:相続開始日（被相続人は日付、他は年齢）
                    </p>
                    <input type="file" class="file-input" id="familyFile" accept=".csv">
                    <div class="file-status" id="status2"></div>
                </div>
                
                <div class="file-input-group" id="group3">
                    <label class="file-label">🏠 住所履歴</label>
                    <p class="file-description">
                        A列:氏名 B列:住所<br>
                        C列:居住開始日 D列:居住終了日
                    </p>
                    <input type="file" class="file-input" id="addressFile" accept=".csv">
                    <div class="file-status" id="status3"></div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <p id="progressText" style="color: #7f8c8d; font-weight: 600;">0/3 ファイルがアップロードされました</p>
            
            <div class="config-section">
                <h3 class="section-title" style="font-size: 1.3em;">⚙️ 分析設定</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <label>
                            <span>📅</span> 分析基準年
                        </label>
                        <select id="baseYear">
                            <option value="2024" selected>2024年</option>
                            <option value="2023">2023年</option>
                            <option value="2022">2022年</option>
                            <option value="2021">2021年</option>
                            <option value="2020">2020年</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>
                            <span>💰</span> 大額取引基準額
                        </label>
                        <input type="number" id="largeAmountThreshold" value="1000000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>❓</span> 原資不明基準額
                        </label>
                        <input type="number" id="unknownSourceThreshold" value="500000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>🔄</span> 資金移動検出日数
                        </label>
                        <input type="number" id="transferDays" value="7" min="1" max="30">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>📊</span> 資金移動誤差率(%)
                        </label>
                        <input type="number" id="transferErrorRate" value="10" min="0" max="50">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>⚠️</span> 相続前後期間(日)
                        </label>
                        <input type="number" id="inheritancePeriod" value="90" min="30" max="365">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>
                        📊 分析開始
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        🗑️ データクリア
                    </button>
                    <button class="btn btn-success hidden" id="exportBtn" onclick="exportResults()">
                        💾 結果エクスポート
                    </button>
                    <button class="btn btn-warning hidden" id="exportAnnotatedBtn" onclick="exportAnnotatedData()">
                        📝 注記付き元データ
                    </button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <div class="analysis-container" id="analysisContainer">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('summary')">📋 総括</button>
                <button class="tab" onclick="showTab('balance')">💰 残高推移表</button>
                <button class="tab" onclick="showTab('transfers')">💸 資金移動分析</button>
                <button class="tab" onclick="showTab('unknown')">❓ 原資不明取引</button>
                <button class="tab" onclick="showTab('addresses')">🏠 住所移転状況</button>
                <button class="tab" onclick="showTab('annotated')">📝 注記付き明細</button>
                <button class="tab" onclick="showTab('family')">👨‍👩‍👧‍👦 相続関係図</button>
            </div>
            
            <div id="summary-content" class="tab-content active"></div>
            <div id="balance-content" class="tab-content"></div>
            <div id="transfers-content" class="tab-content"></div>
            <div id="unknown-content" class="tab-content"></div>
            <div id="addresses-content" class="tab-content"></div>
            <div id="annotated-content" class="tab-content"></div>
            <div id="family-content" class="tab-content"></div>
        </div>
    </div>

    <script>
        // グローバル変数
        let uploadedFiles = {
            transaction: null,
            family: null,
            address: null
        };
        
        let systemData = {
            transactions: [],
            family: [],
            addresses: [],
            inheritanceDate: null,
            processedData: {
                balanceByPerson: {},
                transfers: [],
                suspiciousTransfers: [],
                unknownSources: [],
                annotations: new Map(),
                familyTree: null
            }
        };
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupFileInputs();
            updateProgress();
        });
        
        // ファイル入力設定
        function setupFileInputs() {
            document.getElementById('transactionFile').addEventListener('change', e => handleFileSelect(e, 'transaction', 1));
            document.getElementById('familyFile').addEventListener('change', e => handleFileSelect(e, 'family', 2));
            document.getElementById('addressFile').addEventListener('change', e => handleFileSelect(e, 'address', 3));
            document.getElementById('analyzeBtn').addEventListener('click', processAllFiles);
        }
        
        // ファイル選択処理
        function handleFileSelect(event, type, groupNumber) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('CSVファイルを選択してください', 'error');
                return;
            }
            
            uploadedFiles[type] = file;
            
            const group = document.getElementById(`group${groupNumber}`);
            const status = document.getElementById(`status${groupNumber}`);
            
            group.classList.add('uploaded');
            status.style.display = 'block';
            status.textContent = `✓ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            updateProgress();
        }
        
        // 進捗更新
        function updateProgress() {
            const uploadedCount = Object.values(uploadedFiles).filter(f => f !== null).length;
            const percentage = (uploadedCount / 3) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${uploadedCount}/3 ファイルがアップロードされました`;
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedCount !== 3;
            
            if (uploadedCount === 3) {
                showStatus('全ファイルの準備が完了しました', 'success');
            }
        }
        
        // ステータス表示
        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // ローディング表示
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // データクリア
        function clearAllData() {
            if (!confirm('すべてのデータをクリアしますか？')) return;
            
            uploadedFiles = { transaction: null, family: null, address: null };
            systemData = {
                transactions: [],
                family: [],
                addresses: [],
                inheritanceDate: null,
                processedData: {
                    balanceByPerson: {},
                    transfers: [],
                    suspiciousTransfers: [],
                    unknownSources: [],
                    annotations: new Map(),
                    familyTree: null
                }
            };
            
            document.querySelectorAll('.file-input').forEach(input => input.value = '');
            document.querySelectorAll('.file-input-group').forEach(group => group.classList.remove('uploaded'));
            document.querySelectorAll('.file-status').forEach(status => status.style.display = 'none');
            
            document.getElementById('analysisContainer').style.display = 'none';
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('exportAnnotatedBtn').classList.add('hidden');
            
            updateProgress();
            showStatus('全データをクリアしました', 'info');
        }
        
        // 改良版CSVパーサー
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            let inQuotes = false;
            let currentLine = [];
            let currentValue = '';
            
            for (let line of lines) {
                if (!line.trim() && !inQuotes) continue;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        currentLine.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                if (!inQuotes) {
                    currentLine.push(currentValue.trim());
                    if (currentLine.length > 0 && currentLine.some(v => v)) {
                        result.push(currentLine);
                    }
                    currentLine = [];
                    currentValue = '';
                } else {
                    currentValue += '\n';
                }
            }
            
            return result;
        }
        
        // ファイル読み込み
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // 全ファイル処理
        async function processAllFiles() {
            try {
                showLoading(true);
                showStatus('データを分析しています...', 'info');
                
                // 取引データ処理
                const transactionText = await readFile(uploadedFiles.transaction);
                const transactionData = parseCSV(transactionText);
                systemData.transactions = parseTransactionData(transactionData);
                
                // 家族構成処理
                const familyText = await readFile(uploadedFiles.family);
                const familyData = parseCSV(familyText);
                systemData.family = parseFamilyData(familyData);
                
                // 住所履歴処理
                const addressText = await readFile(uploadedFiles.address);
                const addressData = parseCSV(addressText);
                systemData.addresses = parseAddressData(addressData);
                
                // データ分析実行
                await analyzeData();
                
                // 結果表示
                document.getElementById('analysisContainer').style.display = 'block';
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('exportAnnotatedBtn').classList.remove('hidden');
                
                updateAllViews();
                showStatus('分析が完了しました', 'success');
                
                // 分析結果へスクロール
                document.getElementById('analysisContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showStatus('エラーが発生しました: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }
        
        // 取引データ解析
        function parseTransactionData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const transactions = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 13) {
                    transactions.push({
                        id: i,
                        bank: row[0] || '',
                        branch: row[1] || '',
                        name: row[2] || '',
                        accountType: row[3] || '',
                        accountNumber: row[4] || '',
                        date: row[5] || '',
                        time: row[6] || '',
                        withdrawal: parseFloat(row[7]) || 0,
                        deposit: parseFloat(row[8]) || 0,
                        location: row[9] || '',
                        machineId: row[10] || '',
                        description: row[11] || '',
                        balance: parseFloat(row[12]) || 0,
                        flags: [],
                        annotations: [],
                        confidence: 'high' // 信頼度追加
                    });
                }
            }
            
            return transactions.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare !== 0) return dateCompare;
                return (a.time || '00:00:00').localeCompare(b.time || '00:00:00');
            });
        }
        
        // 家族データ解析（改良版）
        function parseFamilyData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const family = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 4) {
                    const member = {
                        name: row[0] || '',
                        relationship: row[1] || '',
                        birthDate: row[2] || '',
                        inheritanceInfo: row[3] || '',
                        parent: null,
                        children: [],
                        spouse: null
                    };
                    
                    // 被相続人の判定と相続開始日の取得
                    if (member.relationship.includes('被相続人')) {
                        member.isDeceased = true;
                        if (member.inheritanceInfo && member.inheritanceInfo.match(/\d{4}-\d{2}-\d{2}/)) {
                            systemData.inheritanceDate = member.inheritanceInfo;
                        }
                    } else {
                        const ageMatch = member.inheritanceInfo.match(/(\d+)歳?/);
                        if (ageMatch) {
                            member.ageAtInheritance = parseInt(ageMatch[1]);
                        }
                    }
                    
                    // 性別推定
                    const rel = member.relationship;
                    if (rel.includes('夫') || rel.includes('父') || rel.includes('男') || 
                        rel.includes('息子') || rel.includes('長男') || rel.includes('次男') || rel.includes('三男')) {
                        member.gender = 'male';
                    } else if (rel.includes('妻') || rel.includes('母') || rel.includes('女') || 
                               rel.includes('娘') || rel.includes('長女') || rel.includes('次女') || rel.includes('三女')) {
                        member.gender = 'female';
                    } else {
                        member.gender = 'unknown';
                    }
                    
                    // 世代判定
                    if (member.isDeceased || rel.includes('配偶者')) {
                        member.generation = 0;
                    } else if (rel.includes('長男') || rel.includes('次男') || rel.includes('三男') ||
                               rel.includes('長女') || rel.includes('次女') || rel.includes('三女') ||
                               (rel.includes('子') && !rel.includes('孫'))) {
                        member.generation = 1;
                    } else if (rel.includes('孫')) {
                        member.generation = 2;
                        const parentMatch = rel.match(/(.+)の子/);
                        if (parentMatch) {
                            member.parentRelation = parentMatch[1];
                        }
                    } else {
                        member.generation = 3;
                    }
                    
                    family.push(member);
                }
            }
            
            buildFamilyRelations(family);
            return family;
        }
        
        // 家族関係構築
        function buildFamilyRelations(family) {
            const deceased = family.find(f => f.isDeceased);
            if (!deceased) return;
            
            const spouse = family.find(f => f.relationship.includes('配偶者'));
            if (spouse) {
                deceased.spouse = spouse.name;
                spouse.spouse = deceased.name;
            }
            
            family.forEach(member => {
                if (member.generation === 1) {
                    member.parent = deceased.name;
                    if (!deceased.children) deceased.children = [];
                    deceased.children.push(member.name);
                    
                    if (spouse) {
                        if (!spouse.children) spouse.children = [];
                        spouse.children.push(member.name);
                    }
                } else if (member.generation === 2 && member.parentRelation) {
                    const parent = family.find(f => f.relationship.includes(member.parentRelation));
                    if (parent) {
                        member.parent = parent.name;
                        if (!parent.children) parent.children = [];
                        parent.children.push(member.name);
                    }
                }
            });
        }
        
        // 住所データ解析
        function parseAddressData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const addresses = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 3) {
                    addresses.push({
                        name: row[0] || '',
                        address: row[1] || '',
                        startDate: row[2] || '',
                        endDate: row[3] || ''
                    });
                }
            }
            
            const peopleNames = [...new Set(addresses.map(a => a.name))];
            peopleNames.forEach(name => {
                const personAddresses = addresses
                    .filter(a => a.name === name)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                for (let i = 0; i < personAddresses.length - 1; i++) {
                    if (!personAddresses[i].endDate) {
                        const nextStartDate = new Date(personAddresses[i + 1].startDate);
                        nextStartDate.setDate(nextStartDate.getDate() - 1);
                        personAddresses[i].endDate = nextStartDate.toISOString().split('T')[0];
                    }
                }
            });
            
            return addresses;
        }
        
        // データ分析
        async function analyzeData() {
            const inheritanceDate = systemData.inheritanceDate;
            const largeAmountThreshold = parseInt(document.getElementById('largeAmountThreshold').value);
            const unknownSourceThreshold = parseInt(document.getElementById('unknownSourceThreshold').value);
            const transferDays = parseInt(document.getElementById('transferDays').value);
            const transferErrorRate = parseInt(document.getElementById('transferErrorRate').value) / 100;
            const inheritancePeriod = parseInt(document.getElementById('inheritancePeriod').value);
            
            addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod);
            analyzeBalanceHistory();
            detectMoneyTransfersAdvanced(transferDays, transferErrorRate);
            detectUnknownSources(unknownSourceThreshold);
            generateAnnotations();
        }
        
        // 取引フラグ付け（改良版）
        function addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod) {
            const inhDate = new Date(inheritanceDate);
            const deceased = systemData.family.find(f => f.isDeceased);
            
            systemData.transactions.forEach(tx => {
                tx.flags = [];
                tx.annotations = [];
                const amount = Math.max(tx.withdrawal, tx.deposit);
                const txDate = new Date(tx.date);
                
                const hasTransaction = tx.withdrawal > 0 || tx.deposit > 0;
                
                // 大額取引
                if (hasTransaction && amount >= largeAmountThreshold) {
                    tx.flags.push('大額取引');
                    tx.annotations.push(`★大額取引(${amount.toLocaleString()}円)`);
                    tx.confidence = 'high';
                }
                
                // 摘要空白チェック
                if (hasTransaction && (!tx.description || tx.description.trim() === '')) {
                    tx.flags.push('摘要空白');
                    tx.annotations.push('★摘要欄空白(窓口取引の可能性)');
                    tx.confidence = 'medium';
                }
                
                // 原資不明
                if (tx.deposit >= unknownSourceThreshold) {
                    if (!tx.description || 
                        tx.description.trim() === '' || 
                        tx.description === '入金' || 
                        tx.description.includes('現金') ||
                        tx.description.includes('ATM')) {
                        
                        tx.flags.push('原資不明');
                        tx.annotations.push(`★原資不明入金(${tx.deposit.toLocaleString()}円)`);
                        tx.confidence = tx.description ? 'medium' : 'high';
                        
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('★住所移動後30日以内の入金');
                            tx.confidence = 'high';
                        }
                    }
                }
                
                // 相続前後期間
                const daysDiff = Math.abs(txDate - inhDate) / (1000 * 60 * 60 * 24);
                if (hasTransaction && daysDiff <= inheritancePeriod) {
                    tx.flags.push('相続前後');
                    if (amount >= 100000) {
                        tx.annotations.push(`★相続前後${Math.round(daysDiff)}日の取引`);
                    }
                }
                
                // 口座開設・解約
                if (tx.description && (tx.description.includes('開設') || tx.description.includes('新規'))) {
                    tx.flags.push('口座開設');
                    tx.annotations.push('★口座開設');
                }
                if (tx.description && (tx.description.includes('解約') || tx.description.includes('閉鎖'))) {
                    tx.flags.push('口座解約');
                    tx.annotations.push('★口座解約');
                }
                
                // 未成年判定
                const person = systemData.family.find(f => f.name === tx.name);
                if (person && person.birthDate) {
                    const age = calculateAge(person.birthDate, tx.date);
                    if (age < 20) {
                        tx.flags.push('未成年');
                        tx.annotations.push(`★未成年取引(${age}歳)`);
                        
                        if (tx.flags.includes('口座開設')) {
                            const cohabitants = getCohabitantsAtDate(tx.name, tx.date);
                            if (cohabitants.length > 0) {
                                tx.annotations.push(`★推定管理者: ${cohabitants.join(', ')}`);
                            }
                        }
                    }
                }
                
                // 被相続人同居判定
                if (deceased && tx.name !== deceased.name && isSameAddressAsDeceased(tx.name, tx.date)) {
                    tx.flags.push('被相続人同居');
                    tx.annotations.push('★被相続人と同居');
                }
            });
        }
        
        // 年齢計算
        function calculateAge(birthDate, targetDate) {
            const birth = new Date(birthDate);
            const target = new Date(targetDate);
            let age = target.getFullYear() - birth.getFullYear();
            const monthDiff = target.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && target.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        // 最近の住所変更チェック
        function checkRecentAddressChange(name, date, days) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const startDate = new Date(addr.startDate);
                const daysDiff = (targetDate - startDate) / (1000 * 60 * 60 * 24);
                if (daysDiff >= 0 && daysDiff <= days) {
                    return true;
                }
            }
            return false;
        }
        
        // 特定日の同居人取得
        function getCohabitantsAtDate(name, date) {
            const address = getAddressAtDate(name, date);
            if (!address) return [];
            
            const cohabitants = [];
            systemData.family.forEach(person => {
                if (person.name !== name) {
                    const personAddr = getAddressAtDate(person.name, date);
                    if (personAddr === address) {
                        cohabitants.push(person.name);
                    }
                }
            });
            
            return cohabitants;
        }
        
        // 被相続人同居判定
        function isSameAddressAsDeceased(personName, date) {
            const deceased = systemData.family.find(f => f.isDeceased);
            if (!deceased) return false;
            
            const deceasedAddr = getAddressAtDate(deceased.name, date);
            const personAddr = getAddressAtDate(personName, date);
            
            return deceasedAddr && personAddr && deceasedAddr === personAddr;
        }
        
        // 特定日の住所取得
        function getAddressAtDate(name, date) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const start = new Date(addr.startDate);
                const end = addr.endDate ? new Date(addr.endDate) : new Date('9999-12-31');
                
                if (targetDate >= start && targetDate <= end) {
                    return addr.address;
                }
            }
            
            return null;
        }
        
        // 残高推移分析（補完機能付き）
        function analyzeBalanceHistory() {
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            systemData.processedData.balanceByPerson = {};
            
            systemData.family.forEach(person => {
                const personData = {
                    name: person.name,
                    accounts: {},
                    yearlyTotal: {},
                    inheritanceTotal: 0
                };
                
                const personTx = systemData.transactions.filter(tx => tx.name === person.name);
                
                personTx.forEach(tx => {
                    const accountKey = `${tx.bank}_${tx.branch}_${tx.accountNumber}`;
                    if (!personData.accounts[accountKey]) {
                        personData.accounts[accountKey] = {
                            bank: tx.bank,
                            branch: tx.branch,
                            accountNumber: tx.accountNumber,
                            accountType: tx.accountType,
                            transactions: [],
                            yearlyBalance: {},
                            inheritanceBalance: 0,
                            openDate: null,
                            closeDate: null
                        };
                    }
                    personData.accounts[accountKey].transactions.push(tx);
                    
                    if (tx.flags.includes('口座開設')) {
                        personData.accounts[accountKey].openDate = tx.date;
                    }
                    if (tx.flags.includes('口座解約')) {
                        personData.accounts[accountKey].closeDate = tx.date;
                    }
                });
                
                Object.values(personData.accounts).forEach(account => {
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const yearEnd = `${year}-12-31`;
                        const balance = getBalanceAtDate(account.transactions, yearEnd, true);
                        account.yearlyBalance[year] = balance;
                        
                        if (!personData.yearlyTotal[year]) {
                            personData.yearlyTotal[year] = 0;
                        }
                        if (balance.value !== null) {
                            personData.yearlyTotal[year] += balance.value;
                        }
                    }
                    
                    const inhBalance = getBalanceAtDate(account.transactions, inheritanceDate, true);
                    account.inheritanceBalance = inhBalance;
                    if (inhBalance.value !== null) {
                        personData.inheritanceTotal += inhBalance.value;
                    }
                });
                
                systemData.processedData.balanceByPerson[person.name] = personData;
            });
        }
        
        // 特定日の残高取得（補完機能付き）
        function getBalanceAtDate(transactions, targetDate, withInterpolation = false) {
            const target = new Date(targetDate);
            let result = { value: null, isInterpolated: false };
            
            const balanceTx = transactions.filter(tx => tx.balance > 0);
            if (balanceTx.length === 0) return result;
            
            let closestBefore = null;
            let closestBeforeDate = null;
            let closestAfter = null;
            let closestAfterDate = null;
            
            balanceTx.forEach(tx => {
                const txDate = new Date(tx.date);
                
                if (txDate <= target) {
                    if (!closestBeforeDate || txDate > closestBeforeDate) {
                        closestBeforeDate = txDate;
                        closestBefore = tx;
                    }
                } else {
                    if (!closestAfterDate || txDate < closestAfterDate) {
                        closestAfterDate = txDate;
                        closestAfter = tx;
                    }
                }
            });
            
            if (closestBefore) {
                result.value = closestBefore.balance;
                
                if (withInterpolation && targetDate.endsWith('-12-31')) {
                    const yearEnd = new Date(targetDate);
                    const daysDiff = (yearEnd - closestBeforeDate) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 30) {
                        result.isInterpolated = true;
                    }
                }
                
                return result;
            }
            
            const firstTx = transactions[0];
            if (firstTx && new Date(firstTx.date) > target) {
                result.value = 0;
                return result;
            }
            
            if (closestAfter && withInterpolation) {
                result.value = closestAfter.balance;
                result.isInterpolated = true;
                return result;
            }
            
            return result;
        }
        
        // 高精度資金移動検出（多対多マッチング対応）
        function detectMoneyTransfersAdvanced(maxDays, errorRate) {
            systemData.processedData.transfers = [];
            systemData.processedData.suspiciousTransfers = [];
            
            const withdrawals = systemData.transactions.filter(tx => tx.withdrawal > 0);
            const deposits = systemData.transactions.filter(tx => tx.deposit > 0);
            
            const usedDeposits = new Set();
            const allMatches = [];
            
            withdrawals.forEach(withdrawal => {
                const wDate = new Date(withdrawal.date);
                const wAmount = withdrawal.withdrawal;
                
                deposits.forEach(deposit => {
                    if (usedDeposits.has(deposit.id)) return;
                    
                    const dDate = new Date(deposit.date);
                    const daysDiff = (dDate - wDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff < 0 || daysDiff > maxDays) return;
                    
                    const amountDiff = Math.abs(deposit.deposit - wAmount);
                    const amountDiffRate = amountDiff / wAmount;
                    
                    if (amountDiffRate > errorRate) return;
                    
                    let score = 0;
                    score += daysDiff * 5;
                    score += amountDiffRate * 100;
                    
                    if (withdrawal.name === deposit.name) {
                        score += 50;
                    }
                    
                    const isFamily = checkFamilyRelation(withdrawal.name, deposit.name);
                    if (isFamily) {
                        score -= 20;
                    }
                    
                    if (daysDiff === 0 && withdrawal.time && deposit.time) {
                        const wTime = parseTime(withdrawal.time);
                        const dTime = parseTime(deposit.time);
                        
                        if (dTime < wTime) {
                            score += 100;
                        } else {
                            const timeDiff = dTime - wTime;
                            if (timeDiff < 60) {
                                score -= 10;
                            }
                        }
                    }
                    
                    allMatches.push({
                        withdrawal: withdrawal,
                        deposit: deposit,
                        score: score,
                        daysDiff: daysDiff,
                        amountDiff: amountDiff,
                        amountDiffRate: amountDiffRate,
                        isFamily: isFamily
                    });
                });
            });
            
            allMatches.sort((a, b) => a.score - b.score);
            
            const usedWithdrawals = new Set();
            
            allMatches.forEach(match => {
                if (usedWithdrawals.has(match.withdrawal.id) || usedDeposits.has(match.deposit.id)) {
                    return;
                }
                
                if (match.score < 100) {
                    usedWithdrawals.add(match.withdrawal.id);
                    usedDeposits.add(match.deposit.id);
                    
                    const transfer = {
                        date: match.withdrawal.date,
                        from: match.withdrawal.name,
                        to: match.deposit.name,
                        amount: match.withdrawal.withdrawal,
                        fromBank: `${match.withdrawal.bank} ${match.withdrawal.branch}`,
                        toBank: `${match.deposit.bank} ${match.deposit.branch}`,
                        fromAccount: match.withdrawal.accountNumber,
                        toAccount: match.deposit.accountNumber,
                        depositDate: match.deposit.date,
                        daysDiff: match.daysDiff,
                        amountDiff: match.amountDiff,
                        amountDiffRate: match.amountDiffRate,
                        isFamily: match.isFamily,
                        score: match.score,
                        confidence: match.score < 50 ? 'high' : match.score < 80 ? 'medium' : 'low'
                    };
                    
                    systemData.processedData.transfers.push(transfer);
                    
                    match.withdrawal.flags.push('資金移動(出)');
                    match.deposit.flags.push('資金移動(入)');
                    
                    const annotation = `★資金移動: ${match.withdrawal.name}→${match.deposit.name} (${match.daysDiff}日後, 誤差${(match.amountDiffRate * 100).toFixed(1)}%)`;
                    match.withdrawal.annotations.push(annotation);
                    match.deposit.annotations.push(annotation);
                    
                    if (match.isFamily && match.daysDiff <= 1 && match.amountDiffRate < 0.01) {
                        systemData.processedData.suspiciousTransfers.push(transfer);
                        match.withdrawal.annotations.push('★要注意：家族間即日資金移動');
                        match.deposit.annotations.push('★要注意：家族間即日資金移動');
                    }
                }
            });
        }
        
        // 時刻パース
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1] || 0);
        }
        
        // 家族関係チェック
        function checkFamilyRelation(name1, name2) {
            const person1 = systemData.family.find(f => f.name === name1);
            const person2 = systemData.family.find(f => f.name === name2);
            
            if (!person1 || !person2) return false;
            
            if (person1.spouse === name2 || person2.spouse === name1) {
                return true;
            }
            
            if (person1.children && person1.children.includes(name2)) {
                return true;
            }
            if (person2.children && person2.children.includes(name1)) {
                return true;
            }
            
            if (person1.parent && person1.parent === person2.parent) {
                return true;
            }
            
            return false;
        }
        
        // 原資不明取引検出
        function detectUnknownSources(threshold) {
            systemData.processedData.unknownSources = [];
            
            systemData.transactions.forEach(tx => {
                if (tx.deposit >= threshold) {
                    let isUnknown = false;
                    let reason = '';
                    let confidence = 'low';
                    
                    const hasTransaction = tx.withdrawal > 0 || tx.deposit > 0;
                    
                    if (hasTransaction) {
                        if (!tx.description || tx.description.trim() === '') {
                            isUnknown = true;
                            reason = '摘要欄空白（窓口取引）';
                            confidence = 'high';
                        }
                        else if (tx.description === '入金' || 
                                 tx.description === '現金' || 
                                 tx.description === '現金入金' ||
                                 tx.description.includes('ATM')) {
                            isUnknown = true;
                            reason = `入金種別: ${tx.description}`;
                            confidence = 'medium';
                        }
                    }
                    
                    if (isUnknown) {
                        systemData.processedData.unknownSources.push({
                            ...tx,
                            reason: reason,
                            confidence: confidence
                        });
                        
                        if (!tx.flags.includes('原資不明')) {
                            tx.flags.push('原資不明');
                        }
                        
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('★住所移動直後の原資不明入金（要確認）');
                        }
                        
                        if (tx.flags.includes('未成年')) {
                            tx.annotations.push('★未成年口座への原資不明入金（贈与の可能性）');
                        }
                    }
                }
            });
        }
        
        // 注記情報の生成
        function generateAnnotations() {
            systemData.processedData.annotations.clear();
            
            systemData.transactions.forEach(tx => {
                if (tx.annotations.length > 0) {
                    const key = `${tx.id}`;
                    systemData.processedData.annotations.set(key, tx.annotations.join(' / '));
                }
            });
        }
        
        // ビュー更新
        function updateAllViews() {
            updateSummaryView();
            updateBalanceView();
            updateTransfersView();
            updateUnknownView();
            updateAddressView();
            updateAnnotatedView();
            updateFamilyView();
        }
        
        // 総括ビュー
        function updateSummaryView() {
            const container = document.getElementById('summary-content');
            const inheritanceDate = systemData.inheritanceDate;
            
            const totalTx = systemData.transactions.length;
            const flaggedTx = systemData.transactions.filter(tx => tx.flags.length > 0).length;
            const transfers = systemData.processedData.transfers.length;
            const suspiciousTransfers = systemData.processedData.suspiciousTransfers.length;
            const unknownSources = systemData.processedData.unknownSources.length;
            const blankMemo = systemData.transactions.filter(tx => tx.flags.includes('摘要空白')).length;
            
            let html = `
                <div class="info-card">
                    <h3>📊 調査結果サマリー</h3>
                    <p><strong>相続開始日：</strong>${inheritanceDate}</p>
                    <p><strong>分析対象期間：</strong>${systemData.transactions[0]?.date || 'N/A'} ～ ${systemData.transactions[systemData.transactions.length-1]?.date || 'N/A'}</p>
                    <p><strong>対象人数：</strong>${systemData.family.length}名</p>
                </div>
                
                <div class="alert-card ${flaggedTx > totalTx * 0.1 ? 'danger' : 'warning'}">
                    <h4>🔍 検出結果</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>総取引件数：<strong>${totalTx}</strong>件</li>
                        <li>要注意取引：<strong>${flaggedTx}</strong>件（${(flaggedTx/totalTx*100).toFixed(1)}%）</li>
                        <li>資金移動検出：<strong>${transfers}</strong>件${suspiciousTransfers > 0 ? ` <span style="color: #e74c3c;">（うち要注意 ${suspiciousTransfers}件）</span>` : ''}</li>
                        <li>原資不明取引：<strong>${unknownSources}</strong>件</li>
                        <li>摘要空白取引：<strong>${blankMemo}</strong>件 <span style="color: #f39c12;">（窓口取引の可能性）</span></li>
                    </ul>
                </div>
                
                <div class="criteria-explanation">
                    <h4>🏷️ 判定基準の説明</h4>
                    <div class="criteria-categories">
                        <div class="criteria-category">
                            <h5>💰 金額関連</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-large-amount criteria-badge">大額取引</span>
                                    <span>設定金額以上の入出金（贈与・資産隠し）</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-unknown-source criteria-badge">原資不明</span>
                                    <span>入金元が特定できない取引（名義預金等）</span>
                                </div>
                            </div>
                        </div>
                        <div class="criteria-category">
                            <h5>💸 資金移動</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-money-shift criteria-badge">資金移動</span>
                                    <span>人物間の資金シフト（贈与の可能性）</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-inheritance-period criteria-badge">相続前後</span>
                                    <span>相続開始日前後の取引（財産移動）</span>
                                </div>
                            </div>
                        </div>
                        <div class="criteria-category">
                            <h5>👤 人物関連</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-minor criteria-badge">未成年</span>
                                    <span>20歳未満の者による取引（管理者確認）</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-cohabit criteria-badge">被相続人同居</span>
                                    <span>被相続人と同住所（小規模宅地特例）</span>
                                </div>
                            </div>
                        </div>
                        <div class="criteria-category">
                            <h5>📝 その他</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-blank-memo criteria-badge">摘要空白</span>
                                    <span>摘要欄が空白（窓口取引・現金移動）</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-account-open criteria-badge">口座開設</span>
                                    <span>新規口座開設（資産分散の可能性）</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 各人の残高サマリー
            html += `
                <div class="info-card">
                    <h3>💰 各人の残高状況</h3>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>氏名</th>
                                    <th>続柄</th>
                                    <th>相続時残高</th>
                                    <th>口座数</th>
                                    <th>要注意取引</th>
                                    <th>原資不明</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            systemData.family.forEach(person => {
                const balanceData = systemData.processedData.balanceByPerson[person.name];
                const flaggedCount = systemData.transactions.filter(tx => 
                    tx.name === person.name && tx.flags.length > 0
                ).length;
                const unknownCount = systemData.processedData.unknownSources.filter(tx => 
                    tx.name === person.name
                ).length;
                
                const rowClass = person.isDeceased ? 'highlight-row' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="font-bold">${person.name}</td>
                        <td>${person.relationship}</td>
                        <td class="text-right">${balanceData ? balanceData.inheritanceTotal.toLocaleString() : 0}円</td>
                        <td class="text-center">${balanceData ? Object.keys(balanceData.accounts).length : 0}</td>
                        <td class="text-center">${flaggedCount > 0 ? `<span class="annotation-badge badge-large-amount">${flaggedCount}</span>` : '0'}</td>
                        <td class="text-center">${unknownCount > 0 ? `<span class="annotation-badge badge-unknown-source">${unknownCount}</span>` : '0'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            
            // 重要な注意事項
            if (suspiciousTransfers > 0 || blankMemo > 10) {
                html += `
                    <div class="alert-card danger">
                        <h4>⚠️ 重要な確認事項</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                `;
                
                if (suspiciousTransfers > 0) {
                    html += '<li>家族間での即日資金移動が検出されました。贈与の可能性があるため、契約書等の確認が必要です。</li>';
                }
                
                if (blankMemo > 10) {
                    html += '<li>摘要欄が空白の取引が多数検出されました。銀行窓口での取引記録を確認してください。</li>';
                }
                
                html += '</ul></div>';
            }
            
            container.innerHTML = html;
        }
        
        // 残高推移表ビュー
        function updateBalanceView() {
            const container = document.getElementById('balance-content');
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            let html = '<h3 style="margin: 20px 0;">💰 各人別残高推移表</h3>';
            html += '<p style="color: #9b59b6; font-style: italic; margin-bottom: 20px;">※ 斜体の数値は年内最終取引日の残高を表示（補完値）</p>';
            
            Object.entries(systemData.processedData.balanceByPerson).forEach(([name, personData]) => {
                const person = systemData.family.find(f => f.name === name);
                const cardClass = person && person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${name} の残高推移</h4>
                        <div class="balance-table-wrapper">
                            <table class="balance-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 240px;">口座情報</th>
                `;
                
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    html += `<th style="min-width: 150px;">${year}年末</th>`;
                }
                html += `<th class="inheritance-date" style="min-width: 170px;">相続開始日<br>(${inheritanceDate})</th>`;
                html += '</tr></thead><tbody>';
                
                Object.values(personData.accounts).forEach(account => {
                    html += '<tr>';
                    html += `<td class="account-row">
                        ${account.bank} ${account.branch}<br>
                        ${account.accountType} ${account.accountNumber}
                        ${account.openDate ? `<br><small>開設: ${account.openDate}</small>` : ''}
                        ${account.closeDate ? `<br><small>解約: ${account.closeDate}</small>` : ''}
                    </td>`;
                    
                    let prevBalance = 0;
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const balanceData = account.yearlyBalance[year] || { value: null, isInterpolated: false };
                        
                        if (balanceData.value !== null) {
                            const change = balanceData.value - prevBalance;
                            const changeClass = change > 0 ? 'balance-positive' : change < 0 ? 'balance-negative' : '';
                            const interpolatedClass = balanceData.isInterpolated ? 'balance-interpolated' : '';
                            
                            html += `<td class="${interpolatedClass}">
                                ${balanceData.value.toLocaleString()}
                                ${prevBalance > 0 && !balanceData.isInterpolated ? 
                                    `<span class="balance-change ${changeClass}">(${change > 0 ? '+' : ''}${change.toLocaleString()})</span>` 
                                    : ''}
                            </td>`;
                            prevBalance = balanceData.value;
                        } else {
                            html += '<td>-</td>';
                        }
                    }
                    
                    const inhBalance = account.inheritanceBalance;
                    if (inhBalance.value !== null) {
                        html += `<td class="inheritance-date ${inhBalance.isInterpolated ? 'balance-interpolated' : ''}">
                            ${inhBalance.value.toLocaleString()}
                        </td>`;
                    } else {
                        html += '<td class="inheritance-date">-</td>';
                    }
                    
                    html += '</tr>';
                });
                
                html += '<tr class="total-row">';
                html += '<td>合計</td>';
                
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    const total = personData.yearlyTotal[year] || 0;
                    html += `<td>${total.toLocaleString()}</td>`;
                }
                html += `<td class="inheritance-date">${personData.inheritanceTotal.toLocaleString()}</td>`;
                html += '</tr></tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // 資金移動ビュー
        function updateTransfersView() {
            const container = document.getElementById('transfers-content');
            const transfers = systemData.processedData.transfers;
            const suspicious = systemData.processedData.suspiciousTransfers;
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="alert-card info"><h3>資金移動は検出されませんでした</h3></div>';
                return;
            }
            
            let html = `
                <div class="alert-card ${suspicious.length > 0 ? 'danger' : 'warning'}">
                    <h3>💸 資金移動分析結果（${transfers.length}件）</h3>
                    <p>設定期間内（${document.getElementById('transferDays').value}日以内）で金額誤差${document.getElementById('transferErrorRate').value}%以内の入出金を検出しました。</p>
                    ${suspicious.length > 0 ? `<p style="color: #e74c3c; font-weight: 700;">★ 特に注意が必要な資金移動が${suspicious.length}件検出されました。</p>` : ''}
                </div>
            `;
            
            if (suspicious.length > 0) {
                html += `
                    <div class="info-card danger-highlight">
                        <h4>⚠️ 要注意資金移動</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>出金日</th>
                                        <th>送金者</th>
                                        <th>受取人</th>
                                        <th>関係</th>
                                        <th>金額</th>
                                        <th>入金日</th>
                                        <th>日数</th>
                                        <th>誤差</th>
                                        <th>信頼度</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                suspicious.forEach(transfer => {
                    html += `
                        <tr class="danger-highlight">
                            <td>${transfer.date}</td>
                            <td>${transfer.from}</td>
                            <td>${transfer.to}</td>
                            <td>${transfer.isFamily ? '<span class="annotation-badge badge-cohabit">家族</span>' : '-'}</td>
                            <td class="text-right">${transfer.amount.toLocaleString()}円</td>
                            <td>${transfer.depositDate}</td>
                            <td class="text-center">${transfer.daysDiff}日</td>
                            <td class="text-center">${(transfer.amountDiffRate * 100).toFixed(1)}%</td>
                            <td><span class="confidence-indicator confidence-${transfer.confidence}">${transfer.confidence}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            html += `
                <div class="info-card">
                    <h4>全資金移動一覧</h4>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>出金日</th>
                                    <th>送金者</th>
                                    <th>送金元</th>
                                    <th>受取人</th>
                                    <th>受取先</th>
                                    <th>金額</th>
                                    <th>入金日</th>
                                    <th>誤差</th>
                                    <th>信頼度</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            transfers.forEach(transfer => {
                const isSuspicious = suspicious.some(s => 
                    s.date === transfer.date && 
                    s.from === transfer.from && 
                    s.to === transfer.to
                );
                
                html += `
                    <tr ${isSuspicious ? 'class="highlight-row"' : ''}>
                        <td>${transfer.date}</td>
                        <td>${transfer.from}</td>
                        <td>${transfer.fromBank}</td>
                        <td>${transfer.to}</td>
                        <td>${transfer.toBank}</td>
                        <td class="text-right">${transfer.amount.toLocaleString()}円</td>
                        <td>${transfer.depositDate}</td>
                        <td class="text-right">${transfer.amountDiff.toLocaleString()}円</td>
                        <td><span class="confidence-indicator confidence-${transfer.confidence}">${transfer.confidence}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // 原資不明ビュー
        function updateUnknownView() {
            const container = document.getElementById('unknown-content');
            const unknownSources = systemData.processedData.unknownSources;
            
            if (unknownSources.length === 0) {
                container.innerHTML = '<div class="alert-card success"><h3>原資不明の取引は検出されませんでした</h3></div>';
                return;
            }
            
            const byReason = {};
            unknownSources.forEach(tx => {
                if (!byReason[tx.reason]) {
                    byReason[tx.reason] = [];
                }
                byReason[tx.reason].push(tx);
            });
            
            let html = `
                <div class="alert-card danger">
                    <h3>❓ 原資不明取引（${unknownSources.length}件）</h3>
                    <p>入金元が不明または確認が必要な取引を検出しました。</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
            `;
            
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `<li>${reason}：<strong>${txs.length}</strong>件</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `
                    <div class="info-card">
                        <h4>${reason}（${txs.length}件）</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>日付</th>
                                        <th>氏名</th>
                                        <th>銀行・支店</th>
                                        <th>金額</th>
                                        <th>残高</th>
                                        <th>特記事項</th>
                                        <th>信頼度</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                txs.forEach(tx => {
                    const specialNotes = [];
                    if (tx.flags.includes('相続前後')) specialNotes.push('相続前後');
                    if (tx.flags.includes('未成年')) specialNotes.push('未成年');
                    if (tx.flags.includes('被相続人同居')) specialNotes.push('同居');
                    
                    html += `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.name}</td>
                            <td>${tx.bank} ${tx.branch}</td>
                            <td class="text-right">${tx.deposit.toLocaleString()}円</td>
                            <td class="text-right">${tx.balance.toLocaleString()}円</td>
                            <td>
                                ${specialNotes.map(note => 
                                    `<span class="annotation-badge badge-${note === '相続前後' ? 'inheritance-period' : note === '未成年' ? 'minor' : 'cohabit'}">${note}</span>`
                                ).join(' ')}
                            </td>
                            <td><span class="confidence-indicator confidence-${tx.confidence}">${tx.confidence}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // 住所履歴ビュー
        function updateAddressView() {
            const container = document.getElementById('addresses-content');
            const inheritanceDate = systemData.inheritanceDate;
            const deceased = systemData.family.find(f => f.isDeceased);
            const deceasedInhAddr = deceased ? getAddressAtDate(deceased.name, inheritanceDate) : null;
            
            let html = '<h3 style="margin: 20px 0;">🏠 住所移転状況一覧</h3>';
            
            if (deceased && deceasedInhAddr) {
                const cohabitants = [];
                systemData.family.forEach(person => {
                    if (!person.isDeceased) {
                        const addr = getAddressAtDate(person.name, inheritanceDate);
                        if (addr === deceasedInhAddr) {
                            cohabitants.push(person.name);
                        }
                    }
                });
                
                if (cohabitants.length > 0) {
                    html += `
                        <div class="alert-card warning">
                            <h4>相続開始時の同居状況</h4>
                            <p>被相続人（${deceased.name}）と同居していた相続人：<strong>${cohabitants.join('、')}</strong></p>
                            <p>住所：${deceasedInhAddr}</p>
                        </div>
                    `;
                }
            }
            
            systemData.family.forEach(person => {
                const addresses = systemData.addresses.filter(a => a.name === person.name);
                if (addresses.length === 0) return;
                
                const cardClass = person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${person.name} （${person.relationship}）</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>期間</th>
                                        <th>住所</th>
                                        <th>居住年数</th>
                                        <th>相続時</th>
                                        <th>備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                addresses.forEach(addr => {
                    const start = new Date(addr.startDate);
                    const end = addr.endDate ? new Date(addr.endDate) : new Date();
                    const years = Math.floor((end - start) / (365.25 * 24 * 60 * 60 * 1000));
                    const months = Math.floor(((end - start) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
                    
                    const isCurrent = !addr.endDate;
                    const inhDate = new Date(inheritanceDate);
                    const wasLivingHereDuringInheritance = start <= inhDate && (addr.endDate ? new Date(addr.endDate) >= inhDate : true);
                    
                    const isSameAsDeceased = deceased && deceasedInhAddr === addr.address && wasLivingHereDuringInheritance;
                    
                    html += `
                        <tr ${wasLivingHereDuringInheritance ? 'class="highlight-row"' : ''}>
                            <td>${addr.startDate} ～ ${addr.endDate || '現在'}</td>
                            <td>${addr.address}</td>
                            <td>${years}年${months > 0 ? `${months}ヶ月` : ''}</td>
                            <td>${wasLivingHereDuringInheritance ? '○' : '-'}</td>
                            <td>
                                ${isCurrent ? '<span class="annotation-badge badge-account-open">現住所</span>' : ''}
                                ${isSameAsDeceased ? '<span class="annotation-badge badge-cohabit">被相続人同居</span>' : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // 注記付き明細ビュー
        function updateAnnotatedView() {
            const container = document.getElementById('annotated-content');
            
            let html = `
                <h3 style="margin: 20px 0;">📝 注記付き取引明細</h3>
                <div class="alert-card info">
                    <p>★マークが付いた項目は相続税調査において特に注意が必要な取引です。</p>
                    <p>この一覧は元データに注記を追加したもので、エクスポート機能で出力できます。</p>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table" style="min-width: 1400px;">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>時刻</th>
                                <th>氏名</th>
                                <th>銀行</th>
                                <th>支店</th>
                                <th>科目</th>
                                <th>口座番号</th>
                                <th>出金</th>
                                <th>入金</th>
                                <th>残高</th>
                                <th>摘要</th>
                                <th style="min-width: 350px;">注記</th>
                                <th>信頼度</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            systemData.transactions.filter(tx => tx.annotations.length > 0).forEach(tx => {
                const rowClass = tx.annotations.some(a => a.includes('要注意')) ? 'danger-highlight' : 'highlight-row';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${tx.date}</td>`;
                html += `<td>${tx.time || ''}</td>`;
                html += `<td>${tx.name}</td>`;
                html += `<td>${tx.bank}</td>`;
                html += `<td>${tx.branch}</td>`;
                html += `<td>${tx.accountType}</td>`;
                html += `<td>${tx.accountNumber}</td>`;
                html += `<td class="text-right">${tx.withdrawal > 0 ? tx.withdrawal.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.deposit > 0 ? tx.deposit.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.balance > 0 ? tx.balance.toLocaleString() : ''}</td>`;
                html += `<td>${tx.description}</td>`;
                html += `<td style="font-weight: 700; color: #e74c3c;">${tx.annotations.join(' / ')}</td>`;
                html += `<td><span class="confidence-indicator confidence-${tx.confidence}">${tx.confidence}</span></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // 家系図ビュー（改良版）
        function updateFamilyView() {
            const container = document.getElementById('family-content');
            
            let html = '<div class="family-tree-wrapper">';
            html += '<div class="zoom-controls">';
            html += '<button class="zoom-btn" onclick="zoomIn()">+</button>';
            html += '<button class="zoom-btn" onclick="zoomOut()">-</button>';
            html += '<button class="zoom-btn" onclick="zoomReset()">⟲</button>';
            html += '</div>';
            html += '<h2 class="family-tree-title">相続関係図</h2>';
            
            const svgContent = createFamilyTreeSVG();
            html += svgContent;
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 家系図SVG生成（改良版）
        function createFamilyTreeSVG() {
            const width = 1400;
            const height = 900;
            const boxWidth = 220;
            const boxHeight = 140;
            const hGap = 60;
            const vGap = 180;
            
            const generations = {
                0: [],
                1: [],
                2: [],
                3: []
            };
            
            systemData.family.forEach(person => {
                generations[person.generation || 3].push(person);
            });
            
            let svg = `<svg id="familyTreeSvg" class="family-tree-svg" viewBox="0 0 ${width} ${height}">`;
            
            svg += `<defs>
                <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                    <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#ecf0f1" stroke-width="1"/>
                </pattern>
            </defs>
            <rect width="${width}" height="${height}" fill="url(#grid)" />`;
            
            const positions = {};
            let currentY = 80;
            
            // 被相続人世代
            const gen0Width = generations[0].length * (boxWidth + hGap) - hGap;
            let currentX = (width - gen0Width) / 2;
            
            generations[0].forEach((person, index) => {
                const x = currentX + index * (boxWidth + hGap);
                const y = currentY;
                positions[person.name] = { x: x + boxWidth/2, y: y + boxHeight/2 };
                
                svg += createPersonBox(person, x, y, boxWidth, boxHeight);
                
                if (index > 0 && person.spouse) {
                    const spousePos = positions[person.spouse];
                    if (spousePos) {
                        svg += `<line class="relation-line spouse-line" 
                            x1="${spousePos.x}" y1="${spousePos.y}" 
                            x2="${x + boxWidth/2}" y2="${y + boxHeight/2}" />`;
                    }
                }
            });
            
            // 子世代
            currentY += vGap;
            if (generations[1].length > 0) {
                const gen1Width = generations[1].length * (boxWidth + hGap) - hGap;
                currentX = (width - gen1Width) / 2;
                
                generations[1].forEach((person, index) => {
                    const x = currentX + index * (boxWidth + hGap);
                    const y = currentY;
                    positions[person.name] = { x: x + boxWidth/2, y: y + boxHeight/2 };
                    
                    svg += createPersonBox(person, x, y, boxWidth, boxHeight);
                    
                    if (person.parent && positions[person.parent]) {
                        const parentPos = positions[person.parent];
                        svg += `<line class="relation-line" 
                            x1="${parentPos.x}" y1="${parentPos.y + boxHeight/2}" 
                            x2="${x + boxWidth/2}" y2="${y}" />`;
                    }
                });
            }
            
            // 孫世代
            currentY += vGap;
            if (generations[2].length > 0) {
                const gen2Width = generations[2].length * (boxWidth + hGap) - hGap;
                currentX = (width - gen2Width) / 2;
                
                generations[2].forEach((person, index) => {
                    const x = currentX + index * (boxWidth + hGap);
                    const y = currentY;
                    positions[person.name] = { x: x + boxWidth/2, y: y + boxHeight/2 };
                    
                    svg += createPersonBox(person, x, y, boxWidth, boxHeight);
                    
                    if (person.parent && positions[person.parent]) {
                        const parentPos = positions[person.parent];
                        svg += `<line class="relation-line" 
                            x1="${parentPos.x}" y1="${parentPos.y + boxHeight/2}" 
                            x2="${x + boxWidth/2}" y2="${y}" />`;
                    }
                });
            }
            
            svg += '</svg>';
            return svg;
        }
        
        // 人物ボックス生成
        function createPersonBox(person, x, y, width, height) {
            const isDeceased = person.isDeceased;
            const isMale = person.gender === 'male';
            const address = getAddressAtDate(person.name, systemData.inheritanceDate);
            
            let box = '';
            
            const rx = isMale ? 0 : 35;
            box += `<rect class="member-box ${isDeceased ? 'deceased' : ''} ${person.gender || 'unknown'}" 
                x="${x}" y="${y}" width="${width}" height="${height}" rx="${rx}" ry="${rx}" />`;
            
            box += `<text class="member-name" x="${x + width/2}" y="${y + 30}" text-anchor="middle">${person.name}</text>`;
            box += `<text class="member-text" x="${x + width/2}" y="${y + 55}" text-anchor="middle">${person.relationship}</text>`;
            
            if (person.birthDate) {
                box += `<text class="member-text" x="${x + width/2}" y="${y + 80}" text-anchor="middle">生: ${person.birthDate}</text>`;
            }
            
            if (person.ageAtInheritance !== undefined) {
                box += `<text class="member-text" x="${x + width/2}" y="${y + 105}" text-anchor="middle">相続時: ${person.ageAtInheritance}歳</text>`;
            }
            
            if (address) {
                const shortAddr = address.length > 18 ? address.substring(0, 18) + '...' : address;
                box += `<text class="member-text" x="${x + width/2}" y="${y + 125}" text-anchor="middle" font-size="13">${shortAddr}</text>`;
            }
            
            return box;
        }
        
        // ズーム機能
        let currentZoom = 1;
        
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            applyZoom();
        }
        
        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.5);
            applyZoom();
        }
        
        function zoomReset() {
            currentZoom = 1;
            applyZoom();
        }
        
        function applyZoom() {
            const svg = document.getElementById('familyTreeSvg');
            if (svg) {
                svg.style.transform = `scale(${currentZoom})`;
                svg.style.transformOrigin = 'center center';
            }
        }
        
        // タブ切り替え
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }
        
        // 結果エクスポート
        function exportResults() {
            const inheritanceDate = systemData.inheritanceDate;
            
            let csv = '\uFEFF';
            csv += '相続税調査分析システム v3 分析結果\n';
            csv += `分析日時,${new Date().toLocaleString('ja-JP')}\n`;
            csv += `相続開始日,${inheritanceDate}\n\n`;
            
            csv += '【要注意取引一覧】\n';
            csv += '日付,時刻,氏名,銀行,支店,出金,入金,残高,摘要,フラグ,注記,信頼度\n';
            
            systemData.transactions.filter(tx => tx.flags.length > 0).forEach(tx => {
                csv += `"${tx.date}","${tx.time || ''}","${tx.name}","${tx.bank}","${tx.branch}",`;
                csv += `${tx.withdrawal},${tx.deposit},${tx.balance},"${tx.description}","${tx.flags.join('・')}","${tx.annotations.join(' / ')}","${tx.confidence}"\n`;
            });
            
            csv += '\n【資金移動】\n';
            csv += '出金日,送金者,受取人,金額,入金日,日数差,金額差,家族間,信頼度\n';
            systemData.processedData.transfers.forEach(t => {
                csv += `"${t.date}","${t.from}","${t.to}",${t.amount},"${t.depositDate}",${t.daysDiff},${t.amountDiff},${t.isFamily ? '○' : ''},"${t.confidence}"\n`;
            });
            
            csv += '\n【原資不明取引】\n';
            csv += '日付,氏名,銀行,金額,摘要,理由,信頼度\n';
            systemData.processedData.unknownSources.forEach(tx => {
                csv += `"${tx.date}","${tx.name}","${tx.bank} ${tx.branch}",${tx.deposit},"${tx.description}","${tx.reason}","${tx.confidence}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `相続税調査結果_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('分析結果をエクスポートしました', 'success');
        }
        
        // 注記付き元データエクスポート
        function exportAnnotatedData() {
            let csv = '\uFEFF';
            csv += '銀行名,支店名,氏名,科目,口座番号,日付,時刻,出金,入金,取扱店,機番,摘要,残高,注記\n';
            
            systemData.transactions.forEach(tx => {
                csv += `"${tx.bank}","${tx.branch}","${tx.name}","${tx.accountType}","${tx.accountNumber}",`;
                csv += `"${tx.date}","${tx.time || ''}",${tx.withdrawal || ''},${tx.deposit || ''},`;
                csv += `"${tx.location}","${tx.machineId}","${tx.description}",${tx.balance || ''},`;
                csv += `"${tx.annotations.join(' / ')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `注記付き取引明細_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('注記付き元データをエクスポートしました', 'success');
        }
    </script>
</body>
</html>
