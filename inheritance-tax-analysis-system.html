<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸ç¶šç¨èª¿æŸ»åˆ†æã‚·ã‚¹ãƒ†ãƒ  - æ”¹è‰¯ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Yu Gothic', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            transform: rotate(45deg);
            pointer-events: none;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        .upload-section {
            padding: 30px;
            background: #fafbfc;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .file-input-group {
            background: white;
            padding: 25px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-group:hover {
            border-color: #3949ab;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57, 73, 171, 0.15);
        }
        
        .file-input-group.uploaded {
            border-color: #4caf50;
            border-style: solid;
            background: #f0fdf4;
        }
        
        .file-input-group.uploaded::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #4caf50;
            font-size: 24px;
            font-weight: bold;
        }
        
        .file-input {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            cursor: pointer;
            background: #f6f8fa;
        }
        
        .file-label {
            display: block;
            font-weight: 600;
            color: #24292e;
            margin-bottom: 8px;
            font-size: 1.15em;
        }
        
        .file-description {
            font-size: 0.85em;
            color: #586069;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .file-status {
            margin-top: 12px;
            font-size: 0.9em;
            color: #4caf50;
            font-weight: 500;
            display: none;
        }
        
        .config-section {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e4e8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-item label {
            font-weight: 600;
            color: #24292e;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .config-item input, .config-item select {
            padding: 10px 14px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            background: #f6f8fa;
            transition: all 0.2s;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #3949ab;
            background: white;
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: #3949ab;
            color: white;
            box-shadow: 0 2px 8px rgba(57, 73, 171, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1a237e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57, 73, 171, 0.4);
        }
        
        .btn-primary:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #607d8b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #455a64;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-1px);
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            transition: width 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                45deg,
                rgba(255,255,255,0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.2) 50%,
                rgba(255,255,255,0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 30px 30px;
            animation: progress-animation 1s linear infinite;
        }
        
        @keyframes progress-animation {
            0% { background-position: 0 0; }
            100% { background-position: 30px 30px; }
        }
        
        .status-message {
            padding: 14px 20px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .status-success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
        }
        
        .status-error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
            border-left: 4px solid #dc3545;
        }
        
        .status-warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7;
            border-left: 4px solid #ffc107;
        }
        
        .status-info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
            border-left: 4px solid #17a2b8;
        }
        
        .analysis-container {
            padding: 30px;
            display: none;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e1e4e8;
            margin-bottom: 30px;
            overflow-x: auto;
            background: #f6f8fa;
            border-radius: 8px 8px 0 0;
            padding: 5px;
            gap: 5px;
        }
        
        .tab {
            padding: 14px 24px;
            background: transparent;
            cursor: pointer;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #586069;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 6px 6px 0 0;
            position: relative;
            flex-shrink: 0;
        }
        
        .tab:hover {
            background: #e1e4e8;
            color: #24292e;
        }
        
        .tab.active {
            background: white;
            color: #3949ab;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3949ab;
            border-radius: 3px 3px 0 0;
        }
        
        .tab-content {
            display: none;
            min-height: 400px;
            animation: fadeIn 0.4s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* ã‚«ãƒ¼ãƒ‰å‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
        .info-card {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        
        .info-card h3 {
            color: #24292e;
            margin-bottom: 16px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-card {
            padding: 16px 24px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 5px solid;
            animation: slideIn 0.3s ease;
        }
        
        .alert-card.warning {
            background: #fff8e1;
            color: #f57c00;
            border-color: #ff9800;
        }
        
        .alert-card.danger {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
        }
        
        .alert-card.info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #2196f3;
        }
        
        .alert-card.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4caf50;
        }
        
        /* ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« */
        .data-table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        .data-table th {
            background: #f6f8fa;
            color: #24292e;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #e1e4e8;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f3f6;
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: #f8f9fb;
        }
        
        .data-table tr.highlighted {
            background: #fff8e1;
            font-weight: 500;
        }
        
        /* æ³¨è¨˜ãƒ»ãƒ•ãƒ©ã‚°ã‚¹ã‚¿ã‚¤ãƒ« */
        .annotation-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-large-amount {
            background: #ffecb3;
            color: #e65100;
            border: 1px solid #ffb74d;
        }
        
        .badge-unknown-source {
            background: #ffccbc;
            color: #bf360c;
            border: 1px solid #ff8a65;
        }
        
        .badge-money-shift {
            background: #d1c4e9;
            color: #4527a0;
            border: 1px solid #9575cd;
        }
        
        .badge-suspicious-shift {
            background: #ef9a9a;
            color: #b71c1c;
            border: 1px solid #e57373;
        }
        
        .badge-inheritance-period {
            background: #ffcdd2;
            color: #b71c1c;
            border: 1px solid #ef5350;
        }
        
        .badge-account-open {
            background: #c8e6c9;
            color: #1b5e20;
            border: 1px solid #66bb6a;
        }
        
        .badge-account-close {
            background: #f8bbd0;
            color: #880e4f;
            border: 1px solid #f06292;
        }
        
        .badge-minor {
            background: #bbdefb;
            color: #0d47a1;
            border: 1px solid #64b5f6;
        }
        
        .badge-cohabit {
            background: #b2dfdb;
            color: #004d40;
            border: 1px solid #4db6ac;
        }
        
        .badge-blank-memo {
            background: #fff176;
            color: #f57f17;
            border: 1px solid #ffd54f;
        }
        
        /* æ®‹é«˜æ¨ç§»è¡¨ */
        .balance-table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .balance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }
        
        .balance-table th {
            background: #1a237e;
            color: white;
            padding: 14px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .balance-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #f0f3f6;
            font-size: 14px;
        }
        
        .balance-table tr:nth-child(even) {
            background: #fafbfc;
        }
        
        .balance-table tr:hover {
            background: #e3f2fd;
        }
        
        .balance-table .person-name {
            font-weight: 600;
            text-align: left;
            background: #f6f8fa;
            color: #24292e;
        }
        
        .balance-table .account-row {
            padding-left: 30px;
            text-align: left;
            font-size: 13px;
            color: #586069;
        }
        
        .balance-table .total-row {
            font-weight: 600;
            background: #e8f5e9;
            border-top: 2px solid #4caf50;
        }
        
        .balance-table .inheritance-date {
            background: #fff8e1;
            font-weight: 600;
        }
        
        .balance-positive {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .balance-negative {
            color: #c62828;
            font-weight: 600;
        }
        
        .balance-change {
            font-size: 11px;
            color: #586069;
            display: block;
            margin-top: 2px;
        }
        
        .balance-interpolated {
            font-style: italic;
            color: #7986cb;
        }
        
        /* å®¶ç³»å›³ã‚¹ã‚¿ã‚¤ãƒ« */
        .family-tree-wrapper {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 40px;
            margin: 20px 0;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .family-tree-title {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 40px;
            color: #1a237e;
        }
        
        .family-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 600px;
            position: relative;
            padding: 30px;
            min-width: max-content;
        }
        
        .generation {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            margin: 50px 0;
            position: relative;
        }
        
        .generation-label {
            position: absolute;
            left: -120px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            color: #586069;
            font-size: 14px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background: white;
            padding: 10px 5px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
        }
        
        .family-member {
            background: white;
            border: 3px solid #3949ab;
            border-radius: 12px;
            padding: 20px;
            min-width: 220px;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
            z-index: 10;
            cursor: pointer;
        }
        
        .family-member:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .family-member.deceased {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .family-member.male {
            border-style: solid;
        }
        
        .family-member.female {
            border-radius: 60px 12px 60px 12px;
        }
        
        .member-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            color: #1a237e;
        }
        
        .member-info {
            font-size: 0.9em;
            color: #586069;
            line-height: 1.6;
        }
        
        .member-info-row {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .member-info-label {
            font-weight: 600;
            color: #24292e;
        }
        
        .address-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e1e4e8;
            font-size: 0.85em;
        }
        
        .address-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
        }
        
        .same-address {
            background: #c8e6c9;
            color: #1b5e20;
        }
        
        .different-address {
            background: #fff3cd;
            color: #f57c00;
        }
        
        /* å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body {
                padding: 0;
                background: white;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .btn, .file-input-group, .config-section {
                display: none !important;
            }
            
            .tab-container {
                display: none;
            }
            
            .tab-content {
                display: block !important;
                page-break-after: always;
            }
            
            .data-table {
                font-size: 10px;
            }
            
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .file-grid, .config-grid {
                grid-template-columns: 1fr;
            }
            
            .family-tree {
                transform: scale(0.8);
                transform-origin: top center;
            }
            
            .tab {
                font-size: 13px;
                padding: 10px 16px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px;
            }
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3949ab;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .highlight-row {
            background: #fff8e1 !important;
            font-weight: 600;
        }
        
        .danger-highlight {
            background: #ffebee !important;
            color: #c62828;
        }
        
        .success-highlight {
            background: #e8f5e9 !important;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ç›¸ç¶šç¨èª¿æŸ»åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>é«˜ç²¾åº¦ãªè³‡é‡‘ç§»å‹•æ¤œå‡ºã¨åŸè³‡ä¸æ˜åˆ¤å®šã«ã‚ˆã‚Šã€ç›¸ç¶šç¨èª¿æŸ»ã«å¿…è¦ãªåˆ†æã‚’å®Ÿæ–½ã—ã¾ã™</p>
        </div>
        
        <div class="upload-section">
            <h2 class="section-title">ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <div class="file-grid">
                <div class="file-input-group" id="group1">
                    <label class="file-label">ğŸ“Š å…ƒãƒ‡ãƒ¼ã‚¿ï¼ˆå–å¼•ãƒ‡ãƒ¼ã‚¿ï¼‰</label>
                    <p class="file-description">
                        Aåˆ—:éŠ€è¡Œå Båˆ—:æ”¯åº—å Cåˆ—:æ°å Dåˆ—:ç§‘ç›®<br>
                        Eåˆ—:å£åº§ç•ªå· Fåˆ—:æ—¥ä»˜ Gåˆ—:æ™‚åˆ» Håˆ—:å‡ºé‡‘<br>
                        Iåˆ—:å…¥é‡‘ Jåˆ—:å–æ‰±åº— Kåˆ—:æ©Ÿç•ª Låˆ—:æ‘˜è¦ Måˆ—:æ®‹é«˜
                    </p>
                    <input type="file" class="file-input" id="transactionFile" accept=".csv">
                    <div class="file-status" id="status1"></div>
                </div>
                
                <div class="file-input-group" id="group2">
                    <label class="file-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—æ§‹æˆ</label>
                    <p class="file-description">
                        Aåˆ—:æ°å Båˆ—:ç¶šæŸ„ Cåˆ—:ç”Ÿå¹´æœˆæ—¥<br>
                        Dåˆ—:ç›¸ç¶šé–‹å§‹æ—¥ï¼ˆè¢«ç›¸ç¶šäººã¯æ—¥ä»˜ã€ä»–ã¯å¹´é½¢ï¼‰
                    </p>
                    <input type="file" class="file-input" id="familyFile" accept=".csv">
                    <div class="file-status" id="status2"></div>
                </div>
                
                <div class="file-input-group" id="group3">
                    <label class="file-label">ğŸ  ä½æ‰€å±¥æ­´</label>
                    <p class="file-description">
                        Aåˆ—:æ°å Båˆ—:ä½æ‰€<br>
                        Cåˆ—:å±…ä½é–‹å§‹æ—¥ Dåˆ—:å±…ä½çµ‚äº†æ—¥
                    </p>
                    <input type="file" class="file-input" id="addressFile" accept=".csv">
                    <div class="file-status" id="status3"></div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <p id="progressText" style="color: #586069; font-weight: 500;">0/3 ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ</p>
            
            <div class="config-section">
                <h3 class="section-title" style="font-size: 1.2em;">âš™ï¸ åˆ†æè¨­å®š</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <label>
                            <span>ğŸ“…</span> åˆ†æåŸºæº–å¹´
                        </label>
                        <select id="baseYear">
                            <option value="2024">2024å¹´</option>
                            <option value="2023">2023å¹´</option>
                            <option value="2022">2022å¹´</option>
                            <option value="2021">2021å¹´</option>
                            <option value="2020">2020å¹´</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>
                            <span>ğŸ’°</span> å¤§é¡å–å¼•åŸºæº–é¡
                        </label>
                        <input type="number" id="largeAmountThreshold" value="1000000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>â“</span> åŸè³‡ä¸æ˜åŸºæº–é¡
                        </label>
                        <input type="number" id="unknownSourceThreshold" value="500000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>ğŸ”„</span> è³‡é‡‘ç§»å‹•æ¤œå‡ºæ—¥æ•°
                        </label>
                        <input type="number" id="transferDays" value="7" min="1" max="30">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>ğŸ“Š</span> è³‡é‡‘ç§»å‹•èª¤å·®ç‡(%)
                        </label>
                        <input type="number" id="transferErrorRate" value="10" min="0" max="50">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>âš ï¸</span> ç›¸ç¶šå‰å¾ŒæœŸé–“(æ—¥)
                        </label>
                        <input type="number" id="inheritancePeriod" value="90" min="30" max="365">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>
                        ğŸ“Š åˆ†æé–‹å§‹
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                    </button>
                    <button class="btn btn-success hidden" id="exportBtn" onclick="exportResults()">
                        ğŸ’¾ çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-warning hidden" id="exportAnnotatedBtn" onclick="exportAnnotatedData()">
                        ğŸ“ æ³¨è¨˜ä»˜ãå…ƒãƒ‡ãƒ¼ã‚¿
                    </button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <div class="analysis-container" id="analysisContainer">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('summary')">ğŸ“‹ ç·æ‹¬</button>
                <button class="tab" onclick="showTab('balance')">ğŸ’° æ®‹é«˜æ¨ç§»è¡¨</button>
                <button class="tab" onclick="showTab('transfers')">ğŸ’¸ è³‡é‡‘ç§»å‹•åˆ†æ</button>
                <button class="tab" onclick="showTab('unknown')">â“ åŸè³‡ä¸æ˜å–å¼•</button>
                <button class="tab" onclick="showTab('addresses')">ğŸ  ä½æ‰€ç§»è»¢çŠ¶æ³</button>
                <button class="tab" onclick="showTab('annotated')">ğŸ“ æ³¨è¨˜ä»˜ãæ˜ç´°</button>
                <button class="tab" onclick="showTab('family')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç›¸ç¶šé–¢ä¿‚å›³</button>
            </div>
            
            <div id="summary-content" class="tab-content active"></div>
            <div id="balance-content" class="tab-content"></div>
            <div id="transfers-content" class="tab-content"></div>
            <div id="unknown-content" class="tab-content"></div>
            <div id="addresses-content" class="tab-content"></div>
            <div id="annotated-content" class="tab-content"></div>
            <div id="family-content" class="tab-content"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let uploadedFiles = {
            transaction: null,
            family: null,
            address: null
        };
        
        let systemData = {
            transactions: [],
            family: [],
            addresses: [],
            inheritanceDate: null,
            processedData: {
                balanceByPerson: {},
                transfers: [],
                suspiciousTransfers: [],
                unknownSources: [],
                annotations: new Map()
            }
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupFileInputs();
            updateProgress();
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¨­å®š
        function setupFileInputs() {
            document.getElementById('transactionFile').addEventListener('change', e => handleFileSelect(e, 'transaction', 1));
            document.getElementById('familyFile').addEventListener('change', e => handleFileSelect(e, 'family', 2));
            document.getElementById('addressFile').addEventListener('change', e => handleFileSelect(e, 'address', 3));
            document.getElementById('analyzeBtn').addEventListener('click', processAllFiles);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event, type, groupNumber) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            uploadedFiles[type] = file;
            
            const group = document.getElementById(`group${groupNumber}`);
            const status = document.getElementById(`status${groupNumber}`);
            
            group.classList.add('uploaded');
            status.style.display = 'block';
            status.textContent = `âœ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            updateProgress();
        }
        
        // é€²æ—æ›´æ–°
        function updateProgress() {
            const uploadedCount = Object.values(uploadedFiles).filter(f => f !== null).length;
            const percentage = (uploadedCount / 3) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${uploadedCount}/3 ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ`;
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedCount !== 3;
            
            if (uploadedCount === 3) {
                showStatus('å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            uploadedFiles = { transaction: null, family: null, address: null };
            systemData = {
                transactions: [],
                family: [],
                addresses: [],
                inheritanceDate: null,
                processedData: {
                    balanceByPerson: {},
                    transfers: [],
                    suspiciousTransfers: [],
                    unknownSources: [],
                    annotations: new Map()
                }
            };
            
            document.querySelectorAll('.file-input').forEach(input => input.value = '');
            document.querySelectorAll('.file-input-group').forEach(group => group.classList.remove('uploaded'));
            document.querySelectorAll('.file-status').forEach(status => status.style.display = 'none');
            
            document.getElementById('analysisContainer').style.display = 'none';
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('exportAnnotatedBtn').classList.add('hidden');
            
            updateProgress();
            showStatus('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }
        
        // æ”¹è‰¯ç‰ˆCSVãƒ‘ãƒ¼ã‚µãƒ¼
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            let inQuotes = false;
            let currentLine = [];
            let currentValue = '';
            
            for (let line of lines) {
                if (!line.trim() && !inQuotes) continue;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        currentLine.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                if (!inQuotes) {
                    currentLine.push(currentValue.trim());
                    if (currentLine.length > 0 && currentLine.some(v => v)) {
                        result.push(currentLine);
                    }
                    currentLine = [];
                    currentValue = '';
                } else {
                    currentValue += '\n';
                }
            }
            
            return result;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        async function processAllFiles() {
            try {
                showLoading(true);
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...', 'info');
                
                // å–å¼•ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                const transactionText = await readFile(uploadedFiles.transaction);
                const transactionData = parseCSV(transactionText);
                systemData.transactions = parseTransactionData(transactionData);
                
                // å®¶æ—æ§‹æˆå‡¦ç†
                const familyText = await readFile(uploadedFiles.family);
                const familyData = parseCSV(familyText);
                systemData.family = parseFamilyData(familyData);
                
                // ä½æ‰€å±¥æ­´å‡¦ç†
                const addressText = await readFile(uploadedFiles.address);
                const addressData = parseCSV(addressText);
                systemData.addresses = parseAddressData(addressData);
                
                // ãƒ‡ãƒ¼ã‚¿åˆ†æå®Ÿè¡Œ
                await analyzeData();
                
                // çµæœè¡¨ç¤º
                document.getElementById('analysisContainer').style.display = 'block';
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('exportAnnotatedBtn').classList.remove('hidden');
                
                updateAllViews();
                showStatus('åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                // åˆ†æçµæœã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('analysisContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }
        
        // å–å¼•ãƒ‡ãƒ¼ã‚¿è§£æ
        function parseTransactionData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const transactions = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 13) {
                    transactions.push({
                        id: i,
                        bank: row[0] || '',
                        branch: row[1] || '',
                        name: row[2] || '',
                        accountType: row[3] || '',
                        accountNumber: row[4] || '',
                        date: row[5] || '',
                        time: row[6] || '',
                        withdrawal: parseFloat(row[7]) || 0,
                        deposit: parseFloat(row[8]) || 0,
                        location: row[9] || '',
                        machineId: row[10] || '',
                        description: row[11] || '',
                        balance: parseFloat(row[12]) || 0,
                        flags: [],
                        annotations: []
                    });
                }
            }
            
            return transactions.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare !== 0) return dateCompare;
                // åŒæ—¥ã®å ´åˆã¯æ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆ
                return (a.time || '00:00:00').localeCompare(b.time || '00:00:00');
            });
        }
        
        // å®¶æ—ãƒ‡ãƒ¼ã‚¿è§£æ
        function parseFamilyData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const family = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 4) {
                    const member = {
                        name: row[0] || '',
                        relationship: row[1] || '',
                        birthDate: row[2] || '',
                        inheritanceInfo: row[3] || ''
                    };
                    
                    // è¢«ç›¸ç¶šäººã®åˆ¤å®šã¨ç›¸ç¶šé–‹å§‹æ—¥ã®å–å¾—
                    if (member.relationship.includes('è¢«ç›¸ç¶šäºº')) {
                        member.isDeceased = true;
                        // Dåˆ—ã«æ—¥ä»˜å½¢å¼ãŒã‚ã‚Œã°ç›¸ç¶šé–‹å§‹æ—¥ã¨ã—ã¦è¨­å®š
                        if (member.inheritanceInfo && member.inheritanceInfo.match(/\d{4}-\d{2}-\d{2}/)) {
                            systemData.inheritanceDate = member.inheritanceInfo;
                        }
                    } else {
                        // ãã®ä»–ã®äººã¯å¹´é½¢ã¨ã—ã¦æ‰±ã†
                        const ageMatch = member.inheritanceInfo.match(/(\d+)æ­³?/);
                        if (ageMatch) {
                            member.ageAtInheritance = parseInt(ageMatch[1]);
                        }
                    }
                    
                    // æ€§åˆ¥æ¨å®š
                    const rel = member.relationship;
                    if (rel.includes('å¤«') || rel.includes('çˆ¶') || rel.includes('ç”·') || 
                        rel.includes('æ¯å­') || rel.includes('é•·ç”·') || rel.includes('æ¬¡ç”·') || rel.includes('ä¸‰ç”·')) {
                        member.gender = 'male';
                    } else if (rel.includes('å¦»') || rel.includes('æ¯') || rel.includes('å¥³') || 
                               rel.includes('å¨˜') || rel.includes('é•·å¥³') || rel.includes('æ¬¡å¥³') || rel.includes('ä¸‰å¥³')) {
                        member.gender = 'female';
                    } else {
                        member.gender = 'unknown';
                    }
                    
                    family.push(member);
                }
            }
            
            return family;
        }
        
        // ä½æ‰€ãƒ‡ãƒ¼ã‚¿è§£æ
        function parseAddressData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const addresses = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 3) {
                    addresses.push({
                        name: row[0] || '',
                        address: row[1] || '',
                        startDate: row[2] || '',
                        endDate: row[3] || ''
                    });
                }
            }
            
            // çµ‚äº†æ—¥ãŒç„¡ã„å ´åˆã®è£œå®Œå‡¦ç†
            const peopleNames = [...new Set(addresses.map(a => a.name))];
            peopleNames.forEach(name => {
                const personAddresses = addresses
                    .filter(a => a.name === name)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                for (let i = 0; i < personAddresses.length - 1; i++) {
                    if (!personAddresses[i].endDate) {
                        const nextStartDate = new Date(personAddresses[i + 1].startDate);
                        nextStartDate.setDate(nextStartDate.getDate() - 1);
                        personAddresses[i].endDate = nextStartDate.toISOString().split('T')[0];
                    }
                }
            });
            
            return addresses;
        }
        
        // æ”¹è‰¯ç‰ˆãƒ‡ãƒ¼ã‚¿åˆ†æ
        async function analyzeData() {
            const inheritanceDate = systemData.inheritanceDate;
            const largeAmountThreshold = parseInt(document.getElementById('largeAmountThreshold').value);
            const unknownSourceThreshold = parseInt(document.getElementById('unknownSourceThreshold').value);
            const transferDays = parseInt(document.getElementById('transferDays').value);
            const transferErrorRate = parseInt(document.getElementById('transferErrorRate').value) / 100;
            const inheritancePeriod = parseInt(document.getElementById('inheritancePeriod').value);
            
            // å–å¼•ãƒ•ãƒ©ã‚°ä»˜ã‘ã¨æ³¨è¨˜ä½œæˆ
            addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod);
            
            // æ®‹é«˜æ¨ç§»åˆ†æï¼ˆè£œå®Œæ©Ÿèƒ½ä»˜ãï¼‰
            analyzeBalanceHistory();
            
            // é«˜ç²¾åº¦è³‡é‡‘ç§»å‹•æ¤œå‡º
            detectMoneyTransfers(transferDays, transferErrorRate);
            
            // åŸè³‡ä¸æ˜å–å¼•æ¤œå‡ºï¼ˆæ‘˜è¦ç©ºç™½å«ã‚€ï¼‰
            detectUnknownSources(unknownSourceThreshold);
            
            // æ³¨è¨˜æƒ…å ±ã®ç”Ÿæˆ
            generateAnnotations();
        }
        
        // æ”¹è‰¯ç‰ˆå–å¼•ãƒ•ãƒ©ã‚°ä»˜ã‘
        function addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod) {
            const inhDate = new Date(inheritanceDate);
            
            systemData.transactions.forEach(tx => {
                tx.flags = [];
                tx.annotations = [];
                const amount = Math.max(tx.withdrawal, tx.deposit);
                const txDate = new Date(tx.date);
                
                // å¤§é¡å–å¼•
                if (amount >= largeAmountThreshold) {
                    tx.flags.push('å¤§é¡å–å¼•');
                    tx.annotations.push(`â˜…å¤§é¡å–å¼•(${amount.toLocaleString()}å††)`);
                }
                
                // æ‘˜è¦ç©ºç™½ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¦ï¼‰
                if (!tx.description || tx.description.trim() === '') {
                    tx.flags.push('æ‘˜è¦ç©ºç™½');
                    tx.annotations.push('â˜…æ‘˜è¦æ¬„ç©ºç™½(çª“å£å–å¼•ã®å¯èƒ½æ€§)');
                }
                
                // åŸè³‡ä¸æ˜ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                if (tx.deposit >= unknownSourceThreshold) {
                    if (!tx.description || 
                        tx.description.trim() === '' || 
                        tx.description === 'å…¥é‡‘' || 
                        tx.description.includes('ç¾é‡‘') ||
                        tx.description.includes('ATM')) {
                        
                        tx.flags.push('åŸè³‡ä¸æ˜');
                        tx.annotations.push(`â˜…åŸè³‡ä¸æ˜å…¥é‡‘(${tx.deposit.toLocaleString()}å††)`);
                        
                        // ä½æ‰€ç§»å‹•ç›´å¾Œãƒã‚§ãƒƒã‚¯
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('â˜…ä½æ‰€ç§»å‹•å¾Œ30æ—¥ä»¥å†…ã®å…¥é‡‘');
                        }
                    }
                }
                
                // ç›¸ç¶šå‰å¾ŒæœŸé–“
                const daysDiff = Math.abs(txDate - inhDate) / (1000 * 60 * 60 * 24);
                if (daysDiff <= inheritancePeriod) {
                    tx.flags.push('ç›¸ç¶šå‰å¾Œ');
                    if (amount >= 100000) {
                        tx.annotations.push(`â˜…ç›¸ç¶šå‰å¾Œ${Math.round(daysDiff)}æ—¥ã®å–å¼•`);
                    }
                }
                
                // å£åº§é–‹è¨­ãƒ»è§£ç´„
                if (tx.description && (tx.description.includes('é–‹è¨­') || tx.description.includes('æ–°è¦'))) {
                    tx.flags.push('å£åº§é–‹è¨­');
                    tx.annotations.push('â˜…å£åº§é–‹è¨­');
                }
                if (tx.description && (tx.description.includes('è§£ç´„') || tx.description.includes('é–‰é–'))) {
                    tx.flags.push('å£åº§è§£ç´„');
                    tx.annotations.push('â˜…å£åº§è§£ç´„');
                }
                
                // æœªæˆå¹´åˆ¤å®šï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                const person = systemData.family.find(f => f.name === tx.name);
                if (person && person.birthDate) {
                    const age = calculateAge(person.birthDate, tx.date);
                    if (age < 20) {
                        tx.flags.push('æœªæˆå¹´');
                        tx.annotations.push(`â˜…æœªæˆå¹´å–å¼•(${age}æ­³)`);
                        
                        // å£åº§é–‹è¨­æ™‚ã®ç®¡ç†è€…æ¨å®š
                        if (tx.flags.includes('å£åº§é–‹è¨­')) {
                            const cohabitants = getCohabitantsAtDate(tx.name, tx.date);
                            if (cohabitants.length > 0) {
                                tx.annotations.push(`â˜…æ¨å®šç®¡ç†è€…: ${cohabitants.join(', ')}`);
                            }
                        }
                    }
                }
                
                // è¢«ç›¸ç¶šäººåŒå±…åˆ¤å®š
                if (isSameAddressAsDeceased(tx.name, tx.date)) {
                    tx.flags.push('è¢«ç›¸ç¶šäººåŒå±…');
                    tx.annotations.push('â˜…è¢«ç›¸ç¶šäººã¨åŒå±…');
                }
            });
        }
        
        // å¹´é½¢è¨ˆç®—
        function calculateAge(birthDate, targetDate) {
            const birth = new Date(birthDate);
            const target = new Date(targetDate);
            let age = target.getFullYear() - birth.getFullYear();
            const monthDiff = target.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && target.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        // æœ€è¿‘ã®ä½æ‰€å¤‰æ›´ãƒã‚§ãƒƒã‚¯
        function checkRecentAddressChange(name, date, days) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const startDate = new Date(addr.startDate);
                const daysDiff = (targetDate - startDate) / (1000 * 60 * 60 * 24);
                if (daysDiff >= 0 && daysDiff <= days) {
                    return true;
                }
            }
            return false;
        }
        
        // ç‰¹å®šæ—¥ã®åŒå±…äººå–å¾—
        function getCohabitantsAtDate(name, date) {
            const address = getAddressAtDate(name, date);
            if (!address) return [];
            
            const cohabitants = [];
            systemData.family.forEach(person => {
                if (person.name !== name) {
                    const personAddr = getAddressAtDate(person.name, date);
                    if (personAddr === address) {
                        cohabitants.push(person.name);
                    }
                }
            });
            
            return cohabitants;
        }
        
        // è¢«ç›¸ç¶šäººåŒå±…åˆ¤å®š
        function isSameAddressAsDeceased(personName, date) {
            const deceased = systemData.family.find(f => f.isDeceased);
            if (!deceased) return false;
            
            const deceasedAddr = getAddressAtDate(deceased.name, date);
            const personAddr = getAddressAtDate(personName, date);
            
            return deceasedAddr && personAddr && deceasedAddr === personAddr;
        }
        
        // ç‰¹å®šæ—¥ã®ä½æ‰€å–å¾—
        function getAddressAtDate(name, date) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const start = new Date(addr.startDate);
                const end = addr.endDate ? new Date(addr.endDate) : new Date('9999-12-31');
                
                if (targetDate >= start && targetDate <= end) {
                    return addr.address;
                }
            }
            
            return null;
        }
        
        // æ”¹è‰¯ç‰ˆæ®‹é«˜æ¨ç§»åˆ†æï¼ˆè£œå®Œæ©Ÿèƒ½ä»˜ãï¼‰
        function analyzeBalanceHistory() {
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            systemData.processedData.balanceByPerson = {};
            
            // äººã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            systemData.family.forEach(person => {
                const personData = {
                    name: person.name,
                    accounts: {},
                    yearlyTotal: {},
                    inheritanceTotal: 0
                };
                
                // ãã®äººã®å…¨å–å¼•ã‚’å–å¾—
                const personTx = systemData.transactions.filter(tx => tx.name === person.name);
                
                // å£åº§ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                personTx.forEach(tx => {
                    const accountKey = `${tx.bank}_${tx.branch}_${tx.accountNumber}`;
                    if (!personData.accounts[accountKey]) {
                        personData.accounts[accountKey] = {
                            bank: tx.bank,
                            branch: tx.branch,
                            accountNumber: tx.accountNumber,
                            accountType: tx.accountType,
                            transactions: [],
                            yearlyBalance: {},
                            inheritanceBalance: 0,
                            openDate: null,
                            closeDate: null
                        };
                    }
                    personData.accounts[accountKey].transactions.push(tx);
                    
                    // å£åº§é–‹è¨­ãƒ»è§£ç´„æ—¥ã®è¨˜éŒ²
                    if (tx.flags.includes('å£åº§é–‹è¨­')) {
                        personData.accounts[accountKey].openDate = tx.date;
                    }
                    if (tx.flags.includes('å£åº§è§£ç´„')) {
                        personData.accounts[accountKey].closeDate = tx.date;
                    }
                });
                
                // å„å£åº§ã®å¹´æœ«æ®‹é«˜ã‚’è¨ˆç®—ï¼ˆè£œå®Œæ©Ÿèƒ½ä»˜ãï¼‰
                Object.values(personData.accounts).forEach(account => {
                    // 5å¹´åˆ†ã®å¹´æœ«æ®‹é«˜
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const yearEnd = `${year}-12-31`;
                        const balance = getBalanceAtDate(account.transactions, yearEnd, true);
                        account.yearlyBalance[year] = balance;
                        
                        if (!personData.yearlyTotal[year]) {
                            personData.yearlyTotal[year] = 0;
                        }
                        if (balance.value !== null) {
                            personData.yearlyTotal[year] += balance.value;
                        }
                    }
                    
                    // ç›¸ç¶šé–‹å§‹æ—¥æ®‹é«˜
                    const inhBalance = getBalanceAtDate(account.transactions, inheritanceDate, true);
                    account.inheritanceBalance = inhBalance;
                    if (inhBalance.value !== null) {
                        personData.inheritanceTotal += inhBalance.value;
                    }
                });
                
                systemData.processedData.balanceByPerson[person.name] = personData;
            });
        }
        
        // æ”¹è‰¯ç‰ˆï¼šç‰¹å®šæ—¥ã®æ®‹é«˜å–å¾—ï¼ˆè£œå®Œæ©Ÿèƒ½ä»˜ãï¼‰
        function getBalanceAtDate(transactions, targetDate, withInterpolation = false) {
            const target = new Date(targetDate);
            let result = { value: null, isInterpolated: false };
            
            // æ®‹é«˜ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å–å¼•ã®ã¿
            const balanceTx = transactions.filter(tx => tx.balance > 0);
            if (balanceTx.length === 0) return result;
            
            // å¯¾è±¡æ—¥ä»¥å‰ã§æœ€ã‚‚è¿‘ã„æ®‹é«˜
            let closestBefore = null;
            let closestBeforeDate = null;
            
            // å¯¾è±¡æ—¥ä»¥é™ã§æœ€ã‚‚è¿‘ã„æ®‹é«˜
            let closestAfter = null;
            let closestAfterDate = null;
            
            balanceTx.forEach(tx => {
                const txDate = new Date(tx.date);
                
                if (txDate <= target) {
                    if (!closestBeforeDate || txDate > closestBeforeDate) {
                        closestBeforeDate = txDate;
                        closestBefore = tx;
                    }
                } else {
                    if (!closestAfterDate || txDate < closestAfterDate) {
                        closestAfterDate = txDate;
                        closestAfter = tx;
                    }
                }
            });
            
            // å¯¾è±¡æ—¥ä»¥å‰ã«æ®‹é«˜ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
            if (closestBefore) {
                result.value = closestBefore.balance;
                
                // å¹´æœ«æ™‚ç‚¹ã®è£œå®Œãƒã‚§ãƒƒã‚¯
                if (withInterpolation && targetDate.endsWith('-12-31')) {
                    const yearEnd = new Date(targetDate);
                    const daysDiff = (yearEnd - closestBeforeDate) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 30) {
                        result.isInterpolated = true;
                    }
                }
                
                return result;
            }
            
            // å£åº§é–‹è¨­å‰ãªã‚‰0
            const firstTx = transactions[0];
            if (firstTx && new Date(firstTx.date) > target) {
                result.value = 0;
                return result;
            }
            
            // å¯¾è±¡æ—¥ä»¥é™ã®æ®‹é«˜ã‚’è£œå®Œã¨ã—ã¦ä½¿ç”¨
            if (closestAfter && withInterpolation) {
                result.value = closestAfter.balance;
                result.isInterpolated = true;
                return result;
            }
            
            return result;
        }
        
        // æ”¹è‰¯ç‰ˆï¼šé«˜ç²¾åº¦è³‡é‡‘ç§»å‹•æ¤œå‡º
        function detectMoneyTransfers(maxDays, errorRate) {
            systemData.processedData.transfers = [];
            systemData.processedData.suspiciousTransfers = [];
            
            // å‡ºé‡‘å–å¼•ã‚’æŠ½å‡º
            const withdrawals = systemData.transactions.filter(tx => tx.withdrawal > 0);
            
            withdrawals.forEach(withdrawal => {
                const wDate = new Date(withdrawal.date);
                const wAmount = withdrawal.withdrawal;
                
                // å¯¾è±¡æœŸé–“å†…ã®å…¥é‡‘ã‚’æ¤œç´¢
                const potentialDeposits = systemData.transactions.filter(tx => {
                    if (tx.deposit === 0) return false;
                    
                    const dDate = new Date(tx.date);
                    const daysDiff = (dDate - wDate) / (1000 * 60 * 60 * 24);
                    
                    // æ—¥æ•°æ¡ä»¶
                    if (daysDiff < 0 || daysDiff > maxDays) return false;
                    
                    // é‡‘é¡èª¤å·®æ¡ä»¶
                    const amountDiff = Math.abs(tx.deposit - wAmount) / wAmount;
                    if (amountDiff > errorRate) return false;
                    
                    return true;
                });
                
                // ãƒãƒƒãƒãƒ³ã‚°å€™è£œã‚’ã‚¹ã‚³ã‚¢ä»˜ã‘ã—ã¦è©•ä¾¡
                const matches = potentialDeposits.map(deposit => {
                    const dDate = new Date(deposit.date);
                    const daysDiff = (dDate - wDate) / (1000 * 60 * 60 * 24);
                    const amountDiff = Math.abs(deposit.deposit - wAmount);
                    const amountDiffRate = amountDiff / wAmount;
                    
                    // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆä½ã„ã»ã©è‰¯ã„ï¼‰
                    let score = daysDiff * 10 + amountDiffRate * 100;
                    
                    // åŒä¸€äººç‰©é–“ãªã‚‰ä½ã‚¹ã‚³ã‚¢
                    if (withdrawal.name === deposit.name) {
                        score += 50;
                    }
                    
                    // è¦ªå­é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
                    const isFamily = checkFamilyRelation(withdrawal.name, deposit.name);
                    if (isFamily) {
                        score -= 20;
                    }
                    
                    // æ™‚åˆ»è€ƒæ…®ï¼ˆåŒæ—¥ã®å ´åˆï¼‰
                    if (daysDiff === 0 && withdrawal.time && deposit.time) {
                        const wTime = withdrawal.time.split(':').map(Number);
                        const dTime = deposit.time.split(':').map(Number);
                        const wMinutes = wTime[0] * 60 + wTime[1];
                        const dMinutes = dTime[0] * 60 + dTime[1];
                        
                        if (dMinutes < wMinutes) {
                            score += 100; // å…¥é‡‘ãŒå‡ºé‡‘ã‚ˆã‚Šå‰ã¯ä¸è‡ªç„¶
                        }
                    }
                    
                    return {
                        deposit: deposit,
                        score: score,
                        daysDiff: daysDiff,
                        amountDiff: amountDiff,
                        amountDiffRate: amountDiffRate,
                        isFamily: isFamily
                    };
                });
                
                // æœ€è‰¯ã®ãƒãƒƒãƒã‚’é¸æŠ
                if (matches.length > 0) {
                    matches.sort((a, b) => a.score - b.score);
                    const bestMatch = matches[0];
                    
                    const transfer = {
                        date: withdrawal.date,
                        from: withdrawal.name,
                        to: bestMatch.deposit.name,
                        amount: withdrawal.withdrawal,
                        fromBank: `${withdrawal.bank} ${withdrawal.branch}`,
                        toBank: `${bestMatch.deposit.bank} ${bestMatch.deposit.branch}`,
                        fromAccount: withdrawal.accountNumber,
                        toAccount: bestMatch.deposit.accountNumber,
                        depositDate: bestMatch.deposit.date,
                        daysDiff: bestMatch.daysDiff,
                        amountDiff: bestMatch.amountDiff,
                        amountDiffRate: bestMatch.amountDiffRate,
                        isFamily: bestMatch.isFamily,
                        score: bestMatch.score
                    };
                    
                    // ç–‘ã‚ã—ã„è³‡é‡‘ç§»å‹•ã®åˆ¤å®š
                    if (bestMatch.score < 30 && withdrawal.name !== bestMatch.deposit.name) {
                        systemData.processedData.transfers.push(transfer);
                        
                        // ãƒ•ãƒ©ã‚°ã¨ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
                        withdrawal.flags.push('è³‡é‡‘ç§»å‹•(å‡º)');
                        bestMatch.deposit.flags.push('è³‡é‡‘ç§»å‹•(å…¥)');
                        
                        const annotation = `â˜…è³‡é‡‘ç§»å‹•: ${withdrawal.name}â†’${bestMatch.deposit.name} (${bestMatch.daysDiff}æ—¥å¾Œ, èª¤å·®${(bestMatch.amountDiffRate * 100).toFixed(1)}%)`;
                        withdrawal.annotations.push(annotation);
                        bestMatch.deposit.annotations.push(annotation);
                        
                        // ç‰¹ã«ç–‘ã‚ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³
                        if (bestMatch.isFamily && bestMatch.daysDiff <= 1 && bestMatch.amountDiffRate < 0.01) {
                            systemData.processedData.suspiciousTransfers.push(transfer);
                            withdrawal.annotations.push('â˜…è¦æ³¨æ„ï¼šå®¶æ—é–“å³æ—¥è³‡é‡‘ç§»å‹•');
                            bestMatch.deposit.annotations.push('â˜…è¦æ³¨æ„ï¼šå®¶æ—é–“å³æ—¥è³‡é‡‘ç§»å‹•');
                        }
                    }
                }
            });
        }
        
        // å®¶æ—é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        function checkFamilyRelation(name1, name2) {
            const person1 = systemData.family.find(f => f.name === name1);
            const person2 = systemData.family.find(f => f.name === name2);
            
            if (!person1 || !person2) return false;
            
            // è¦ªå­é–¢ä¿‚ã®åˆ¤å®šï¼ˆç¶šæŸ„ã‹ã‚‰æ¨å®šï¼‰
            const rel1 = person1.relationship;
            const rel2 = person2.relationship;
            
            // è¢«ç›¸ç¶šäººã¨é…å¶è€…
            if ((person1.isDeceased && rel2.includes('é…å¶è€…')) ||
                (person2.isDeceased && rel1.includes('é…å¶è€…'))) {
                return true;
            }
            
            // è¦ªå­é–¢ä¿‚
            if ((rel1.includes('å­') && !rel1.includes('å­«')) || 
                (rel2.includes('å­') && !rel2.includes('å­«'))) {
                return true;
            }
            
            return false;
        }
        
        // æ”¹è‰¯ç‰ˆï¼šåŸè³‡ä¸æ˜å–å¼•æ¤œå‡º
        function detectUnknownSources(threshold) {
            systemData.processedData.unknownSources = [];
            
            systemData.transactions.forEach(tx => {
                if (tx.deposit >= threshold) {
                    let isUnknown = false;
                    let reason = '';
                    
                    // æ‘˜è¦ç©ºç™½ï¼ˆæœ€é‡è¦ï¼‰
                    if (!tx.description || tx.description.trim() === '') {
                        isUnknown = true;
                        reason = 'æ‘˜è¦æ¬„ç©ºç™½ï¼ˆçª“å£å–å¼•ï¼‰';
                    }
                    // ä¸€èˆ¬çš„ãªå…¥é‡‘è¡¨è¨˜
                    else if (tx.description === 'å…¥é‡‘' || 
                             tx.description === 'ç¾é‡‘' || 
                             tx.description === 'ç¾é‡‘å…¥é‡‘' ||
                             tx.description.includes('ATM')) {
                        isUnknown = true;
                        reason = `å…¥é‡‘ç¨®åˆ¥: ${tx.description}`;
                    }
                    
                    if (isUnknown) {
                        systemData.processedData.unknownSources.push({
                            ...tx,
                            reason: reason
                        });
                        
                        if (!tx.flags.includes('åŸè³‡ä¸æ˜')) {
                            tx.flags.push('åŸè³‡ä¸æ˜');
                        }
                        
                        // è¿½åŠ ã®ç–‘ç¾©ãƒã‚§ãƒƒã‚¯
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('â˜…ä½æ‰€ç§»å‹•ç›´å¾Œã®åŸè³‡ä¸æ˜å…¥é‡‘ï¼ˆè¦ç¢ºèªï¼‰');
                        }
                        
                        // æœªæˆå¹´ã¸ã®å…¥é‡‘
                        if (tx.flags.includes('æœªæˆå¹´')) {
                            tx.annotations.push('â˜…æœªæˆå¹´å£åº§ã¸ã®åŸè³‡ä¸æ˜å…¥é‡‘ï¼ˆè´ˆä¸ã®å¯èƒ½æ€§ï¼‰');
                        }
                    }
                }
            });
        }
        
        // æ³¨è¨˜æƒ…å ±ã®ç”Ÿæˆ
        function generateAnnotations() {
            systemData.processedData.annotations.clear();
            
            systemData.transactions.forEach(tx => {
                if (tx.annotations.length > 0) {
                    const key = `${tx.id}`;
                    systemData.processedData.annotations.set(key, tx.annotations.join(' / '));
                }
            });
        }
        
        // ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateAllViews() {
            updateSummaryView();
            updateBalanceView();
            updateTransfersView();
            updateUnknownView();
            updateAddressView();
            updateAnnotatedView();
            updateFamilyView();
        }
        
        // ç·æ‹¬ãƒ“ãƒ¥ãƒ¼
        function updateSummaryView() {
            const container = document.getElementById('summary-content');
            const inheritanceDate = systemData.inheritanceDate;
            
            const totalTx = systemData.transactions.length;
            const flaggedTx = systemData.transactions.filter(tx => tx.flags.length > 0).length;
            const transfers = systemData.processedData.transfers.length;
            const suspiciousTransfers = systemData.processedData.suspiciousTransfers.length;
            const unknownSources = systemData.processedData.unknownSources.length;
            const blankMemo = systemData.transactions.filter(tx => tx.flags.includes('æ‘˜è¦ç©ºç™½')).length;
            
            let html = `
                <div class="info-card">
                    <h3>ğŸ“Š èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼</h3>
                    <p><strong>ç›¸ç¶šé–‹å§‹æ—¥ï¼š</strong>${inheritanceDate}</p>
                    <p><strong>åˆ†æå¯¾è±¡æœŸé–“ï¼š</strong>${systemData.transactions[0]?.date || 'N/A'} ï½ ${systemData.transactions[systemData.transactions.length-1]?.date || 'N/A'}</p>
                    <p><strong>å¯¾è±¡äººæ•°ï¼š</strong>${systemData.family.length}å</p>
                </div>
                
                <div class="alert-card ${flaggedTx > totalTx * 0.1 ? 'danger' : 'warning'}">
                    <h4>ğŸ” æ¤œå‡ºçµæœ</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>ç·å–å¼•ä»¶æ•°ï¼š<strong>${totalTx}</strong>ä»¶</li>
                        <li>è¦æ³¨æ„å–å¼•ï¼š<strong>${flaggedTx}</strong>ä»¶ï¼ˆ${(flaggedTx/totalTx*100).toFixed(1)}%ï¼‰</li>
                        <li>è³‡é‡‘ç§»å‹•æ¤œå‡ºï¼š<strong>${transfers}</strong>ä»¶${suspiciousTransfers > 0 ? ` <span style="color: #c62828;">ï¼ˆã†ã¡è¦æ³¨æ„ ${suspiciousTransfers}ä»¶ï¼‰</span>` : ''}</li>
                        <li>åŸè³‡ä¸æ˜å–å¼•ï¼š<strong>${unknownSources}</strong>ä»¶</li>
                        <li>æ‘˜è¦ç©ºç™½å–å¼•ï¼š<strong>${blankMemo}</strong>ä»¶ <span style="color: #f57c00;">ï¼ˆçª“å£å–å¼•ã®å¯èƒ½æ€§ï¼‰</span></li>
                    </ul>
                </div>
            `;
            
            // å„äººã®æ®‹é«˜ã‚µãƒãƒªãƒ¼
            html += `
                <div class="info-card">
                    <h3>ğŸ’° å„äººã®æ®‹é«˜çŠ¶æ³</h3>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ°å</th>
                                    <th>ç¶šæŸ„</th>
                                    <th>ç›¸ç¶šæ™‚æ®‹é«˜</th>
                                    <th>å£åº§æ•°</th>
                                    <th>è¦æ³¨æ„å–å¼•</th>
                                    <th>åŸè³‡ä¸æ˜</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            systemData.family.forEach(person => {
                const balanceData = systemData.processedData.balanceByPerson[person.name];
                const flaggedCount = systemData.transactions.filter(tx => 
                    tx.name === person.name && tx.flags.length > 0
                ).length;
                const unknownCount = systemData.processedData.unknownSources.filter(tx => 
                    tx.name === person.name
                ).length;
                
                const rowClass = person.isDeceased ? 'highlight-row' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="font-bold">${person.name}</td>
                        <td>${person.relationship}</td>
                        <td class="text-right">${balanceData ? balanceData.inheritanceTotal.toLocaleString() : 0}å††</td>
                        <td class="text-center">${balanceData ? Object.keys(balanceData.accounts).length : 0}</td>
                        <td class="text-center">${flaggedCount > 0 ? `<span class="annotation-badge badge-large-amount">${flaggedCount}</span>` : '0'}</td>
                        <td class="text-center">${unknownCount > 0 ? `<span class="annotation-badge badge-unknown-source">${unknownCount}</span>` : '0'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            
            // é‡è¦ãªæ³¨æ„äº‹é …
            if (suspiciousTransfers > 0 || blankMemo > 10) {
                html += `
                    <div class="alert-card danger">
                        <h4>âš ï¸ é‡è¦ãªç¢ºèªäº‹é …</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                `;
                
                if (suspiciousTransfers > 0) {
                    html += '<li>å®¶æ—é–“ã§ã®å³æ—¥è³‡é‡‘ç§»å‹•ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è´ˆä¸ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å¥‘ç´„æ›¸ç­‰ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚</li>';
                }
                
                if (blankMemo > 10) {
                    html += '<li>æ‘˜è¦æ¬„ãŒç©ºç™½ã®å–å¼•ãŒå¤šæ•°æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚éŠ€è¡Œçª“å£ã§ã®å–å¼•è¨˜éŒ²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</li>';
                }
                
                html += '</ul></div>';
            }
            
            container.innerHTML = html;
        }
        
        // æ®‹é«˜æ¨ç§»è¡¨ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function updateBalanceView() {
            const container = document.getElementById('balance-content');
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            let html = '<h3 style="margin: 20px 0;">ğŸ’° å„äººåˆ¥æ®‹é«˜æ¨ç§»è¡¨</h3>';
            html += '<p style="color: #7986cb; font-style: italic; margin-bottom: 20px;">â€» æ–œä½“ã®æ•°å€¤ã¯å¹´å†…æœ€çµ‚å–å¼•æ—¥ã®æ®‹é«˜ã‚’è¡¨ç¤ºï¼ˆè£œå®Œå€¤ï¼‰</p>';
            
            Object.entries(systemData.processedData.balanceByPerson).forEach(([name, personData]) => {
                const person = systemData.family.find(f => f.name === name);
                const cardClass = person && person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${name} ã®æ®‹é«˜æ¨ç§»</h4>
                        <div class="balance-table-wrapper">
                            <table class="balance-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 220px;">å£åº§æƒ…å ±</th>
                `;
                
                // å¹´åº¦ãƒ˜ãƒƒãƒ€ãƒ¼
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    html += `<th style="min-width: 140px;">${year}å¹´æœ«</th>`;
                }
                html += `<th class="inheritance-date" style="min-width: 160px;">ç›¸ç¶šé–‹å§‹æ—¥<br>(${inheritanceDate})</th>`;
                html += '</tr></thead><tbody>';
                
                // å„å£åº§ã®æ®‹é«˜
                Object.values(personData.accounts).forEach(account => {
                    html += '<tr>';
                    html += `<td class="account-row">
                        ${account.bank} ${account.branch}<br>
                        ${account.accountType} ${account.accountNumber}
                        ${account.openDate ? `<br><small>é–‹è¨­: ${account.openDate}</small>` : ''}
                        ${account.closeDate ? `<br><small>è§£ç´„: ${account.closeDate}</small>` : ''}
                    </td>`;
                    
                    let prevBalance = 0;
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const balanceData = account.yearlyBalance[year] || { value: null, isInterpolated: false };
                        
                        if (balanceData.value !== null) {
                            const change = balanceData.value - prevBalance;
                            const changeClass = change > 0 ? 'balance-positive' : change < 0 ? 'balance-negative' : '';
                            const interpolatedClass = balanceData.isInterpolated ? 'balance-interpolated' : '';
                            
                            html += `<td class="${interpolatedClass}">
                                ${balanceData.value.toLocaleString()}
                                ${prevBalance > 0 && !balanceData.isInterpolated ? 
                                    `<span class="balance-change ${changeClass}">(${change > 0 ? '+' : ''}${change.toLocaleString()})</span>` 
                                    : ''}
                            </td>`;
                            prevBalance = balanceData.value;
                        } else {
                            html += '<td>-</td>';
                        }
                    }
                    
                    const inhBalance = account.inheritanceBalance;
                    if (inhBalance.value !== null) {
                        html += `<td class="inheritance-date ${inhBalance.isInterpolated ? 'balance-interpolated' : ''}">
                            ${inhBalance.value.toLocaleString()}
                        </td>`;
                    } else {
                        html += '<td class="inheritance-date">-</td>';
                    }
                    
                    html += '</tr>';
                });
                
                // åˆè¨ˆè¡Œ
                html += '<tr class="total-row">';
                html += '<td>åˆè¨ˆ</td>';
                
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    const total = personData.yearlyTotal[year] || 0;
                    html += `<td>${total.toLocaleString()}</td>`;
                }
                html += `<td class="inheritance-date">${personData.inheritanceTotal.toLocaleString()}</td>`;
                html += '</tr></tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // è³‡é‡‘ç§»å‹•ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function updateTransfersView() {
            const container = document.getElementById('transfers-content');
            const transfers = systemData.processedData.transfers;
            const suspicious = systemData.processedData.suspiciousTransfers;
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="alert-card info"><h3>è³‡é‡‘ç§»å‹•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</h3></div>';
                return;
            }
            
            let html = `
                <div class="alert-card ${suspicious.length > 0 ? 'danger' : 'warning'}">
                    <h3>ğŸ’¸ è³‡é‡‘ç§»å‹•åˆ†æçµæœï¼ˆ${transfers.length}ä»¶ï¼‰</h3>
                    <p>è¨­å®šæœŸé–“å†…ï¼ˆ${document.getElementById('transferDays').value}æ—¥ä»¥å†…ï¼‰ã§é‡‘é¡èª¤å·®${document.getElementById('transferErrorRate').value}%ä»¥å†…ã®å…¥å‡ºé‡‘ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚</p>
                    ${suspicious.length > 0 ? `<p style="color: #c62828; font-weight: 600;">â˜… ç‰¹ã«æ³¨æ„ãŒå¿…è¦ãªè³‡é‡‘ç§»å‹•ãŒ${suspicious.length}ä»¶æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</p>` : ''}
                </div>
            `;
            
            if (suspicious.length > 0) {
                html += `
                    <div class="info-card danger-highlight">
                        <h4>âš ï¸ è¦æ³¨æ„è³‡é‡‘ç§»å‹•</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>å‡ºé‡‘æ—¥</th>
                                        <th>é€é‡‘è€…</th>
                                        <th>å—å–äºº</th>
                                        <th>é–¢ä¿‚</th>
                                        <th>é‡‘é¡</th>
                                        <th>å…¥é‡‘æ—¥</th>
                                        <th>æ—¥æ•°</th>
                                        <th>èª¤å·®</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                suspicious.forEach(transfer => {
                    html += `
                        <tr class="danger-highlight">
                            <td>${transfer.date}</td>
                            <td>${transfer.from}</td>
                            <td>${transfer.to}</td>
                            <td>${transfer.isFamily ? '<span class="annotation-badge badge-cohabit">å®¶æ—</span>' : '-'}</td>
                            <td class="text-right">${transfer.amount.toLocaleString()}å††</td>
                            <td>${transfer.depositDate}</td>
                            <td class="text-center">${transfer.daysDiff}æ—¥</td>
                            <td class="text-center">${(transfer.amountDiffRate * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            html += `
                <div class="info-card">
                    <h4>å…¨è³‡é‡‘ç§»å‹•ä¸€è¦§</h4>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å‡ºé‡‘æ—¥</th>
                                    <th>é€é‡‘è€…</th>
                                    <th>é€é‡‘å…ƒ</th>
                                    <th>å—å–äºº</th>
                                    <th>å—å–å…ˆ</th>
                                    <th>é‡‘é¡</th>
                                    <th>å…¥é‡‘æ—¥</th>
                                    <th>èª¤å·®</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            transfers.forEach(transfer => {
                const isSuspicious = suspicious.some(s => 
                    s.date === transfer.date && 
                    s.from === transfer.from && 
                    s.to === transfer.to
                );
                
                html += `
                    <tr ${isSuspicious ? 'class="highlight-row"' : ''}>
                        <td>${transfer.date}</td>
                        <td>${transfer.from}</td>
                        <td>${transfer.fromBank}</td>
                        <td>${transfer.to}</td>
                        <td>${transfer.toBank}</td>
                        <td class="text-right">${transfer.amount.toLocaleString()}å††</td>
                        <td>${transfer.depositDate}</td>
                        <td class="text-right">${transfer.amountDiff.toLocaleString()}å††</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // åŸè³‡ä¸æ˜ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function updateUnknownView() {
            const container = document.getElementById('unknown-content');
            const unknownSources = systemData.processedData.unknownSources;
            
            if (unknownSources.length === 0) {
                container.innerHTML = '<div class="alert-card success"><h3>åŸè³‡ä¸æ˜ã®å–å¼•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</h3></div>';
                return;
            }
            
            // ç†ç”±åˆ¥ã«åˆ†é¡
            const byReason = {};
            unknownSources.forEach(tx => {
                if (!byReason[tx.reason]) {
                    byReason[tx.reason] = [];
                }
                byReason[tx.reason].push(tx);
            });
            
            let html = `
                <div class="alert-card danger">
                    <h3>â“ åŸè³‡ä¸æ˜å–å¼•ï¼ˆ${unknownSources.length}ä»¶ï¼‰</h3>
                    <p>å…¥é‡‘å…ƒãŒä¸æ˜ã¾ãŸã¯ç¢ºèªãŒå¿…è¦ãªå–å¼•ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
            `;
            
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `<li>${reason}ï¼š<strong>${txs.length}</strong>ä»¶</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            // ç†ç”±åˆ¥è©³ç´°
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `
                    <div class="info-card">
                        <h4>${reason}ï¼ˆ${txs.length}ä»¶ï¼‰</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æ—¥ä»˜</th>
                                        <th>æ°å</th>
                                        <th>éŠ€è¡Œãƒ»æ”¯åº—</th>
                                        <th>é‡‘é¡</th>
                                        <th>æ®‹é«˜</th>
                                        <th>ç‰¹è¨˜äº‹é …</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                txs.forEach(tx => {
                    const specialNotes = [];
                    if (tx.flags.includes('ç›¸ç¶šå‰å¾Œ')) specialNotes.push('ç›¸ç¶šå‰å¾Œ');
                    if (tx.flags.includes('æœªæˆå¹´')) specialNotes.push('æœªæˆå¹´');
                    if (tx.flags.includes('è¢«ç›¸ç¶šäººåŒå±…')) specialNotes.push('åŒå±…');
                    
                    html += `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.name}</td>
                            <td>${tx.bank} ${tx.branch}</td>
                            <td class="text-right">${tx.deposit.toLocaleString()}å††</td>
                            <td class="text-right">${tx.balance.toLocaleString()}å††</td>
                            <td>
                                ${specialNotes.map(note => 
                                    `<span class="annotation-badge badge-${note === 'ç›¸ç¶šå‰å¾Œ' ? 'inheritance-period' : note === 'æœªæˆå¹´' ? 'minor' : 'cohabit'}">${note}</span>`
                                ).join(' ')}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // ä½æ‰€å±¥æ­´ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function updateAddressView() {
            const container = document.getElementById('addresses-content');
            const inheritanceDate = systemData.inheritanceDate;
            const deceased = systemData.family.find(f => f.isDeceased);
            const deceasedInhAddr = deceased ? getAddressAtDate(deceased.name, inheritanceDate) : null;
            
            let html = '<h3 style="margin: 20px 0;">ğŸ  ä½æ‰€ç§»è»¢çŠ¶æ³ä¸€è¦§</h3>';
            
            // ç›¸ç¶šé–‹å§‹æ™‚ã®åŒå±…çŠ¶æ³ã‚µãƒãƒªãƒ¼
            if (deceased && deceasedInhAddr) {
                const cohabitants = [];
                systemData.family.forEach(person => {
                    if (!person.isDeceased) {
                        const addr = getAddressAtDate(person.name, inheritanceDate);
                        if (addr === deceasedInhAddr) {
                            cohabitants.push(person.name);
                        }
                    }
                });
                
                if (cohabitants.length > 0) {
                    html += `
                        <div class="alert-card warning">
                            <h4>ç›¸ç¶šé–‹å§‹æ™‚ã®åŒå±…çŠ¶æ³</h4>
                            <p>è¢«ç›¸ç¶šäººï¼ˆ${deceased.name}ï¼‰ã¨åŒå±…ã—ã¦ã„ãŸç›¸ç¶šäººï¼š<strong>${cohabitants.join('ã€')}</strong></p>
                            <p>ä½æ‰€ï¼š${deceasedInhAddr}</p>
                        </div>
                    `;
                }
            }
            
            // å„äººã®ä½æ‰€å±¥æ­´
            systemData.family.forEach(person => {
                const addresses = systemData.addresses.filter(a => a.name === person.name);
                if (addresses.length === 0) return;
                
                const cardClass = person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${person.name} ï¼ˆ${person.relationship}ï¼‰</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æœŸé–“</th>
                                        <th>ä½æ‰€</th>
                                        <th>å±…ä½å¹´æ•°</th>
                                        <th>ç›¸ç¶šæ™‚</th>
                                        <th>å‚™è€ƒ</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                addresses.forEach(addr => {
                    const start = new Date(addr.startDate);
                    const end = addr.endDate ? new Date(addr.endDate) : new Date();
                    const years = Math.floor((end - start) / (365.25 * 24 * 60 * 60 * 1000));
                    const months = Math.floor(((end - start) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
                    
                    const isCurrent = !addr.endDate;
                    const inhDate = new Date(inheritanceDate);
                    const wasLivingHereDuringInheritance = start <= inhDate && (addr.endDate ? new Date(addr.endDate) >= inhDate : true);
                    
                    const isSameAsDeceased = deceased && deceasedInhAddr === addr.address && wasLivingHereDuringInheritance;
                    
                    html += `
                        <tr ${wasLivingHereDuringInheritance ? 'class="highlight-row"' : ''}>
                            <td>${addr.startDate} ï½ ${addr.endDate || 'ç¾åœ¨'}</td>
                            <td>${addr.address}</td>
                            <td>${years}å¹´${months > 0 ? `${months}ãƒ¶æœˆ` : ''}</td>
                            <td>${wasLivingHereDuringInheritance ? 'â—‹' : '-'}</td>
                            <td>
                                ${isCurrent ? '<span class="annotation-badge badge-account-open">ç¾ä½æ‰€</span>' : ''}
                                ${isSameAsDeceased ? '<span class="annotation-badge badge-cohabit">è¢«ç›¸ç¶šäººåŒå±…</span>' : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // æ³¨è¨˜ä»˜ãæ˜ç´°ãƒ“ãƒ¥ãƒ¼
        function updateAnnotatedView() {
            const container = document.getElementById('annotated-content');
            
            let html = `
                <h3 style="margin: 20px 0;">ğŸ“ æ³¨è¨˜ä»˜ãå–å¼•æ˜ç´°</h3>
                <div class="alert-card info">
                    <p>â˜…ãƒãƒ¼ã‚¯ãŒä»˜ã„ãŸé …ç›®ã¯ç›¸ç¶šç¨èª¿æŸ»ã«ãŠã„ã¦ç‰¹ã«æ³¨æ„ãŒå¿…è¦ãªå–å¼•ã§ã™ã€‚</p>
                    <p>ã“ã®ä¸€è¦§ã¯å…ƒãƒ‡ãƒ¼ã‚¿ã«æ³¨è¨˜ã‚’è¿½åŠ ã—ãŸã‚‚ã®ã§ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã§å‡ºåŠ›ã§ãã¾ã™ã€‚</p>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table" style="min-width: 1200px;">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>æ™‚åˆ»</th>
                                <th>æ°å</th>
                                <th>éŠ€è¡Œ</th>
                                <th>æ”¯åº—</th>
                                <th>ç§‘ç›®</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>å‡ºé‡‘</th>
                                <th>å…¥é‡‘</th>
                                <th>æ®‹é«˜</th>
                                <th>æ‘˜è¦</th>
                                <th style="min-width: 300px;">æ³¨è¨˜</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // æ³¨è¨˜ãŒã‚ã‚‹å–å¼•ã®ã¿è¡¨ç¤º
            systemData.transactions.filter(tx => tx.annotations.length > 0).forEach(tx => {
                const rowClass = tx.annotations.some(a => a.includes('è¦æ³¨æ„')) ? 'danger-highlight' : 'highlight-row';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${tx.date}</td>`;
                html += `<td>${tx.time || ''}</td>`;
                html += `<td>${tx.name}</td>`;
                html += `<td>${tx.bank}</td>`;
                html += `<td>${tx.branch}</td>`;
                html += `<td>${tx.accountType}</td>`;
                html += `<td>${tx.accountNumber}</td>`;
                html += `<td class="text-right">${tx.withdrawal > 0 ? tx.withdrawal.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.deposit > 0 ? tx.deposit.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.balance > 0 ? tx.balance.toLocaleString() : ''}</td>`;
                html += `<td>${tx.description}</td>`;
                html += `<td style="font-weight: 600; color: #c62828;">${tx.annotations.join(' / ')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // å®¶ç³»å›³ãƒ“ãƒ¥ãƒ¼
        function updateFamilyView() {
            const container = document.getElementById('family-content');
            const inheritanceDate = systemData.inheritanceDate;
            
            let html = '<div class="family-tree-wrapper">';
            html += '<h2 class="family-tree-title">ç›¸ç¶šé–¢ä¿‚å›³</h2>';
            html += '<div class="family-tree">';
            
            // ç°¡æ˜“çš„ãªå®¶ç³»å›³ï¼ˆå®Ÿè£…ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«æ”¹è‰¯ï¼‰
            const deceased = systemData.family.find(f => f.isDeceased);
            const spouse = systemData.family.find(f => f.relationship.includes('é…å¶è€…'));
            const children = systemData.family.filter(f => 
                f.relationship.includes('é•·ç”·') || 
                f.relationship.includes('æ¬¡ç”·') || 
                f.relationship.includes('ä¸‰ç”·') ||
                f.relationship.includes('é•·å¥³') || 
                f.relationship.includes('æ¬¡å¥³') || 
                f.relationship.includes('ä¸‰å¥³') ||
                (f.relationship.includes('å­') && !f.relationship.includes('å­«'))
            );
            
            // è¢«ç›¸ç¶šäººä¸–ä»£
            html += '<div class="generation">';
            html += '<div class="generation-label">è¢«ç›¸ç¶šäººä¸–ä»£</div>';
            
            if (deceased) {
                html += createFamilyMemberCard(deceased, inheritanceDate);
            }
            if (spouse) {
                html += createFamilyMemberCard(spouse, inheritanceDate);
            }
            
            html += '</div>';
            
            // å­ä¸–ä»£
            if (children.length > 0) {
                html += '<div class="generation">';
                html += '<div class="generation-label">å­ä¸–ä»£</div>';
                
                children.forEach(child => {
                    html += createFamilyMemberCard(child, inheritanceDate);
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }
        
        // å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ä½œæˆ
        function createFamilyMemberCard(person, inheritanceDate) {
            const currentAge = person.birthDate ? calculateAge(person.birthDate, new Date()) : null;
            const inhAge = person.ageAtInheritance || (person.birthDate ? calculateAge(person.birthDate, inheritanceDate) : null);
            const currentAddress = getAddressAtDate(person.name, new Date());
            const inhAddress = getAddressAtDate(person.name, inheritanceDate);
            
            const deceased = systemData.family.find(f => f.isDeceased);
            const isSameAddressCurrent = deceased && currentAddress === getAddressAtDate(deceased.name, new Date());
            const isSameAddressInh = deceased && inhAddress === getAddressAtDate(deceased.name, inheritanceDate);
            
            let html = `
                <div class="family-member ${person.isDeceased ? 'deceased' : ''} ${person.gender || 'unknown'}">
                    <div class="member-name">${person.name}</div>
                    <div class="member-info">
                        <div class="member-info-row">
                            <span class="member-info-label">ç¶šæŸ„ï¼š</span>
                            <span>${person.relationship}</span>
                        </div>
                        <div class="member-info-row">
                            <span class="member-info-label">ç”Ÿå¹´æœˆæ—¥ï¼š</span>
                            <span>${person.birthDate || 'ä¸æ˜'}</span>
                        </div>
                        ${inhAge !== null ? `
                        <div class="member-info-row">
                            <span class="member-info-label">ç›¸ç¶šæ™‚å¹´é½¢ï¼š</span>
                            <span>${inhAge}æ­³</span>
                        </div>
                        ` : ''}
                        ${!person.isDeceased && currentAge !== null ? `
                        <div class="member-info-row">
                            <span class="member-info-label">ç¾åœ¨å¹´é½¢ï¼š</span>
                            <span>${currentAge}æ­³</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="address-info">
                        <div style="font-weight: 600; margin-bottom: 8px;">ä½æ‰€æƒ…å ±</div>
                        ${inhAddress ? `
                        <div style="margin: 4px 0;">
                            <strong>ç›¸ç¶šæ™‚ï¼š</strong><br>
                            ${inhAddress}
                            ${isSameAddressInh ? '<span class="address-status same-address">åŒå±…</span>' : ''}
                        </div>
                        ` : ''}
                        ${!person.isDeceased && currentAddress ? `
                        <div style="margin: 4px 0;">
                            <strong>ç¾åœ¨ï¼š</strong><br>
                            ${currentAddress}
                            ${isSameAddressCurrent ? '<span class="address-status same-address">åŒå±…</span>' : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }
        
        // çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆã‚µãƒãƒªãƒ¼ï¼‰
        function exportResults() {
            const inheritanceDate = systemData.inheritanceDate;
            
            let csv = '\uFEFF'; // BOM
            csv += 'ç›¸ç¶šç¨èª¿æŸ»åˆ†æã‚·ã‚¹ãƒ†ãƒ  åˆ†æçµæœ\n';
            csv += `åˆ†ææ—¥æ™‚,${new Date().toLocaleString('ja-JP')}\n`;
            csv += `ç›¸ç¶šé–‹å§‹æ—¥,${inheritanceDate}\n\n`;
            
            // è¦æ³¨æ„å–å¼•
            csv += 'ã€è¦æ³¨æ„å–å¼•ä¸€è¦§ã€‘\n';
            csv += 'æ—¥ä»˜,æ™‚åˆ»,æ°å,éŠ€è¡Œ,æ”¯åº—,å‡ºé‡‘,å…¥é‡‘,æ®‹é«˜,æ‘˜è¦,ãƒ•ãƒ©ã‚°,æ³¨è¨˜\n';
            
            systemData.transactions.filter(tx => tx.flags.length > 0).forEach(tx => {
                csv += `"${tx.date}","${tx.time || ''}","${tx.name}","${tx.bank}","${tx.branch}",`;
                csv += `${tx.withdrawal},${tx.deposit},${tx.balance},"${tx.description}","${tx.flags.join('ãƒ»')}","${tx.annotations.join(' / ')}"\n`;
            });
            
            csv += '\nã€è³‡é‡‘ç§»å‹•ã€‘\n';
            csv += 'å‡ºé‡‘æ—¥,é€é‡‘è€…,å—å–äºº,é‡‘é¡,å…¥é‡‘æ—¥,æ—¥æ•°å·®,é‡‘é¡å·®,å®¶æ—é–“\n';
            systemData.processedData.transfers.forEach(t => {
                csv += `"${t.date}","${t.from}","${t.to}",${t.amount},"${t.depositDate}",${t.daysDiff},${t.amountDiff},${t.isFamily ? 'â—‹' : ''}\n`;
            });
            
            csv += '\nã€åŸè³‡ä¸æ˜å–å¼•ã€‘\n';
            csv += 'æ—¥ä»˜,æ°å,éŠ€è¡Œ,é‡‘é¡,æ‘˜è¦,ç†ç”±\n';
            systemData.processedData.unknownSources.forEach(tx => {
                csv += `"${tx.date}","${tx.name}","${tx.bank} ${tx.branch}",${tx.deposit},"${tx.description}","${tx.reason}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç›¸ç¶šç¨èª¿æŸ»çµæœ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('åˆ†æçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }
        
        // æ³¨è¨˜ä»˜ãå…ƒãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAnnotatedData() {
            let csv = '\uFEFF'; // BOM
            csv += 'éŠ€è¡Œå,æ”¯åº—å,æ°å,ç§‘ç›®,å£åº§ç•ªå·,æ—¥ä»˜,æ™‚åˆ»,å‡ºé‡‘,å…¥é‡‘,å–æ‰±åº—,æ©Ÿç•ª,æ‘˜è¦,æ®‹é«˜,æ³¨è¨˜\n';
            
            systemData.transactions.forEach(tx => {
                csv += `"${tx.bank}","${tx.branch}","${tx.name}","${tx.accountType}","${tx.accountNumber}",`;
                csv += `"${tx.date}","${tx.time || ''}",${tx.withdrawal || ''},${tx.deposit || ''},`;
                csv += `"${tx.location}","${tx.machineId}","${tx.description}",${tx.balance || ''},`;
                csv += `"${tx.annotations.join(' / ')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æ³¨è¨˜ä»˜ãå–å¼•æ˜ç´°_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('æ³¨è¨˜ä»˜ãå…ƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }
    </script>
</body>
</html>