<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸ç¶šç¨èª¿æŸ»åˆ†æã‚·ã‚¹ãƒ†ãƒ  v3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Yu Gothic', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            transform: rotate(30deg);
            pointer-events: none;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .upload-section {
            padding: 40px;
            background: #fafbfc;
            border-bottom: 2px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .file-input-group {
            background: white;
            padding: 30px;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-group:hover {
            border-color: #3498db;
            background: #f8fbff;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.15);
        }
        
        .file-input-group.uploaded {
            border-color: #27ae60;
            border-style: solid;
            background: #f0fdf4;
        }
        
        .file-input-group.uploaded::after {
            content: 'âœ“';
            position: absolute;
            top: 15px;
            right: 15px;
            color: #27ae60;
            font-size: 28px;
            font-weight: bold;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            background: #f8f9fa;
            font-size: 15px;
        }
        
        .file-label {
            display: block;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        
        .file-description {
            font-size: 0.9em;
            color: #718096;
            line-height: 1.6;
            margin-bottom: 12px;
            text-align: left;
        }
        
        .file-status {
            margin-top: 15px;
            font-size: 0.95em;
            color: #27ae60;
            font-weight: 600;
            display: none;
        }
        
        .config-section {
            margin-top: 35px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .config-item label {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-item input, .config-item select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #7f8c8d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5f6a6a;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin: 25px 0 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                45deg,
                rgba(255,255,255,0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.2) 50%,
                rgba(255,255,255,0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progress-animation 1s linear infinite;
        }
        
        @keyframes progress-animation {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }
        
        .status-message {
            padding: 16px 24px;
            border-radius: 8px;
            margin: 25px 0;
            font-weight: 600;
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-15px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .status-success { 
            background: #d5f4e6; 
            color: #27ae60; 
            border: 2px solid #a9dfbf;
            border-left: 5px solid #27ae60;
        }
        
        .status-error { 
            background: #fadbd8; 
            color: #e74c3c; 
            border: 2px solid #f5b7b1;
            border-left: 5px solid #e74c3c;
        }
        
        .status-warning { 
            background: #fef5e7; 
            color: #f39c12; 
            border: 2px solid #fad7a0;
            border-left: 5px solid #f39c12;
        }
        
        .status-info { 
            background: #d6eaf8; 
            color: #2980b9; 
            border: 2px solid #aed6f1;
            border-left: 5px solid #3498db;
        }
        
        .analysis-container {
            padding: 40px;
            display: none;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 3px solid #e9ecef;
            margin-bottom: 35px;
            overflow-x: auto;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            padding: 8px;
            gap: 8px;
        }
        
        .tab {
            padding: 16px 28px;
            background: transparent;
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: 700;
            color: #7f8c8d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border-radius: 8px 8px 0 0;
            position: relative;
            flex-shrink: 0;
        }
        
        .tab:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .tab.active {
            background: white;
            color: #3498db;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
        }
        
        .tab-content {
            display: none;
            min-height: 500px;
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* ã‚«ãƒ¼ãƒ‰å‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
        .info-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .info-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-card {
            padding: 20px 30px;
            margin: 25px 0;
            border-radius: 12px;
            border-left: 6px solid;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .alert-card.warning {
            background: #fef5e7;
            color: #f39c12;
            border-color: #f39c12;
        }
        
        .alert-card.danger {
            background: #fadbd8;
            color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .alert-card.info {
            background: #d6eaf8;
            color: #2980b9;
            border-color: #3498db;
        }
        
        .alert-card.success {
            background: #d5f4e6;
            color: #27ae60;
            border-color: #27ae60;
        }
        
        /* ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« */
        .data-table-wrapper {
            overflow-x: auto;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 700px;
        }
        
        .data-table th {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 16px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 15px;
            border-bottom: 3px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f3f6;
            font-size: 15px;
        }
        
        .data-table tr:hover {
            background: #f8fbff;
        }
        
        .data-table tr.highlighted {
            background: #fef5e7;
            font-weight: 600;
        }
        
        /* æ³¨è¨˜ãƒ»ãƒ•ãƒ©ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ */
        .annotation-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 700;
            margin: 3px;
            white-space: nowrap;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        /* é‡‘é¡é–¢é€£ï¼ˆèµ¤ç³»ï¼‰ */
        .badge-large-amount {
            background: #fee;
            color: #c00;
            border: 2px solid #fcc;
        }
        
        .badge-unknown-source {
            background: #fdd;
            color: #a00;
            border: 2px solid #fbb;
        }
        
        /* è³‡é‡‘ç§»å‹•é–¢é€£ï¼ˆé’ç³»ï¼‰ */
        .badge-money-shift {
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #90caf9;
        }
        
        .badge-suspicious-shift {
            background: #bbdefb;
            color: #0d47a1;
            border: 2px solid #64b5f6;
        }
        
        /* æ™‚æœŸé–¢é€£ï¼ˆæ©™ç³»ï¼‰ */
        .badge-inheritance-period {
            background: #fff3e0;
            color: #e65100;
            border: 2px solid #ffcc80;
        }
        
        /* å£åº§é–¢é€£ï¼ˆç·‘ç³»ï¼‰ */
        .badge-account-open {
            background: #e8f5e9;
            color: #1b5e20;
            border: 2px solid #81c784;
        }
        
        .badge-account-close {
            background: #fce4ec;
            color: #880e4f;
            border: 2px solid #f48fb1;
        }
        
        /* äººç‰©é–¢é€£ï¼ˆç´«ç³»ï¼‰ */
        .badge-minor {
            background: #f3e5f5;
            color: #4a148c;
            border: 2px solid #ba68c8;
        }
        
        .badge-cohabit {
            background: #e8eaf6;
            color: #283593;
            border: 2px solid #7986cb;
        }
        
        /* ãã®ä»–ï¼ˆé»„ç³»ï¼‰ */
        .badge-blank-memo {
            background: #fffde7;
            color: #f57f17;
            border: 2px solid #fff176;
        }
        
        /* æ®‹é«˜æ¨ç§»è¡¨ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ */
        .balance-table-wrapper {
            overflow-x: auto;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .balance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 900px;
        }
        
        .balance-table th {
            background: #2c3e50;
            color: white;
            padding: 16px 14px;
            text-align: center;
            font-weight: 700;
            font-size: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .balance-table td {
            padding: 14px;
            text-align: right;
            border: 1px solid #f0f3f6;
            font-size: 15px;
        }
        
        .balance-table tr:nth-child(even) {
            background: #fafbfc;
        }
        
        .balance-table tr:hover {
            background: #e3f2fd;
        }
        
        .balance-table .person-name {
            font-weight: 700;
            text-align: left;
            background: #f8f9fa;
            color: #2c3e50;
        }
        
        .balance-table .account-row {
            padding-left: 35px;
            text-align: left;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .balance-table .total-row {
            font-weight: 700;
            background: #e8f5e9;
            border-top: 3px solid #27ae60;
        }
        
        .balance-table .inheritance-date {
            background: #2c3e50;
            color: white;
            font-weight: 700;
        }
        
        .balance-positive {
            color: #27ae60;
            font-weight: 700;
        }
        
        .balance-negative {
            color: #e74c3c;
            font-weight: 700;
        }
        
        .balance-change {
            font-size: 12px;
            color: #7f8c8d;
            display: block;
            margin-top: 3px;
        }
        
        .balance-interpolated {
            font-style: italic;
            color: #9b59b6;
        }
        
        /* å®¶ç³»å›³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ */
        .family-tree-wrapper {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 50px;
            margin: 25px 0;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .family-tree-title {
            text-align: center;
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 50px;
            color: #2c3e50;
        }
        
        .family-tree-svg {
            width: 100%;
            min-height: 700px;
            display: block;
        }
        
        .member-box {
            fill: white;
            stroke: #3498db;
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .member-box:hover {
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.2));
        }
        
        .member-box.deceased {
            fill: #fadbd8;
            stroke: #e74c3c;
        }
        
        .member-box.male {
            /* ç”·æ€§ã¯è§’å¼µã£ãŸå››è§’å½¢ */
        }
        
        .member-box.female {
            rx: 35;
            ry: 35;
        }
        
        .member-text {
            font-family: 'Yu Gothic', 'Meiryo', sans-serif;
            font-size: 15px;
            fill: #34495e;
        }
        
        .member-name {
            font-weight: 800;
            font-size: 18px;
            fill: #2c3e50;
        }
        
        .relation-line {
            stroke: #95a5a6;
            stroke-width: 3;
            fill: none;
        }
        
        .spouse-line {
            stroke: #e91e63;
            stroke-width: 4;
        }
        
        /* åˆ¤å®šåŸºæº–èª¬æ˜ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ */
        .criteria-explanation {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .criteria-explanation h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .criteria-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .criteria-category {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .criteria-category h5 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .criteria-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .criteria-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px;
            background: #fafbfc;
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        .criteria-badge {
            flex-shrink: 0;
        }
        
        /* ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰ */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }
        
        /* å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body {
                padding: 0;
                background: white;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .btn, .file-input-group, .config-section {
                display: none !important;
            }
            
            .tab-container {
                display: none;
            }
            
            .tab-content {
                display: block !important;
                page-break-after: always;
            }
            
            .data-table {
                font-size: 11px;
            }
            
            @page {
                size: A3 landscape;
                margin: 15mm;
            }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .file-grid, .config-grid {
                grid-template-columns: 1fr;
            }
            
            .tab {
                font-size: 14px;
                padding: 12px 20px;
            }
            
            .data-table {
                font-size: 13px;
            }
            
            .data-table th, .data-table td {
                padding: 10px;
            }
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 6px solid #ecf0f1;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .highlight-row {
            background: #fef5e7 !important;
            font-weight: 700;
        }
        
        .danger-highlight {
            background: #fadbd8 !important;
            color: #e74c3c;
        }
        
        .success-highlight {
            background: #d5f4e6 !important;
            color: #27ae60;
        }
        
        /* ä¿¡é ¼åº¦è¡¨ç¤ºï¼ˆæ–°è¦è¿½åŠ ï¼‰ */
        .confidence-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .confidence-high {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .confidence-medium {
            background: #fef5e7;
            color: #f39c12;
        }
        
        .confidence-low {
            background: #fadbd8;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...</div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ç›¸ç¶šç¨èª¿æŸ»åˆ†æã‚·ã‚¹ãƒ†ãƒ  v3</h1>
            <p>é«˜ç²¾åº¦ãªè³‡é‡‘ç§»å‹•æ¤œå‡ºã¨å®¶æ—é–¢ä¿‚åˆ†æã«ã‚ˆã‚Šã€ç›¸ç¶šç¨èª¿æŸ»ã«å¿…è¦ãªç¶²ç¾…çš„åˆ†æã‚’å®Ÿæ–½ã—ã¾ã™</p>
        </div>
        
        <div class="upload-section">
            <h2 class="section-title">ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <div class="file-grid">
                <div class="file-input-group" id="group1">
                    <label class="file-label">ğŸ“Š å…ƒãƒ‡ãƒ¼ã‚¿ï¼ˆå–å¼•ãƒ‡ãƒ¼ã‚¿ï¼‰</label>
                    <p class="file-description">
                        Aåˆ—:éŠ€è¡Œå Båˆ—:æ”¯åº—å Cåˆ—:æ°å Dåˆ—:ç§‘ç›®<br>
                        Eåˆ—:å£åº§ç•ªå· Fåˆ—:æ—¥ä»˜ Gåˆ—:æ™‚åˆ» Håˆ—:å‡ºé‡‘<br>
                        Iåˆ—:å…¥é‡‘ Jåˆ—:å–æ‰±åº— Kåˆ—:æ©Ÿç•ª Låˆ—:æ‘˜è¦ Måˆ—:æ®‹é«˜
                    </p>
                    <input type="file" class="file-input" id="transactionFile" accept=".csv">
                    <div class="file-status" id="status1"></div>
                </div>
                
                <div class="file-input-group" id="group2">
                    <label class="file-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—æ§‹æˆ</label>
                    <p class="file-description">
                        Aåˆ—:æ°å Båˆ—:ç¶šæŸ„ Cåˆ—:ç”Ÿå¹´æœˆæ—¥<br>
                        Dåˆ—:ç›¸ç¶šé–‹å§‹æ—¥ï¼ˆè¢«ç›¸ç¶šäººã¯æ—¥ä»˜ã€ä»–ã¯å¹´é½¢ï¼‰
                    </p>
                    <input type="file" class="file-input" id="familyFile" accept=".csv">
                    <div class="file-status" id="status2"></div>
                </div>
                
                <div class="file-input-group" id="group3">
                    <label class="file-label">ğŸ  ä½æ‰€å±¥æ­´</label>
                    <p class="file-description">
                        Aåˆ—:æ°å Båˆ—:ä½æ‰€<br>
                        Cåˆ—:å±…ä½é–‹å§‹æ—¥ Dåˆ—:å±…ä½çµ‚äº†æ—¥
                    </p>
                    <input type="file" class="file-input" id="addressFile" accept=".csv">
                    <div class="file-status" id="status3"></div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <p id="progressText" style="color: #7f8c8d; font-weight: 600;">0/3 ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ</p>
            
            <div class="config-section">
                <h3 class="section-title" style="font-size: 1.3em;">âš™ï¸ åˆ†æè¨­å®š</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <label>
                            <span>ğŸ“…</span> åˆ†æåŸºæº–å¹´
                        </label>
                        <select id="baseYear">
                            <option value="2024" selected>2024å¹´</option>
                            <option value="2023">2023å¹´</option>
                            <option value="2022">2022å¹´</option>
                            <option value="2021">2021å¹´</option>
                            <option value="2020">2020å¹´</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>
                            <span>ğŸ’°</span> å¤§é¡å–å¼•åŸºæº–é¡
                        </label>
                        <input type="number" id="largeAmountThreshold" value="1000000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>â“</span> åŸè³‡ä¸æ˜åŸºæº–é¡
                        </label>
                        <input type="number" id="unknownSourceThreshold" value="500000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>ğŸ”„</span> è³‡é‡‘ç§»å‹•æ¤œå‡ºæ—¥æ•°
                        </label>
                        <input type="number" id="transferDays" value="7" min="1" max="30">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>ğŸ“Š</span> è³‡é‡‘ç§»å‹•èª¤å·®ç‡(%)
                        </label>
                        <input type="number" id="transferErrorRate" value="10" min="0" max="50">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>âš ï¸</span> ç›¸ç¶šå‰å¾ŒæœŸé–“(æ—¥)
                        </label>
                        <input type="number" id="inheritancePeriod" value="90" min="30" max="365">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>
                        ğŸ“Š åˆ†æé–‹å§‹
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                    </button>
                    <button class="btn btn-success hidden" id="exportBtn" onclick="exportResults()">
                        ğŸ’¾ çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-warning hidden" id="exportAnnotatedBtn" onclick="exportAnnotatedData()">
                        ğŸ“ æ³¨è¨˜ä»˜ãå…ƒãƒ‡ãƒ¼ã‚¿
                    </button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <div class="analysis-container" id="analysisContainer">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('summary')">ğŸ“‹ ç·æ‹¬</button>
                <button class="tab" onclick="showTab('balance')">ğŸ’° æ®‹é«˜æ¨ç§»è¡¨</button>
                <button class="tab" onclick="showTab('transfers')">ğŸ’¸ è³‡é‡‘ç§»å‹•åˆ†æ</button>
                <button class="tab" onclick="showTab('unknown')">â“ åŸè³‡ä¸æ˜å–å¼•</button>
                <button class="tab" onclick="showTab('addresses')">ğŸ  ä½æ‰€ç§»è»¢çŠ¶æ³</button>
                <button class="tab" onclick="showTab('annotated')">ğŸ“ æ³¨è¨˜ä»˜ãæ˜ç´°</button>
                <button class="tab" onclick="showTab('family')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç›¸ç¶šé–¢ä¿‚å›³</button>
            </div>
            
            <div id="summary-content" class="tab-content active"></div>
            <div id="balance-content" class="tab-content"></div>
            <div id="transfers-content" class="tab-content"></div>
            <div id="unknown-content" class="tab-content"></div>
            <div id="addresses-content" class="tab-content"></div>
            <div id="annotated-content" class="tab-content"></div>
            <div id="family-content" class="tab-content"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let uploadedFiles = {
            transaction: null,
            family: null,
            address: null
        };
        
        let systemData = {
            transactions: [],
            family: [],
            addresses: [],
            inheritanceDate: null,
            processedData: {
                balanceByPerson: {},
                transfers: [],
                suspiciousTransfers: [],
                unknownSources: [],
                annotations: new Map(),
                familyTree: null
            }
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupFileInputs();
            updateProgress();
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¨­å®š
        function setupFileInputs() {
            document.getElementById('transactionFile').addEventListener('change', e => handleFileSelect(e, 'transaction', 1));
            document.getElementById('familyFile').addEventListener('change', e => handleFileSelect(e, 'family', 2));
            document.getElementById('addressFile').addEventListener('change', e => handleFileSelect(e, 'address', 3));
            document.getElementById('analyzeBtn').addEventListener('click', processAllFiles);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event, type, groupNumber) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            uploadedFiles[type] = file;
            
            const group = document.getElementById(`group${groupNumber}`);
            const status = document.getElementById(`status${groupNumber}`);
            
            group.classList.add('uploaded');
            status.style.display = 'block';
            status.textContent = `âœ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            updateProgress();
        }
        
        // é€²æ—æ›´æ–°
        function updateProgress() {
            const uploadedCount = Object.values(uploadedFiles).filter(f => f !== null).length;
            const percentage = (uploadedCount / 3) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${uploadedCount}/3 ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ`;
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedCount !== 3;
            
            if (uploadedCount === 3) {
                showStatus('å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            uploadedFiles = { transaction: null, family: null, address: null };
            systemData = {
                transactions: [],
                family: [],
                addresses: [],
                inheritanceDate: null,
                processedData: {
                    balanceByPerson: {},
                    transfers: [],
                    suspiciousTransfers: [],
                    unknownSources: [],
                    annotations: new Map(),
                    familyTree: null
                }
            };
            
            document.querySelectorAll('.file-input').forEach(input => input.value = '');
            document.querySelectorAll('.file-input-group').forEach(group => group.classList.remove('uploaded'));
            document.querySelectorAll('.file-status').forEach(status => status.style.display = 'none');
            
            document.getElementById('analysisContainer').style.display = 'none';
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('exportAnnotatedBtn').classList.add('hidden');
            
            updateProgress();
            showStatus('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }
        
        // æ”¹è‰¯ç‰ˆCSVãƒ‘ãƒ¼ã‚µãƒ¼
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            let inQuotes = false;
            let currentLine = [];
            let currentValue = '';
            
            for (let line of lines) {
                if (!line.trim() && !inQuotes) continue;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        currentLine.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                if (!inQuotes) {
                    currentLine.push(currentValue.trim());
                    if (currentLine.length > 0 && currentLine.some(v => v)) {
                        result.push(currentLine);
                    }
                    currentLine = [];
                    currentValue = '';
                } else {
                    currentValue += '\n';
                }
            }
            
            return result;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        async function processAllFiles() {
            try {
                showLoading(true);
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...', 'info');
                
                // å–å¼•ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                const transactionText = await readFile(uploadedFiles.transaction);
                const transactionData = parseCSV(transactionText);
                systemData.transactions = parseTransactionData(transactionData);
                
                // å®¶æ—æ§‹æˆå‡¦ç†
                const familyText = await readFile(uploadedFiles.family);
                const familyData = parseCSV(familyText);
                systemData.family = parseFamilyData(familyData);
                
                // ä½æ‰€å±¥æ­´å‡¦ç†
                const addressText = await readFile(uploadedFiles.address);
                const addressData = parseCSV(addressText);
                systemData.addresses = parseAddressData(addressData);
                
                // ãƒ‡ãƒ¼ã‚¿åˆ†æå®Ÿè¡Œ
                await analyzeData();
                
                // çµæœè¡¨ç¤º
                document.getElementById('analysisContainer').style.display = 'block';
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('exportAnnotatedBtn').classList.remove('hidden');
                
                updateAllViews();
                showStatus('åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                // åˆ†æçµæœã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('analysisContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }
        
        // å–å¼•ãƒ‡ãƒ¼ã‚¿è§£æ
        function parseTransactionData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const transactions = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 13) {
                    transactions.push({
                        id: i,
                        bank: row[0] || '',
                        branch: row[1] || '',
                        name: row[2] || '',
                        accountType: row[3] || '',
                        accountNumber: row[4] || '',
                        date: row[5] || '',
                        time: row[6] || '',
                        withdrawal: parseFloat(row[7]) || 0,
                        deposit: parseFloat(row[8]) || 0,
                        location: row[9] || '',
                        machineId: row[10] || '',
                        description: row[11] || '',
                        balance: parseFloat(row[12]) || 0,
                        flags: [],
                        annotations: [],
                        confidence: 'high' // ä¿¡é ¼åº¦è¿½åŠ 
                    });
                }
            }
            
            return transactions.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare !== 0) return dateCompare;
                return (a.time || '00:00:00').localeCompare(b.time || '00:00:00');
            });
        }
        
        // å®¶æ—ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function parseFamilyData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const family = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 4) {
                    const member = {
                        name: row[0] || '',
                        relationship: row[1] || '',
                        birthDate: row[2] || '',
                        inheritanceInfo: row[3] || '',
                        parent: null,
                        children: [],
                        spouse: null
                    };
                    
                    // è¢«ç›¸ç¶šäººã®åˆ¤å®šã¨ç›¸ç¶šé–‹å§‹æ—¥ã®å–å¾—
                    if (member.relationship.includes('è¢«ç›¸ç¶šäºº')) {
                        member.isDeceased = true;
                        if (member.inheritanceInfo && member.inheritanceInfo.match(/\d{4}-\d{2}-\d{2}/)) {
                            systemData.inheritanceDate = member.inheritanceInfo;
                        }
                    } else {
                        const ageMatch = member.inheritanceInfo.match(/(\d+)æ­³?/);
                        if (ageMatch) {
                            member.ageAtInheritance = parseInt(ageMatch[1]);
                        }
                    }
                    
                    // æ€§åˆ¥æ¨å®š
                    const rel = member.relationship;
                    if (rel.includes('å¤«') || rel.includes('çˆ¶') || rel.includes('ç”·') || 
                        rel.includes('æ¯å­') || rel.includes('é•·ç”·') || rel.includes('æ¬¡ç”·') || rel.includes('ä¸‰ç”·')) {
                        member.gender = 'male';
                    } else if (rel.includes('å¦»') || rel.includes('æ¯') || rel.includes('å¥³') || 
                               rel.includes('å¨˜') || rel.includes('é•·å¥³') || rel.includes('æ¬¡å¥³') || rel.includes('ä¸‰å¥³')) {
                        member.gender = 'female';
                    } else {
                        member.gender = 'unknown';
                    }
                    
                    // ä¸–ä»£åˆ¤å®š
                    if (member.isDeceased || rel.includes('é…å¶è€…')) {
                        member.generation = 0;
                    } else if (rel.includes('é•·ç”·') || rel.includes('æ¬¡ç”·') || rel.includes('ä¸‰ç”·') ||
                               rel.includes('é•·å¥³') || rel.includes('æ¬¡å¥³') || rel.includes('ä¸‰å¥³') ||
                               (rel.includes('å­') && !rel.includes('å­«'))) {
                        member.generation = 1;
                    } else if (rel.includes('å­«')) {
                        member.generation = 2;
                        const parentMatch = rel.match(/(.+)ã®å­/);
                        if (parentMatch) {
                            member.parentRelation = parentMatch[1];
                        }
                    } else {
                        member.generation = 3;
                    }
                    
                    family.push(member);
                }
            }
            
            buildFamilyRelations(family);
            return family;
        }
        
        // å®¶æ—é–¢ä¿‚æ§‹ç¯‰
        function buildFamilyRelations(family) {
            const deceased = family.find(f => f.isDeceased);
            if (!deceased) return;
            
            const spouse = family.find(f => f.relationship.includes('é…å¶è€…'));
            if (spouse) {
                deceased.spouse = spouse.name;
                spouse.spouse = deceased.name;
            }
            
            family.forEach(member => {
                if (member.generation === 1) {
                    member.parent = deceased.name;
                    if (!deceased.children) deceased.children = [];
                    deceased.children.push(member.name);
                    
                    if (spouse) {
                        if (!spouse.children) spouse.children = [];
                        spouse.children.push(member.name);
                    }
                } else if (member.generation === 2 && member.parentRelation) {
                    const parent = family.find(f => f.relationship.includes(member.parentRelation));
                    if (parent) {
                        member.parent = parent.name;
                        if (!parent.children) parent.children = [];
                        parent.children.push(member.name);
                    }
                }
            });
        }
        
        // ä½æ‰€ãƒ‡ãƒ¼ã‚¿è§£æ
        function parseAddressData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const addresses = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 3) {
                    addresses.push({
                        name: row[0] || '',
                        address: row[1] || '',
                        startDate: row[2] || '',
                        endDate: row[3] || ''
                    });
                }
            }
            
            const peopleNames = [...new Set(addresses.map(a => a.name))];
            peopleNames.forEach(name => {
                const personAddresses = addresses
                    .filter(a => a.name === name)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                for (let i = 0; i < personAddresses.length - 1; i++) {
                    if (!personAddresses[i].endDate) {
                        const nextStartDate = new Date(personAddresses[i + 1].startDate);
                        nextStartDate.setDate(nextStartDate.getDate() - 1);
                        personAddresses[i].endDate = nextStartDate.toISOString().split('T')[0];
                    }
                }
            });
            
            return addresses;
        }
        
        // ãƒ‡ãƒ¼ã‚¿åˆ†æ
        async function analyzeData() {
            const inheritanceDate = systemData.inheritanceDate;
            const largeAmountThreshold = parseInt(document.getElementById('largeAmountThreshold').value);
            const unknownSourceThreshold = parseInt(document.getElementById('unknownSourceThreshold').value);
            const transferDays = parseInt(document.getElementById('transferDays').value);
            const transferErrorRate = parseInt(document.getElementById('transferErrorRate').value) / 100;
            const inheritancePeriod = parseInt(document.getElementById('inheritancePeriod').value);
            
            addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod);
            analyzeBalanceHistory();
            detectMoneyTransfersAdvanced(transferDays, transferErrorRate);
            detectUnknownSources(unknownSourceThreshold);
            generateAnnotations();
        }
        
        // å–å¼•ãƒ•ãƒ©ã‚°ä»˜ã‘ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod) {
            const inhDate = new Date(inheritanceDate);
            const deceased = systemData.family.find(f => f.isDeceased);
            
            systemData.transactions.forEach(tx => {
                tx.flags = [];
                tx.annotations = [];
                const amount = Math.max(tx.withdrawal, tx.deposit);
                const txDate = new Date(tx.date);
                
                const hasTransaction = tx.withdrawal > 0 || tx.deposit > 0;
                
                // å¤§é¡å–å¼•
                if (hasTransaction && amount >= largeAmountThreshold) {
                    tx.flags.push('å¤§é¡å–å¼•');
                    tx.annotations.push(`â˜…å¤§é¡å–å¼•(${amount.toLocaleString()}å††)`);
                    tx.confidence = 'high';
                }
                
                // æ‘˜è¦ç©ºç™½ãƒã‚§ãƒƒã‚¯
                if (hasTransaction && (!tx.description || tx.description.trim() === '')) {
                    tx.flags.push('æ‘˜è¦ç©ºç™½');
                    tx.annotations.push('â˜…æ‘˜è¦æ¬„ç©ºç™½(çª“å£å–å¼•ã®å¯èƒ½æ€§)');
                    tx.confidence = 'medium';
                }
                
                // åŸè³‡ä¸æ˜
                if (tx.deposit >= unknownSourceThreshold) {
                    if (!tx.description || 
                        tx.description.trim() === '' || 
                        tx.description === 'å…¥é‡‘' || 
                        tx.description.includes('ç¾é‡‘') ||
                        tx.description.includes('ATM')) {
                        
                        tx.flags.push('åŸè³‡ä¸æ˜');
                        tx.annotations.push(`â˜…åŸè³‡ä¸æ˜å…¥é‡‘(${tx.deposit.toLocaleString()}å††)`);
                        tx.confidence = tx.description ? 'medium' : 'high';
                        
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('â˜…ä½æ‰€ç§»å‹•å¾Œ30æ—¥ä»¥å†…ã®å…¥é‡‘');
                            tx.confidence = 'high';
                        }
                    }
                }
                
                // ç›¸ç¶šå‰å¾ŒæœŸé–“
                const daysDiff = Math.abs(txDate - inhDate) / (1000 * 60 * 60 * 24);
                if (hasTransaction && daysDiff <= inheritancePeriod) {
                    tx.flags.push('ç›¸ç¶šå‰å¾Œ');
                    if (amount >= 100000) {
                        tx.annotations.push(`â˜…ç›¸ç¶šå‰å¾Œ${Math.round(daysDiff)}æ—¥ã®å–å¼•`);
                    }
                }
                
                // å£åº§é–‹è¨­ãƒ»è§£ç´„
                if (tx.description && (tx.description.includes('é–‹è¨­') || tx.description.includes('æ–°è¦'))) {
                    tx.flags.push('å£åº§é–‹è¨­');
                    tx.annotations.push('â˜…å£åº§é–‹è¨­');
                }
                if (tx.description && (tx.description.includes('è§£ç´„') || tx.description.includes('é–‰é–'))) {
                    tx.flags.push('å£åº§è§£ç´„');
                    tx.annotations.push('â˜…å£åº§è§£ç´„');
                }
                
                // æœªæˆå¹´åˆ¤å®š
                const person = systemData.family.find(f => f.name === tx.name);
                if (person && person.birthDate) {
                    const age = calculateAge(person.birthDate, tx.date);
                    if (age < 20) {
                        tx.flags.push('æœªæˆå¹´');
                        tx.annotations.push(`â˜…æœªæˆå¹´å–å¼•(${age}æ­³)`);
                        
                        if (tx.flags.includes('å£åº§é–‹è¨­')) {
                            const cohabitants = getCohabitantsAtDate(tx.name, tx.date);
                            if (cohabitants.length > 0) {
                                tx.annotations.push(`â˜…æ¨å®šç®¡ç†è€…: ${cohabitants.join(', ')}`);
                            }
                        }
                    }
                }
                
                // è¢«ç›¸ç¶šäººåŒå±…åˆ¤å®š
                if (deceased && tx.name !== deceased.name && isSameAddressAsDeceased(tx.name, tx.date)) {
                    tx.flags.push('è¢«ç›¸ç¶šäººåŒå±…');
                    tx.annotations.push('â˜…è¢«ç›¸ç¶šäººã¨åŒå±…');
                }
            });
        }
        
        // å¹´é½¢è¨ˆç®—
        function calculateAge(birthDate, targetDate) {
            const birth = new Date(birthDate);
            const target = new Date(targetDate);
            let age = target.getFullYear() - birth.getFullYear();
            const monthDiff = target.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && target.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        // æœ€è¿‘ã®ä½æ‰€å¤‰æ›´ãƒã‚§ãƒƒã‚¯
        function checkRecentAddressChange(name, date, days) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const startDate = new Date(addr.startDate);
                const daysDiff = (targetDate - startDate) / (1000 * 60 * 60 * 24);
                if (daysDiff >= 0 && daysDiff <= days) {
                    return true;
                }
            }
            return false;
        }
        
        // ç‰¹å®šæ—¥ã®åŒå±…äººå–å¾—
        function getCohabitantsAtDate(name, date) {
            const address = getAddressAtDate(name, date);
            if (!address) return [];
            
            const cohabitants = [];
            systemData.family.forEach(person => {
                if (person.name !== name) {
                    const personAddr = getAddressAtDate(person.name, date);
                    if (personAddr === address) {
                        cohabitants.push(person.name);
                    }
                }
            });
            
            return cohabitants;
        }
        
        // è¢«ç›¸ç¶šäººåŒå±…åˆ¤å®š
        function isSameAddressAsDeceased(personName, date) {
            const deceased = systemData.family.find(f => f.isDeceased);
            if (!deceased) return false;
            
            const deceasedAddr = getAddressAtDate(deceased.name, date);
            const personAddr = getAddressAtDate(personName, date);
            
            return deceasedAddr && personAddr && deceasedAddr === personAddr;
        }
        
        // ç‰¹å®šæ—¥ã®ä½æ‰€å–å¾—
        function getAddressAtDate(name, date) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const start = new Date(addr.startDate);
                const end = addr.endDate ? new Date(addr.endDate) : new Date('9999-12-31');
                
                if (targetDate >= start && targetDate <= end) {
                    return addr.address;
                }
            }
            
            return null;
        }
        
        // æ®‹é«˜æ¨ç§»åˆ†æï¼ˆè£œå®Œæ©Ÿèƒ½ä»˜ãï¼‰
        function analyzeBalanceHistory() {
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            systemData.processedData.balanceByPerson = {};
            
            systemData.family.forEach(person => {
                const personData = {
                    name: person.name,
                    accounts: {},
                    yearlyTotal: {},
                    inheritanceTotal: 0
                };
                
                const personTx = systemData.transactions.filter(tx => tx.name === person.name);
                
                personTx.forEach(tx => {
                    const accountKey = `${tx.bank}_${tx.branch}_${tx.accountNumber}`;
                    if (!personData.accounts[accountKey]) {
                        personData.accounts[accountKey] = {
                            bank: tx.bank,
                            branch: tx.branch,
                            accountNumber: tx.accountNumber,
                            accountType: tx.accountType,
                            transactions: [],
                            yearlyBalance: {},
                            inheritanceBalance: 0,
                            openDate: null,
                            closeDate: null
                        };
                    }
                    personData.accounts[accountKey].transactions.push(tx);
                    
                    if (tx.flags.includes('å£åº§é–‹è¨­')) {
                        personData.accounts[accountKey].openDate = tx.date;
                    }
                    if (tx.flags.includes('å£åº§è§£ç´„')) {
                        personData.accounts[accountKey].closeDate = tx.date;
                    }
                });
                
                Object.values(personData.accounts).forEach(account => {
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const yearEnd = `${year}-12-31`;
                        const balance = getBalanceAtDate(account.transactions, yearEnd, true);
                        account.yearlyBalance[year] = balance;
                        
                        if (!personData.yearlyTotal[year]) {
                            personData.yearlyTotal[year] = 0;
                        }
                        if (balance.value !== null) {
                            personData.yearlyTotal[year] += balance.value;
                        }
                    }
                    
                    const inhBalance = getBalanceAtDate(account.transactions, inheritanceDate, true);
                    account.inheritanceBalance = inhBalance;
                    if (inhBalance.value !== null) {
                        personData.inheritanceTotal += inhBalance.value;
                    }
                });
                
                systemData.processedData.balanceByPerson[person.name] = personData;
            });
        }
        
        // ç‰¹å®šæ—¥ã®æ®‹é«˜å–å¾—ï¼ˆè£œå®Œæ©Ÿèƒ½ä»˜ãï¼‰
        function getBalanceAtDate(transactions, targetDate, withInterpolation = false) {
            const target = new Date(targetDate);
            let result = { value: null, isInterpolated: false };
            
            const balanceTx = transactions.filter(tx => tx.balance > 0);
            if (balanceTx.length === 0) return result;
            
            let closestBefore = null;
            let closestBeforeDate = null;
            let closestAfter = null;
            let closestAfterDate = null;
            
            balanceTx.forEach(tx => {
                const txDate = new Date(tx.date);
                
                if (txDate <= target) {
                    if (!closestBeforeDate || txDate > closestBeforeDate) {
                        closestBeforeDate = txDate;
                        closestBefore = tx;
                    }
                } else {
                    if (!closestAfterDate || txDate < closestAfterDate) {
                        closestAfterDate = txDate;
                        closestAfter = tx;
                    }
                }
            });
            
            if (closestBefore) {
                result.value = closestBefore.balance;
                
                if (withInterpolation && targetDate.endsWith('-12-31')) {
                    const yearEnd = new Date(targetDate);
                    const daysDiff = (yearEnd - closestBeforeDate) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 30) {
                        result.isInterpolated = true;
                    }
                }
                
                return result;
            }
            
            const firstTx = transactions[0];
            if (firstTx && new Date(firstTx.date) > target) {
                result.value = 0;
                return result;
            }
            
            if (closestAfter && withInterpolation) {
                result.value = closestAfter.balance;
                result.isInterpolated = true;
                return result;
            }
            
            return result;
        }
        
        // é«˜ç²¾åº¦è³‡é‡‘ç§»å‹•æ¤œå‡ºï¼ˆå¤šå¯¾å¤šãƒãƒƒãƒãƒ³ã‚°å¯¾å¿œï¼‰
        function detectMoneyTransfersAdvanced(maxDays, errorRate) {
            systemData.processedData.transfers = [];
            systemData.processedData.suspiciousTransfers = [];
            
            const withdrawals = systemData.transactions.filter(tx => tx.withdrawal > 0);
            const deposits = systemData.transactions.filter(tx => tx.deposit > 0);
            
            const usedDeposits = new Set();
            const allMatches = [];
            
            withdrawals.forEach(withdrawal => {
                const wDate = new Date(withdrawal.date);
                const wAmount = withdrawal.withdrawal;
                
                deposits.forEach(deposit => {
                    if (usedDeposits.has(deposit.id)) return;
                    
                    const dDate = new Date(deposit.date);
                    const daysDiff = (dDate - wDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff < 0 || daysDiff > maxDays) return;
                    
                    const amountDiff = Math.abs(deposit.deposit - wAmount);
                    const amountDiffRate = amountDiff / wAmount;
                    
                    if (amountDiffRate > errorRate) return;
                    
                    let score = 0;
                    score += daysDiff * 5;
                    score += amountDiffRate * 100;
                    
                    if (withdrawal.name === deposit.name) {
                        score += 50;
                    }
                    
                    const isFamily = checkFamilyRelation(withdrawal.name, deposit.name);
                    if (isFamily) {
                        score -= 20;
                    }
                    
                    if (daysDiff === 0 && withdrawal.time && deposit.time) {
                        const wTime = parseTime(withdrawal.time);
                        const dTime = parseTime(deposit.time);
                        
                        if (dTime < wTime) {
                            score += 100;
                        } else {
                            const timeDiff = dTime - wTime;
                            if (timeDiff < 60) {
                                score -= 10;
                            }
                        }
                    }
                    
                    allMatches.push({
                        withdrawal: withdrawal,
                        deposit: deposit,
                        score: score,
                        daysDiff: daysDiff,
                        amountDiff: amountDiff,
                        amountDiffRate: amountDiffRate,
                        isFamily: isFamily
                    });
                });
            });
            
            allMatches.sort((a, b) => a.score - b.score);
            
            const usedWithdrawals = new Set();
            
            allMatches.forEach(match => {
                if (usedWithdrawals.has(match.withdrawal.id) || usedDeposits.has(match.deposit.id)) {
                    return;
                }
                
                if (match.score < 100) {
                    usedWithdrawals.add(match.withdrawal.id);
                    usedDeposits.add(match.deposit.id);
                    
                    const transfer = {
                        date: match.withdrawal.date,
                        from: match.withdrawal.name,
                        to: match.deposit.name,
                        amount: match.withdrawal.withdrawal,
                        fromBank: `${match.withdrawal.bank} ${match.withdrawal.branch}`,
                        toBank: `${match.deposit.bank} ${match.deposit.branch}`,
                        fromAccount: match.withdrawal.accountNumber,
                        toAccount: match.deposit.accountNumber,
                        depositDate: match.deposit.date,
                        daysDiff: match.daysDiff,
                        amountDiff: match.amountDiff,
                        amountDiffRate: match.amountDiffRate,
                        isFamily: match.isFamily,
                        score: match.score,
                        confidence: match.score < 50 ? 'high' : match.score < 80 ? 'medium' : 'low'
                    };
                    
                    systemData.processedData.transfers.push(transfer);
                    
                    match.withdrawal.flags.push('è³‡é‡‘ç§»å‹•(å‡º)');
                    match.deposit.flags.push('è³‡é‡‘ç§»å‹•(å…¥)');
                    
                    const annotation = `â˜…è³‡é‡‘ç§»å‹•: ${match.withdrawal.name}â†’${match.deposit.name} (${match.daysDiff}æ—¥å¾Œ, èª¤å·®${(match.amountDiffRate * 100).toFixed(1)}%)`;
                    match.withdrawal.annotations.push(annotation);
                    match.deposit.annotations.push(annotation);
                    
                    if (match.isFamily && match.daysDiff <= 1 && match.amountDiffRate < 0.01) {
                        systemData.processedData.suspiciousTransfers.push(transfer);
                        match.withdrawal.annotations.push('â˜…è¦æ³¨æ„ï¼šå®¶æ—é–“å³æ—¥è³‡é‡‘ç§»å‹•');
                        match.deposit.annotations.push('â˜…è¦æ³¨æ„ï¼šå®¶æ—é–“å³æ—¥è³‡é‡‘ç§»å‹•');
                    }
                }
            });
        }
        
        // æ™‚åˆ»ãƒ‘ãƒ¼ã‚¹
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1] || 0);
        }
        
        // å®¶æ—é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        function checkFamilyRelation(name1, name2) {
            const person1 = systemData.family.find(f => f.name === name1);
            const person2 = systemData.family.find(f => f.name === name2);
            
            if (!person1 || !person2) return false;
            
            if (person1.spouse === name2 || person2.spouse === name1) {
                return true;
            }
            
            if (person1.children && person1.children.includes(name2)) {
                return true;
            }
            if (person2.children && person2.children.includes(name1)) {
                return true;
            }
            
            if (person1.parent && person1.parent === person2.parent) {
                return true;
            }
            
            return false;
        }
        
        // åŸè³‡ä¸æ˜å–å¼•æ¤œå‡º
        function detectUnknownSources(threshold) {
            systemData.processedData.unknownSources = [];
            
            systemData.transactions.forEach(tx => {
                if (tx.deposit >= threshold) {
                    let isUnknown = false;
                    let reason = '';
                    let confidence = 'low';
                    
                    const hasTransaction = tx.withdrawal > 0 || tx.deposit > 0;
                    
                    if (hasTransaction) {
                        if (!tx.description || tx.description.trim() === '') {
                            isUnknown = true;
                            reason = 'æ‘˜è¦æ¬„ç©ºç™½ï¼ˆçª“å£å–å¼•ï¼‰';
                            confidence = 'high';
                        }
                        else if (tx.description === 'å…¥é‡‘' || 
                                 tx.description === 'ç¾é‡‘' || 
                                 tx.description === 'ç¾é‡‘å…¥é‡‘' ||
                                 tx.description.includes('ATM')) {
                            isUnknown = true;
                            reason = `å…¥é‡‘ç¨®åˆ¥: ${tx.description}`;
                            confidence = 'medium';
                        }
                    }
                    
                    if (isUnknown) {
                        systemData.processedData.unknownSources.push({
                            ...tx,
                            reason: reason,
                            confidence: confidence
                        });
                        
                        if (!tx.flags.includes('åŸè³‡ä¸æ˜')) {
                            tx.flags.push('åŸè³‡ä¸æ˜');
                        }
                        
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('â˜…ä½æ‰€ç§»å‹•ç›´å¾Œã®åŸè³‡ä¸æ˜å…¥é‡‘ï¼ˆè¦ç¢ºèªï¼‰');
                        }
                        
                        if (tx.flags.includes('æœªæˆå¹´')) {
                            tx.annotations.push('â˜…æœªæˆå¹´å£åº§ã¸ã®åŸè³‡ä¸æ˜å…¥é‡‘ï¼ˆè´ˆä¸ã®å¯èƒ½æ€§ï¼‰');
                        }
                    }
                }
            });
        }
        
        // æ³¨è¨˜æƒ…å ±ã®ç”Ÿæˆ
        function generateAnnotations() {
            systemData.processedData.annotations.clear();
            
            systemData.transactions.forEach(tx => {
                if (tx.annotations.length > 0) {
                    const key = `${tx.id}`;
                    systemData.processedData.annotations.set(key, tx.annotations.join(' / '));
                }
            });
        }
        
        // ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateAllViews() {
            updateSummaryView();
            updateBalanceView();
            updateTransfersView();
            updateUnknownView();
            updateAddressView();
            updateAnnotatedView();
            updateFamilyView();
        }
        
        // ç·æ‹¬ãƒ“ãƒ¥ãƒ¼
        function updateSummaryView() {
            const container = document.getElementById('summary-content');
            const inheritanceDate = systemData.inheritanceDate;
            
            const totalTx = systemData.transactions.length;
            const flaggedTx = systemData.transactions.filter(tx => tx.flags.length > 0).length;
            const transfers = systemData.processedData.transfers.length;
            const suspiciousTransfers = systemData.processedData.suspiciousTransfers.length;
            const unknownSources = systemData.processedData.unknownSources.length;
            const blankMemo = systemData.transactions.filter(tx => tx.flags.includes('æ‘˜è¦ç©ºç™½')).length;
            
            let html = `
                <div class="info-card">
                    <h3>ğŸ“Š èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼</h3>
                    <p><strong>ç›¸ç¶šé–‹å§‹æ—¥ï¼š</strong>${inheritanceDate}</p>
                    <p><strong>åˆ†æå¯¾è±¡æœŸé–“ï¼š</strong>${systemData.transactions[0]?.date || 'N/A'} ï½ ${systemData.transactions[systemData.transactions.length-1]?.date || 'N/A'}</p>
                    <p><strong>å¯¾è±¡äººæ•°ï¼š</strong>${systemData.family.length}å</p>
                </div>
                
                <div class="alert-card ${flaggedTx > totalTx * 0.1 ? 'danger' : 'warning'}">
                    <h4>ğŸ” æ¤œå‡ºçµæœ</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>ç·å–å¼•ä»¶æ•°ï¼š<strong>${totalTx}</strong>ä»¶</li>
                        <li>è¦æ³¨æ„å–å¼•ï¼š<strong>${flaggedTx}</strong>ä»¶ï¼ˆ${(flaggedTx/totalTx*100).toFixed(1)}%ï¼‰</li>
                        <li>è³‡é‡‘ç§»å‹•æ¤œå‡ºï¼š<strong>${transfers}</strong>ä»¶${suspiciousTransfers > 0 ? ` <span style="color: #e74c3c;">ï¼ˆã†ã¡è¦æ³¨æ„ ${suspiciousTransfers}ä»¶ï¼‰</span>` : ''}</li>
                        <li>åŸè³‡ä¸æ˜å–å¼•ï¼š<strong>${unknownSources}</strong>ä»¶</li>
                        <li>æ‘˜è¦ç©ºç™½å–å¼•ï¼š<strong>${blankMemo}</strong>ä»¶ <span style="color: #f39c12;">ï¼ˆçª“å£å–å¼•ã®å¯èƒ½æ€§ï¼‰</span></li>
                    </ul>
                </div>
                
                <div class="criteria-explanation">
                    <h4>ğŸ·ï¸ åˆ¤å®šåŸºæº–ã®èª¬æ˜</h4>
                    <div class="criteria-categories">
                        <div class="criteria-category">
                            <h5>ğŸ’° é‡‘é¡é–¢é€£</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-large-amount criteria-badge">å¤§é¡å–å¼•</span>
                                    <span>è¨­å®šé‡‘é¡ä»¥ä¸Šã®å…¥å‡ºé‡‘ï¼ˆè´ˆä¸ãƒ»è³‡ç”£éš ã—ï¼‰</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-unknown-source criteria-badge">åŸè³‡ä¸æ˜</span>
                                    <span>å…¥é‡‘å…ƒãŒç‰¹å®šã§ããªã„å–å¼•ï¼ˆåç¾©é é‡‘ç­‰ï¼‰</span>
                                </div>
                            </div>
                        </div>
                        <div class="criteria-category">
                            <h5>ğŸ’¸ è³‡é‡‘ç§»å‹•</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-money-shift criteria-badge">è³‡é‡‘ç§»å‹•</span>
                                    <span>äººç‰©é–“ã®è³‡é‡‘ã‚·ãƒ•ãƒˆï¼ˆè´ˆä¸ã®å¯èƒ½æ€§ï¼‰</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-inheritance-period criteria-badge">ç›¸ç¶šå‰å¾Œ</span>
                                    <span>ç›¸ç¶šé–‹å§‹æ—¥å‰å¾Œã®å–å¼•ï¼ˆè²¡ç”£ç§»å‹•ï¼‰</span>
                                </div>
                            </div>
                        </div>
                        <div class="criteria-category">
                            <h5>ğŸ‘¤ äººç‰©é–¢é€£</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-minor criteria-badge">æœªæˆå¹´</span>
                                    <span>20æ­³æœªæº€ã®è€…ã«ã‚ˆã‚‹å–å¼•ï¼ˆç®¡ç†è€…ç¢ºèªï¼‰</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-cohabit criteria-badge">è¢«ç›¸ç¶šäººåŒå±…</span>
                                    <span>è¢«ç›¸ç¶šäººã¨åŒä½æ‰€ï¼ˆå°è¦æ¨¡å®…åœ°ç‰¹ä¾‹ï¼‰</span>
                                </div>
                            </div>
                        </div>
                        <div class="criteria-category">
                            <h5>ğŸ“ ãã®ä»–</h5>
                            <div class="criteria-list">
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-blank-memo criteria-badge">æ‘˜è¦ç©ºç™½</span>
                                    <span>æ‘˜è¦æ¬„ãŒç©ºç™½ï¼ˆçª“å£å–å¼•ãƒ»ç¾é‡‘ç§»å‹•ï¼‰</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="annotation-badge badge-account-open criteria-badge">å£åº§é–‹è¨­</span>
                                    <span>æ–°è¦å£åº§é–‹è¨­ï¼ˆè³‡ç”£åˆ†æ•£ã®å¯èƒ½æ€§ï¼‰</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // å„äººã®æ®‹é«˜ã‚µãƒãƒªãƒ¼
            html += `
                <div class="info-card">
                    <h3>ğŸ’° å„äººã®æ®‹é«˜çŠ¶æ³</h3>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ°å</th>
                                    <th>ç¶šæŸ„</th>
                                    <th>ç›¸ç¶šæ™‚æ®‹é«˜</th>
                                    <th>å£åº§æ•°</th>
                                    <th>è¦æ³¨æ„å–å¼•</th>
                                    <th>åŸè³‡ä¸æ˜</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            systemData.family.forEach(person => {
                const balanceData = systemData.processedData.balanceByPerson[person.name];
                const flaggedCount = systemData.transactions.filter(tx => 
                    tx.name === person.name && tx.flags.length > 0
                ).length;
                const unknownCount = systemData.processedData.unknownSources.filter(tx => 
                    tx.name === person.name
                ).length;
                
                const rowClass = person.isDeceased ? 'highlight-row' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="font-bold">${person.name}</td>
                        <td>${person.relationship}</td>
                        <td class="text-right">${balanceData ? balanceData.inheritanceTotal.toLocaleString() : 0}å††</td>
                        <td class="text-center">${balanceData ? Object.keys(balanceData.accounts).length : 0}</td>
                        <td class="text-center">${flaggedCount > 0 ? `<span class="annotation-badge badge-large-amount">${flaggedCount}</span>` : '0'}</td>
                        <td class="text-center">${unknownCount > 0 ? `<span class="annotation-badge badge-unknown-source">${unknownCount}</span>` : '0'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            
            // é‡è¦ãªæ³¨æ„äº‹é …
            if (suspiciousTransfers > 0 || blankMemo > 10) {
                html += `
                    <div class="alert-card danger">
                        <h4>âš ï¸ é‡è¦ãªç¢ºèªäº‹é …</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                `;
                
                if (suspiciousTransfers > 0) {
                    html += '<li>å®¶æ—é–“ã§ã®å³æ—¥è³‡é‡‘ç§»å‹•ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è´ˆä¸ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å¥‘ç´„æ›¸ç­‰ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚</li>';
                }
                
                if (blankMemo > 10) {
                    html += '<li>æ‘˜è¦æ¬„ãŒç©ºç™½ã®å–å¼•ãŒå¤šæ•°æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚éŠ€è¡Œçª“å£ã§ã®å–å¼•è¨˜éŒ²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</li>';
                }
                
                html += '</ul></div>';
            }
            
            container.innerHTML = html;
        }
        
        // æ®‹é«˜æ¨ç§»è¡¨ãƒ“ãƒ¥ãƒ¼
        function updateBalanceView() {
            const container = document.getElementById('balance-content');
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            let html = '<h3 style="margin: 20px 0;">ğŸ’° å„äººåˆ¥æ®‹é«˜æ¨ç§»è¡¨</h3>';
            html += '<p style="color: #9b59b6; font-style: italic; margin-bottom: 20px;">â€» æ–œä½“ã®æ•°å€¤ã¯å¹´å†…æœ€çµ‚å–å¼•æ—¥ã®æ®‹é«˜ã‚’è¡¨ç¤ºï¼ˆè£œå®Œå€¤ï¼‰</p>';
            
            Object.entries(systemData.processedData.balanceByPerson).forEach(([name, personData]) => {
                const person = systemData.family.find(f => f.name === name);
                const cardClass = person && person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${name} ã®æ®‹é«˜æ¨ç§»</h4>
                        <div class="balance-table-wrapper">
                            <table class="balance-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 240px;">å£åº§æƒ…å ±</th>
                `;
                
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    html += `<th style="min-width: 150px;">${year}å¹´æœ«</th>`;
                }
                html += `<th class="inheritance-date" style="min-width: 170px;">ç›¸ç¶šé–‹å§‹æ—¥<br>(${inheritanceDate})</th>`;
                html += '</tr></thead><tbody>';
                
                Object.values(personData.accounts).forEach(account => {
                    html += '<tr>';
                    html += `<td class="account-row">
                        ${account.bank} ${account.branch}<br>
                        ${account.accountType} ${account.accountNumber}
                        ${account.openDate ? `<br><small>é–‹è¨­: ${account.openDate}</small>` : ''}
                        ${account.closeDate ? `<br><small>è§£ç´„: ${account.closeDate}</small>` : ''}
                    </td>`;
                    
                    let prevBalance = 0;
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const balanceData = account.yearlyBalance[year] || { value: null, isInterpolated: false };
                        
                        if (balanceData.value !== null) {
                            const change = balanceData.value - prevBalance;
                            const changeClass = change > 0 ? 'balance-positive' : change < 0 ? 'balance-negative' : '';
                            const interpolatedClass = balanceData.isInterpolated ? 'balance-interpolated' : '';
                            
                            html += `<td class="${interpolatedClass}">
                                ${balanceData.value.toLocaleString()}
                                ${prevBalance > 0 && !balanceData.isInterpolated ? 
                                    `<span class="balance-change ${changeClass}">(${change > 0 ? '+' : ''}${change.toLocaleString()})</span>` 
                                    : ''}
                            </td>`;
                            prevBalance = balanceData.value;
                        } else {
                            html += '<td>-</td>';
                        }
                    }
                    
                    const inhBalance = account.inheritanceBalance;
                    if (inhBalance.value !== null) {
                        html += `<td class="inheritance-date ${inhBalance.isInterpolated ? 'balance-interpolated' : ''}">
                            ${inhBalance.value.toLocaleString()}
                        </td>`;
                    } else {
                        html += '<td class="inheritance-date">-</td>';
                    }
                    
                    html += '</tr>';
                });
                
                html += '<tr class="total-row">';
                html += '<td>åˆè¨ˆ</td>';
                
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    const total = personData.yearlyTotal[year] || 0;
                    html += `<td>${total.toLocaleString()}</td>`;
                }
                html += `<td class="inheritance-date">${personData.inheritanceTotal.toLocaleString()}</td>`;
                html += '</tr></tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // è³‡é‡‘ç§»å‹•ãƒ“ãƒ¥ãƒ¼
        function updateTransfersView() {
            const container = document.getElementById('transfers-content');
            const transfers = systemData.processedData.transfers;
            const suspicious = systemData.processedData.suspiciousTransfers;
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="alert-card info"><h3>è³‡é‡‘ç§»å‹•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</h3></div>';
                return;
            }
            
            let html = `
                <div class="alert-card ${suspicious.length > 0 ? 'danger' : 'warning'}">
                    <h3>ğŸ’¸ è³‡é‡‘ç§»å‹•åˆ†æçµæœï¼ˆ${transfers.length}ä»¶ï¼‰</h3>
                    <p>è¨­å®šæœŸé–“å†…ï¼ˆ${document.getElementById('transferDays').value}æ—¥ä»¥å†…ï¼‰ã§é‡‘é¡èª¤å·®${document.getElementById('transferErrorRate').value}%ä»¥å†…ã®å…¥å‡ºé‡‘ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚</p>
                    ${suspicious.length > 0 ? `<p style="color: #e74c3c; font-weight: 700;">â˜… ç‰¹ã«æ³¨æ„ãŒå¿…è¦ãªè³‡é‡‘ç§»å‹•ãŒ${suspicious.length}ä»¶æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</p>` : ''}
                </div>
            `;
            
            if (suspicious.length > 0) {
                html += `
                    <div class="info-card danger-highlight">
                        <h4>âš ï¸ è¦æ³¨æ„è³‡é‡‘ç§»å‹•</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>å‡ºé‡‘æ—¥</th>
                                        <th>é€é‡‘è€…</th>
                                        <th>å—å–äºº</th>
                                        <th>é–¢ä¿‚</th>
                                        <th>é‡‘é¡</th>
                                        <th>å…¥é‡‘æ—¥</th>
                                        <th>æ—¥æ•°</th>
                                        <th>èª¤å·®</th>
                                        <th>ä¿¡é ¼åº¦</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                suspicious.forEach(transfer => {
                    html += `
                        <tr class="danger-highlight">
                            <td>${transfer.date}</td>
                            <td>${transfer.from}</td>
                            <td>${transfer.to}</td>
                            <td>${transfer.isFamily ? '<span class="annotation-badge badge-cohabit">å®¶æ—</span>' : '-'}</td>
                            <td class="text-right">${transfer.amount.toLocaleString()}å††</td>
                            <td>${transfer.depositDate}</td>
                            <td class="text-center">${transfer.daysDiff}æ—¥</td>
                            <td class="text-center">${(transfer.amountDiffRate * 100).toFixed(1)}%</td>
                            <td><span class="confidence-indicator confidence-${transfer.confidence}">${transfer.confidence}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            html += `
                <div class="info-card">
                    <h4>å…¨è³‡é‡‘ç§»å‹•ä¸€è¦§</h4>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å‡ºé‡‘æ—¥</th>
                                    <th>é€é‡‘è€…</th>
                                    <th>é€é‡‘å…ƒ</th>
                                    <th>å—å–äºº</th>
                                    <th>å—å–å…ˆ</th>
                                    <th>é‡‘é¡</th>
                                    <th>å…¥é‡‘æ—¥</th>
                                    <th>èª¤å·®</th>
                                    <th>ä¿¡é ¼åº¦</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            transfers.forEach(transfer => {
                const isSuspicious = suspicious.some(s => 
                    s.date === transfer.date && 
                    s.from === transfer.from && 
                    s.to === transfer.to
                );
                
                html += `
                    <tr ${isSuspicious ? 'class="highlight-row"' : ''}>
                        <td>${transfer.date}</td>
                        <td>${transfer.from}</td>
                        <td>${transfer.fromBank}</td>
                        <td>${transfer.to}</td>
                        <td>${transfer.toBank}</td>
                        <td class="text-right">${transfer.amount.toLocaleString()}å††</td>
                        <td>${transfer.depositDate}</td>
                        <td class="text-right">${transfer.amountDiff.toLocaleString()}å††</td>
                        <td><span class="confidence-indicator confidence-${transfer.confidence}">${transfer.confidence}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // åŸè³‡ä¸æ˜ãƒ“ãƒ¥ãƒ¼
        function updateUnknownView() {
            const container = document.getElementById('unknown-content');
            const unknownSources = systemData.processedData.unknownSources;
            
            if (unknownSources.length === 0) {
                container.innerHTML = '<div class="alert-card success"><h3>åŸè³‡ä¸æ˜ã®å–å¼•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</h3></div>';
                return;
            }
            
            const byReason = {};
            unknownSources.forEach(tx => {
                if (!byReason[tx.reason]) {
                    byReason[tx.reason] = [];
                }
                byReason[tx.reason].push(tx);
            });
            
            let html = `
                <div class="alert-card danger">
                    <h3>â“ åŸè³‡ä¸æ˜å–å¼•ï¼ˆ${unknownSources.length}ä»¶ï¼‰</h3>
                    <p>å…¥é‡‘å…ƒãŒä¸æ˜ã¾ãŸã¯ç¢ºèªãŒå¿…è¦ãªå–å¼•ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
            `;
            
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `<li>${reason}ï¼š<strong>${txs.length}</strong>ä»¶</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `
                    <div class="info-card">
                        <h4>${reason}ï¼ˆ${txs.length}ä»¶ï¼‰</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æ—¥ä»˜</th>
                                        <th>æ°å</th>
                                        <th>éŠ€è¡Œãƒ»æ”¯åº—</th>
                                        <th>é‡‘é¡</th>
                                        <th>æ®‹é«˜</th>
                                        <th>ç‰¹è¨˜äº‹é …</th>
                                        <th>ä¿¡é ¼åº¦</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                txs.forEach(tx => {
                    const specialNotes = [];
                    if (tx.flags.includes('ç›¸ç¶šå‰å¾Œ')) specialNotes.push('ç›¸ç¶šå‰å¾Œ');
                    if (tx.flags.includes('æœªæˆå¹´')) specialNotes.push('æœªæˆå¹´');
                    if (tx.flags.includes('è¢«ç›¸ç¶šäººåŒå±…')) specialNotes.push('åŒå±…');
                    
                    html += `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.name}</td>
                            <td>${tx.bank} ${tx.branch}</td>
                            <td class="text-right">${tx.deposit.toLocaleString()}å††</td>
                            <td class="text-right">${tx.balance.toLocaleString()}å††</td>
                            <td>
                                ${specialNotes.map(note => 
                                    `<span class="annotation-badge badge-${note === 'ç›¸ç¶šå‰å¾Œ' ? 'inheritance-period' : note === 'æœªæˆå¹´' ? 'minor' : 'cohabit'}">${note}</span>`
                                ).join(' ')}
                            </td>
                            <td><span class="confidence-indicator confidence-${tx.confidence}">${tx.confidence}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // ä½æ‰€å±¥æ­´ãƒ“ãƒ¥ãƒ¼
        function updateAddressView() {
            const container = document.getElementById('addresses-content');
            const inheritanceDate = systemData.inheritanceDate;
            const deceased = systemData.family.find(f => f.isDeceased);
            const deceasedInhAddr = deceased ? getAddressAtDate(deceased.name, inheritanceDate) : null;
            
            let html = '<h3 style="margin: 20px 0;">ğŸ  ä½æ‰€ç§»è»¢çŠ¶æ³ä¸€è¦§</h3>';
            
            if (deceased && deceasedInhAddr) {
                const cohabitants = [];
                systemData.family.forEach(person => {
                    if (!person.isDeceased) {
                        const addr = getAddressAtDate(person.name, inheritanceDate);
                        if (addr === deceasedInhAddr) {
                            cohabitants.push(person.name);
                        }
                    }
                });
                
                if (cohabitants.length > 0) {
                    html += `
                        <div class="alert-card warning">
                            <h4>ç›¸ç¶šé–‹å§‹æ™‚ã®åŒå±…çŠ¶æ³</h4>
                            <p>è¢«ç›¸ç¶šäººï¼ˆ${deceased.name}ï¼‰ã¨åŒå±…ã—ã¦ã„ãŸç›¸ç¶šäººï¼š<strong>${cohabitants.join('ã€')}</strong></p>
                            <p>ä½æ‰€ï¼š${deceasedInhAddr}</p>
                        </div>
                    `;
                }
            }
            
            systemData.family.forEach(person => {
                const addresses = systemData.addresses.filter(a => a.name === person.name);
                if (addresses.length === 0) return;
                
                const cardClass = person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${person.name} ï¼ˆ${person.relationship}ï¼‰</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æœŸé–“</th>
                                        <th>ä½æ‰€</th>
                                        <th>å±…ä½å¹´æ•°</th>
                                        <th>ç›¸ç¶šæ™‚</th>
                                        <th>å‚™è€ƒ</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                addresses.forEach(addr => {
                    const start = new Date(addr.startDate);
                    const end = addr.endDate ? new Date(addr.endDate) : new Date();
                    const years = Math.floor((end - start) / (365.25 * 24 * 60 * 60 * 1000));
                    const months = Math.floor(((end - start) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
                    
                    const isCurrent = !addr.endDate;
                    const inhDate = new Date(inheritanceDate);
                    const wasLivingHereDuringInheritance = start <= inhDate && (addr.endDate ? new Date(addr.endDate) >= inhDate : true);
                    
                    const isSameAsDeceased = deceased && deceasedInhAddr === addr.address && wasLivingHereDuringInheritance;
                    
                    html += `
                        <tr ${wasLivingHereDuringInheritance ? 'class="highlight-row"' : ''}>
                            <td>${addr.startDate} ï½ ${addr.endDate || 'ç¾åœ¨'}</td>
                            <td>${addr.address}</td>
                            <td>${years}å¹´${months > 0 ? `${months}ãƒ¶æœˆ` : ''}</td>
                            <td>${wasLivingHereDuringInheritance ? 'â—‹' : '-'}</td>
                            <td>
                                ${isCurrent ? '<span class="annotation-badge badge-account-open">ç¾ä½æ‰€</span>' : ''}
                                ${isSameAsDeceased ? '<span class="annotation-badge badge-cohabit">è¢«ç›¸ç¶šäººåŒå±…</span>' : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // æ³¨è¨˜ä»˜ãæ˜ç´°ãƒ“ãƒ¥ãƒ¼
        function updateAnnotatedView() {
            const container = document.getElementById('annotated-content');
            
            let html = `
                <h3 style="margin: 20px 0;">ğŸ“ æ³¨è¨˜ä»˜ãå–å¼•æ˜ç´°</h3>
                <div class="alert-card info">
                    <p>â˜…ãƒãƒ¼ã‚¯ãŒä»˜ã„ãŸé …ç›®ã¯ç›¸ç¶šç¨èª¿æŸ»ã«ãŠã„ã¦ç‰¹ã«æ³¨æ„ãŒå¿…è¦ãªå–å¼•ã§ã™ã€‚</p>
                    <p>ã“ã®ä¸€è¦§ã¯å…ƒãƒ‡ãƒ¼ã‚¿ã«æ³¨è¨˜ã‚’è¿½åŠ ã—ãŸã‚‚ã®ã§ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã§å‡ºåŠ›ã§ãã¾ã™ã€‚</p>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table" style="min-width: 1400px;">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>æ™‚åˆ»</th>
                                <th>æ°å</th>
                                <th>éŠ€è¡Œ</th>
                                <th>æ”¯åº—</th>
                                <th>ç§‘ç›®</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>å‡ºé‡‘</th>
                                <th>å…¥é‡‘</th>
                                <th>æ®‹é«˜</th>
                                <th>æ‘˜è¦</th>
                                <th style="min-width: 350px;">æ³¨è¨˜</th>
                                <th>ä¿¡é ¼åº¦</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            systemData.transactions.filter(tx => tx.annotations.length > 0).forEach(tx => {
                const rowClass = tx.annotations.some(a => a.includes('è¦æ³¨æ„')) ? 'danger-highlight' : 'highlight-row';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${tx.date}</td>`;
                html += `<td>${tx.time || ''}</td>`;
                html += `<td>${tx.name}</td>`;
                html += `<td>${tx.bank}</td>`;
                html += `<td>${tx.branch}</td>`;
                html += `<td>${tx.accountType}</td>`;
                html += `<td>${tx.accountNumber}</td>`;
                html += `<td class="text-right">${tx.withdrawal > 0 ? tx.withdrawal.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.deposit > 0 ? tx.deposit.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.balance > 0 ? tx.balance.toLocaleString() : ''}</td>`;
                html += `<td>${tx.description}</td>`;
                html += `<td style="font-weight: 700; color: #e74c3c;">${tx.annotations.join(' / ')}</td>`;
                html += `<td><span class="confidence-indicator confidence-${tx.confidence}">${tx.confidence}</span></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // å®¶ç³»å›³ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function updateFamilyView() {
            const container = document.getElementById('family-content');
            
            let html = '<div class="family-tree-wrapper">';
            html += '<div class="zoom-controls">';
            html += '<button class="zoom-btn" onclick="zoomIn()">+</button>';
            html += '<button class="zoom-btn" onclick="zoomOut()">-</button>';
            html += '<button class="zoom-btn" onclick="zoomReset()">âŸ²</button>';
            html += '</div>';
            html += '<h2 class="family-tree-title">ç›¸ç¶šé–¢ä¿‚å›³</h2>';
            
            const svgContent = createFamilyTreeSVG();
            html += svgContent;
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // å®¶ç³»å›³SVGç”Ÿæˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function createFamilyTreeSVG() {
            const width = 1400;
            const height = 900;
            const boxWidth = 220;
            const boxHeight = 140;
            const hGap = 60;
            const vGap = 180;
            
            const generations = {
                0: [],
                1: [],
                2: [],
                3: []
            };
            
            systemData.family.forEach(person => {
                generations[person.generation || 3].push(person);
            });
            
            let svg = `<svg id="familyTreeSvg" class="family-tree-svg" viewBox="0 0 ${width} ${height}">`;
            
            svg += `<defs>
                <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                    <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#ecf0f1" stroke-width="1"/>
                </pattern>
            </defs>
            <rect width="${width}" height="${height}" fill="url(#grid)" />`;
            
            const positions = {};
            let currentY = 80;
            
            // è¢«ç›¸ç¶šäººä¸–ä»£
            const gen0Width = generations[0].length * (boxWidth + hGap) - hGap;
            let currentX = (width - gen0Width) / 2;
            
            generations[0].forEach((person, index) => {
                const x = currentX + index * (boxWidth + hGap);
                const y = currentY;
                positions[person.name] = { x: x + boxWidth/2, y: y + boxHeight/2 };
                
                svg += createPersonBox(person, x, y, boxWidth, boxHeight);
                
                if (index > 0 && person.spouse) {
                    const spousePos = positions[person.spouse];
                    if (spousePos) {
                        svg += `<line class="relation-line spouse-line" 
                            x1="${spousePos.x}" y1="${spousePos.y}" 
                            x2="${x + boxWidth/2}" y2="${y + boxHeight/2}" />`;
                    }
                }
            });
            
            // å­ä¸–ä»£
            currentY += vGap;
            if (generations[1].length > 0) {
                const gen1Width = generations[1].length * (boxWidth + hGap) - hGap;
                currentX = (width - gen1Width) / 2;
                
                generations[1].forEach((person, index) => {
                    const x = currentX + index * (boxWidth + hGap);
                    const y = currentY;
                    positions[person.name] = { x: x + boxWidth/2, y: y + boxHeight/2 };
                    
                    svg += createPersonBox(person, x, y, boxWidth, boxHeight);
                    
                    if (person.parent && positions[person.parent]) {
                        const parentPos = positions[person.parent];
                        svg += `<line class="relation-line" 
                            x1="${parentPos.x}" y1="${parentPos.y + boxHeight/2}" 
                            x2="${x + boxWidth/2}" y2="${y}" />`;
                    }
                });
            }
            
            // å­«ä¸–ä»£
            currentY += vGap;
            if (generations[2].length > 0) {
                const gen2Width = generations[2].length * (boxWidth + hGap) - hGap;
                currentX = (width - gen2Width) / 2;
                
                generations[2].forEach((person, index) => {
                    const x = currentX + index * (boxWidth + hGap);
                    const y = currentY;
                    positions[person.name] = { x: x + boxWidth/2, y: y + boxHeight/2 };
                    
                    svg += createPersonBox(person, x, y, boxWidth, boxHeight);
                    
                    if (person.parent && positions[person.parent]) {
                        const parentPos = positions[person.parent];
                        svg += `<line class="relation-line" 
                            x1="${parentPos.x}" y1="${parentPos.y + boxHeight/2}" 
                            x2="${x + boxWidth/2}" y2="${y}" />`;
                    }
                });
            }
            
            svg += '</svg>';
            return svg;
        }
        
        // äººç‰©ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
        function createPersonBox(person, x, y, width, height) {
            const isDeceased = person.isDeceased;
            const isMale = person.gender === 'male';
            const address = getAddressAtDate(person.name, systemData.inheritanceDate);
            
            let box = '';
            
            const rx = isMale ? 0 : 35;
            box += `<rect class="member-box ${isDeceased ? 'deceased' : ''} ${person.gender || 'unknown'}" 
                x="${x}" y="${y}" width="${width}" height="${height}" rx="${rx}" ry="${rx}" />`;
            
            box += `<text class="member-name" x="${x + width/2}" y="${y + 30}" text-anchor="middle">${person.name}</text>`;
            box += `<text class="member-text" x="${x + width/2}" y="${y + 55}" text-anchor="middle">${person.relationship}</text>`;
            
            if (person.birthDate) {
                box += `<text class="member-text" x="${x + width/2}" y="${y + 80}" text-anchor="middle">ç”Ÿ: ${person.birthDate}</text>`;
            }
            
            if (person.ageAtInheritance !== undefined) {
                box += `<text class="member-text" x="${x + width/2}" y="${y + 105}" text-anchor="middle">ç›¸ç¶šæ™‚: ${person.ageAtInheritance}æ­³</text>`;
            }
            
            if (address) {
                const shortAddr = address.length > 18 ? address.substring(0, 18) + '...' : address;
                box += `<text class="member-text" x="${x + width/2}" y="${y + 125}" text-anchor="middle" font-size="13">${shortAddr}</text>`;
            }
            
            return box;
        }
        
        // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
        let currentZoom = 1;
        
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            applyZoom();
        }
        
        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.5);
            applyZoom();
        }
        
        function zoomReset() {
            currentZoom = 1;
            applyZoom();
        }
        
        function applyZoom() {
            const svg = document.getElementById('familyTreeSvg');
            if (svg) {
                svg.style.transform = `scale(${currentZoom})`;
                svg.style.transformOrigin = 'center center';
            }
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }
        
        // çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportResults() {
            const inheritanceDate = systemData.inheritanceDate;
            
            let csv = '\uFEFF';
            csv += 'ç›¸ç¶šç¨èª¿æŸ»åˆ†æã‚·ã‚¹ãƒ†ãƒ  v3 åˆ†æçµæœ\n';
            csv += `åˆ†ææ—¥æ™‚,${new Date().toLocaleString('ja-JP')}\n`;
            csv += `ç›¸ç¶šé–‹å§‹æ—¥,${inheritanceDate}\n\n`;
            
            csv += 'ã€è¦æ³¨æ„å–å¼•ä¸€è¦§ã€‘\n';
            csv += 'æ—¥ä»˜,æ™‚åˆ»,æ°å,éŠ€è¡Œ,æ”¯åº—,å‡ºé‡‘,å…¥é‡‘,æ®‹é«˜,æ‘˜è¦,ãƒ•ãƒ©ã‚°,æ³¨è¨˜,ä¿¡é ¼åº¦\n';
            
            systemData.transactions.filter(tx => tx.flags.length > 0).forEach(tx => {
                csv += `"${tx.date}","${tx.time || ''}","${tx.name}","${tx.bank}","${tx.branch}",`;
                csv += `${tx.withdrawal},${tx.deposit},${tx.balance},"${tx.description}","${tx.flags.join('ãƒ»')}","${tx.annotations.join(' / ')}","${tx.confidence}"\n`;
            });
            
            csv += '\nã€è³‡é‡‘ç§»å‹•ã€‘\n';
            csv += 'å‡ºé‡‘æ—¥,é€é‡‘è€…,å—å–äºº,é‡‘é¡,å…¥é‡‘æ—¥,æ—¥æ•°å·®,é‡‘é¡å·®,å®¶æ—é–“,ä¿¡é ¼åº¦\n';
            systemData.processedData.transfers.forEach(t => {
                csv += `"${t.date}","${t.from}","${t.to}",${t.amount},"${t.depositDate}",${t.daysDiff},${t.amountDiff},${t.isFamily ? 'â—‹' : ''},"${t.confidence}"\n`;
            });
            
            csv += '\nã€åŸè³‡ä¸æ˜å–å¼•ã€‘\n';
            csv += 'æ—¥ä»˜,æ°å,éŠ€è¡Œ,é‡‘é¡,æ‘˜è¦,ç†ç”±,ä¿¡é ¼åº¦\n';
            systemData.processedData.unknownSources.forEach(tx => {
                csv += `"${tx.date}","${tx.name}","${tx.bank} ${tx.branch}",${tx.deposit},"${tx.description}","${tx.reason}","${tx.confidence}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç›¸ç¶šç¨èª¿æŸ»çµæœ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('åˆ†æçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }
        
        // æ³¨è¨˜ä»˜ãå…ƒãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAnnotatedData() {
            let csv = '\uFEFF';
            csv += 'éŠ€è¡Œå,æ”¯åº—å,æ°å,ç§‘ç›®,å£åº§ç•ªå·,æ—¥ä»˜,æ™‚åˆ»,å‡ºé‡‘,å…¥é‡‘,å–æ‰±åº—,æ©Ÿç•ª,æ‘˜è¦,æ®‹é«˜,æ³¨è¨˜\n';
            
            systemData.transactions.forEach(tx => {
                csv += `"${tx.bank}","${tx.branch}","${tx.name}","${tx.accountType}","${tx.accountNumber}",`;
                csv += `"${tx.date}","${tx.time || ''}",${tx.withdrawal || ''},${tx.deposit || ''},`;
                csv += `"${tx.location}","${tx.machineId}","${tx.description}",${tx.balance || ''},`;
                csv += `"${tx.annotations.join(' / ')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æ³¨è¨˜ä»˜ãå–å¼•æ˜ç´°_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('æ³¨è¨˜ä»˜ãå…ƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }
    </script>
</body>
</html>
