<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>相続税調査分析システム - 改良版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Yu Gothic', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            transform: rotate(45deg);
            pointer-events: none;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        .upload-section {
            padding: 30px;
            background: #fafbfc;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .file-input-group {
            background: white;
            padding: 25px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-group:hover {
            border-color: #3949ab;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57, 73, 171, 0.15);
        }
        
        .file-input-group.uploaded {
            border-color: #4caf50;
            border-style: solid;
            background: #f0fdf4;
        }
        
        .file-input-group.uploaded::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #4caf50;
            font-size: 24px;
            font-weight: bold;
        }
        
        .file-input {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            cursor: pointer;
            background: #f6f8fa;
        }
        
        .file-label {
            display: block;
            font-weight: 600;
            color: #24292e;
            margin-bottom: 8px;
            font-size: 1.15em;
        }
        
        .file-description {
            font-size: 0.85em;
            color: #586069;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .file-status {
            margin-top: 12px;
            font-size: 0.9em;
            color: #4caf50;
            font-weight: 500;
            display: none;
        }
        
        .config-section {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e4e8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-item label {
            font-weight: 600;
            color: #24292e;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .config-item input, .config-item select {
            padding: 10px 14px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            background: #f6f8fa;
            transition: all 0.2s;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #3949ab;
            background: white;
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: #3949ab;
            color: white;
            box-shadow: 0 2px 8px rgba(57, 73, 171, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1a237e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57, 73, 171, 0.4);
        }
        
        .btn-primary:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #607d8b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #455a64;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-1px);
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            transition: width 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                45deg,
                rgba(255,255,255,0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.2) 50%,
                rgba(255,255,255,0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 30px 30px;
            animation: progress-animation 1s linear infinite;
        }
        
        @keyframes progress-animation {
            0% { background-position: 0 0; }
            100% { background-position: 30px 30px; }
        }
        
        .status-message {
            padding: 14px 20px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .status-success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
        }
        
        .status-error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
            border-left: 4px solid #dc3545;
        }
        
        .status-warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7;
            border-left: 4px solid #ffc107;
        }
        
        .status-info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
            border-left: 4px solid #17a2b8;
        }
        
        .analysis-container {
            padding: 30px;
            display: none;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e1e4e8;
            margin-bottom: 30px;
            overflow-x: auto;
            background: #f6f8fa;
            border-radius: 8px 8px 0 0;
            padding: 5px;
            gap: 5px;
        }
        
        .tab {
            padding: 14px 24px;
            background: transparent;
            cursor: pointer;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #586069;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 6px 6px 0 0;
            position: relative;
            flex-shrink: 0;
        }
        
        .tab:hover {
            background: #e1e4e8;
            color: #24292e;
        }
        
        .tab.active {
            background: white;
            color: #3949ab;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3949ab;
            border-radius: 3px 3px 0 0;
        }
        
        .tab-content {
            display: none;
            min-height: 400px;
            animation: fadeIn 0.4s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* カード型コンポーネント */
        .info-card {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        
        .info-card h3 {
            color: #24292e;
            margin-bottom: 16px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-card {
            padding: 16px 24px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 5px solid;
            animation: slideIn 0.3s ease;
        }
        
        .alert-card.warning {
            background: #fff8e1;
            color: #f57c00;
            border-color: #ff9800;
        }
        
        .alert-card.danger {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
        }
        
        .alert-card.info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #2196f3;
        }
        
        .alert-card.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4caf50;
        }
        
        /* データテーブル */
        .data-table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        .data-table th {
            background: #f6f8fa;
            color: #24292e;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #e1e4e8;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f3f6;
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: #f8f9fb;
        }
        
        .data-table tr.highlighted {
            background: #fff8e1;
            font-weight: 500;
        }
        
        /* 注記・フラグスタイル */
        .annotation-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-large-amount {
            background: #ffecb3;
            color: #e65100;
            border: 1px solid #ffb74d;
        }
        
        .badge-unknown-source {
            background: #ffccbc;
            color: #bf360c;
            border: 1px solid #ff8a65;
        }
        
        .badge-money-shift {
            background: #d1c4e9;
            color: #4527a0;
            border: 1px solid #9575cd;
        }
        
        .badge-suspicious-shift {
            background: #ef9a9a;
            color: #b71c1c;
            border: 1px solid #e57373;
        }
        
        .badge-inheritance-period {
            background: #ffcdd2;
            color: #b71c1c;
            border: 1px solid #ef5350;
        }
        
        .badge-account-open {
            background: #c8e6c9;
            color: #1b5e20;
            border: 1px solid #66bb6a;
        }
        
        .badge-account-close {
            background: #f8bbd0;
            color: #880e4f;
            border: 1px solid #f06292;
        }
        
        .badge-minor {
            background: #bbdefb;
            color: #0d47a1;
            border: 1px solid #64b5f6;
        }
        
        .badge-cohabit {
            background: #b2dfdb;
            color: #004d40;
            border: 1px solid #4db6ac;
        }
        
        .badge-blank-memo {
            background: #fff176;
            color: #f57f17;
            border: 1px solid #ffd54f;
        }
        
        /* 残高推移表 */
        .balance-table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .balance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }
        
        .balance-table th {
            background: #1a237e;
            color: white;
            padding: 14px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .balance-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #f0f3f6;
            font-size: 14px;
        }
        
        .balance-table tr:nth-child(even) {
            background: #fafbfc;
        }
        
        .balance-table tr:hover {
            background: #e3f2fd;
        }
        
        .balance-table .person-name {
            font-weight: 600;
            text-align: left;
            background: #f6f8fa;
            color: #24292e;
        }
        
        .balance-table .account-row {
            padding-left: 30px;
            text-align: left;
            font-size: 13px;
            color: #586069;
        }
        
        .balance-table .total-row {
            font-weight: 600;
            background: #e8f5e9;
            border-top: 2px solid #4caf50;
        }
        
        .balance-table .inheritance-date {
            background: #fff8e1;
            font-weight: 600;
        }
        
        .balance-positive {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .balance-negative {
            color: #c62828;
            font-weight: 600;
        }
        
        .balance-change {
            font-size: 11px;
            color: #586069;
            display: block;
            margin-top: 2px;
        }
        
        .balance-interpolated {
            font-style: italic;
            color: #7986cb;
        }
        
        /* 家系図スタイル */
        .family-tree-wrapper {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 40px;
            margin: 20px 0;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .family-tree-title {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 40px;
            color: #1a237e;
        }
        
        .family-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 600px;
            position: relative;
            padding: 30px;
            min-width: max-content;
        }
        
        .generation {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            margin: 50px 0;
            position: relative;
        }
        
        .generation-label {
            position: absolute;
            left: -120px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            color: #586069;
            font-size: 14px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background: white;
            padding: 10px 5px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
        }
        
        .family-member {
            background: white;
            border: 3px solid #3949ab;
            border-radius: 12px;
            padding: 20px;
            min-width: 220px;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
            z-index: 10;
            cursor: pointer;
        }
        
        .family-member:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .family-member.deceased {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .family-member.male {
            border-style: solid;
        }
        
        .family-member.female {
            border-radius: 60px 12px 60px 12px;
        }
        
        .member-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            color: #1a237e;
        }
        
        .member-info {
            font-size: 0.9em;
            color: #586069;
            line-height: 1.6;
        }
        
        .member-info-row {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .member-info-label {
            font-weight: 600;
            color: #24292e;
        }
        
        .address-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e1e4e8;
            font-size: 0.85em;
        }
        
        .address-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
        }
        
        .same-address {
            background: #c8e6c9;
            color: #1b5e20;
        }
        
        .different-address {
            background: #fff3cd;
            color: #f57c00;
        }
        
        /* 印刷スタイル */
        @media print {
            body {
                padding: 0;
                background: white;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .btn, .file-input-group, .config-section {
                display: none !important;
            }
            
            .tab-container {
                display: none;
            }
            
            .tab-content {
                display: block !important;
                page-break-after: always;
            }
            
            .data-table {
                font-size: 10px;
            }
            
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .file-grid, .config-grid {
                grid-template-columns: 1fr;
            }
            
            .family-tree {
                transform: scale(0.8);
                transform-origin: top center;
            }
            
            .tab {
                font-size: 13px;
                padding: 10px 16px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px;
            }
        }
        
        /* ローディングアニメーション */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3949ab;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ユーティリティクラス */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .highlight-row {
            background: #fff8e1 !important;
            font-weight: 600;
        }
        
        .danger-highlight {
            background: #ffebee !important;
            color: #c62828;
        }
        
        .success-highlight {
            background: #e8f5e9 !important;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>相続税調査分析システム</h1>
            <p>高精度な資金移動検出と原資不明判定により、相続税調査に必要な分析を実施します</p>
        </div>
        
        <div class="upload-section">
            <h2 class="section-title">📁 データファイルアップロード</h2>
            
            <div class="file-grid">
                <div class="file-input-group" id="group1">
                    <label class="file-label">📊 元データ（取引データ）</label>
                    <p class="file-description">
                        A列:銀行名 B列:支店名 C列:氏名 D列:科目<br>
                        E列:口座番号 F列:日付 G列:時刻 H列:出金<br>
                        I列:入金 J列:取扱店 K列:機番 L列:摘要 M列:残高
                    </p>
                    <input type="file" class="file-input" id="transactionFile" accept=".csv">
                    <div class="file-status" id="status1"></div>
                </div>
                
                <div class="file-input-group" id="group2">
                    <label class="file-label">👨‍👩‍👧‍👦 家族構成</label>
                    <p class="file-description">
                        A列:氏名 B列:続柄 C列:生年月日<br>
                        D列:相続開始日（被相続人は日付、他は年齢）
                    </p>
                    <input type="file" class="file-input" id="familyFile" accept=".csv">
                    <div class="file-status" id="status2"></div>
                </div>
                
                <div class="file-input-group" id="group3">
                    <label class="file-label">🏠 住所履歴</label>
                    <p class="file-description">
                        A列:氏名 B列:住所<br>
                        C列:居住開始日 D列:居住終了日
                    </p>
                    <input type="file" class="file-input" id="addressFile" accept=".csv">
                    <div class="file-status" id="status3"></div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <p id="progressText" style="color: #586069; font-weight: 500;">0/3 ファイルがアップロードされました</p>
            
            <div class="config-section">
                <h3 class="section-title" style="font-size: 1.2em;">⚙️ 分析設定</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <label>
                            <span>📅</span> 分析基準年
                        </label>
                        <select id="baseYear">
                            <option value="2024">2024年</option>
                            <option value="2023">2023年</option>
                            <option value="2022">2022年</option>
                            <option value="2021">2021年</option>
                            <option value="2020">2020年</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>
                            <span>💰</span> 大額取引基準額
                        </label>
                        <input type="number" id="largeAmountThreshold" value="1000000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>❓</span> 原資不明基準額
                        </label>
                        <input type="number" id="unknownSourceThreshold" value="500000" step="100000">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>🔄</span> 資金移動検出日数
                        </label>
                        <input type="number" id="transferDays" value="7" min="1" max="30">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>📊</span> 資金移動誤差率(%)
                        </label>
                        <input type="number" id="transferErrorRate" value="10" min="0" max="50">
                    </div>
                    <div class="config-item">
                        <label>
                            <span>⚠️</span> 相続前後期間(日)
                        </label>
                        <input type="number" id="inheritancePeriod" value="90" min="30" max="365">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>
                        📊 分析開始
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        🗑️ データクリア
                    </button>
                    <button class="btn btn-success hidden" id="exportBtn" onclick="exportResults()">
                        💾 結果エクスポート
                    </button>
                    <button class="btn btn-warning hidden" id="exportAnnotatedBtn" onclick="exportAnnotatedData()">
                        📝 注記付き元データ
                    </button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <div class="analysis-container" id="analysisContainer">
            <div class="tab-container">
                <button class="tab active" onclick="showTab('summary')">📋 総括</button>
                <button class="tab" onclick="showTab('balance')">💰 残高推移表</button>
                <button class="tab" onclick="showTab('transfers')">💸 資金移動分析</button>
                <button class="tab" onclick="showTab('unknown')">❓ 原資不明取引</button>
                <button class="tab" onclick="showTab('addresses')">🏠 住所移転状況</button>
                <button class="tab" onclick="showTab('annotated')">📝 注記付き明細</button>
                <button class="tab" onclick="showTab('family')">👨‍👩‍👧‍👦 相続関係図</button>
            </div>
            
            <div id="summary-content" class="tab-content active"></div>
            <div id="balance-content" class="tab-content"></div>
            <div id="transfers-content" class="tab-content"></div>
            <div id="unknown-content" class="tab-content"></div>
            <div id="addresses-content" class="tab-content"></div>
            <div id="annotated-content" class="tab-content"></div>
            <div id="family-content" class="tab-content"></div>
        </div>
    </div>

    <script>
        // グローバル変数
        let uploadedFiles = {
            transaction: null,
            family: null,
            address: null
        };
        
        let systemData = {
            transactions: [],
            family: [],
            addresses: [],
            inheritanceDate: null,
            processedData: {
                balanceByPerson: {},
                transfers: [],
                suspiciousTransfers: [],
                unknownSources: [],
                annotations: new Map()
            }
        };
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupFileInputs();
            updateProgress();
        });
        
        // ファイル入力設定
        function setupFileInputs() {
            document.getElementById('transactionFile').addEventListener('change', e => handleFileSelect(e, 'transaction', 1));
            document.getElementById('familyFile').addEventListener('change', e => handleFileSelect(e, 'family', 2));
            document.getElementById('addressFile').addEventListener('change', e => handleFileSelect(e, 'address', 3));
            document.getElementById('analyzeBtn').addEventListener('click', processAllFiles);
        }
        
        // ファイル選択処理
        function handleFileSelect(event, type, groupNumber) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('CSVファイルを選択してください', 'error');
                return;
            }
            
            uploadedFiles[type] = file;
            
            const group = document.getElementById(`group${groupNumber}`);
            const status = document.getElementById(`status${groupNumber}`);
            
            group.classList.add('uploaded');
            status.style.display = 'block';
            status.textContent = `✓ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            updateProgress();
        }
        
        // 進捗更新
        function updateProgress() {
            const uploadedCount = Object.values(uploadedFiles).filter(f => f !== null).length;
            const percentage = (uploadedCount / 3) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${uploadedCount}/3 ファイルがアップロードされました`;
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedCount !== 3;
            
            if (uploadedCount === 3) {
                showStatus('全ファイルの準備が完了しました', 'success');
            }
        }
        
        // ステータス表示
        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // ローディング表示
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // データクリア
        function clearAllData() {
            if (!confirm('すべてのデータをクリアしますか？')) return;
            
            uploadedFiles = { transaction: null, family: null, address: null };
            systemData = {
                transactions: [],
                family: [],
                addresses: [],
                inheritanceDate: null,
                processedData: {
                    balanceByPerson: {},
                    transfers: [],
                    suspiciousTransfers: [],
                    unknownSources: [],
                    annotations: new Map()
                }
            };
            
            document.querySelectorAll('.file-input').forEach(input => input.value = '');
            document.querySelectorAll('.file-input-group').forEach(group => group.classList.remove('uploaded'));
            document.querySelectorAll('.file-status').forEach(status => status.style.display = 'none');
            
            document.getElementById('analysisContainer').style.display = 'none';
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('exportAnnotatedBtn').classList.add('hidden');
            
            updateProgress();
            showStatus('全データをクリアしました', 'info');
        }
        
        // 改良版CSVパーサー
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            let inQuotes = false;
            let currentLine = [];
            let currentValue = '';
            
            for (let line of lines) {
                if (!line.trim() && !inQuotes) continue;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        currentLine.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                if (!inQuotes) {
                    currentLine.push(currentValue.trim());
                    if (currentLine.length > 0 && currentLine.some(v => v)) {
                        result.push(currentLine);
                    }
                    currentLine = [];
                    currentValue = '';
                } else {
                    currentValue += '\n';
                }
            }
            
            return result;
        }
        
        // ファイル読み込み
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // 全ファイル処理
        async function processAllFiles() {
            try {
                showLoading(true);
                showStatus('データを分析しています...', 'info');
                
                // 取引データ処理
                const transactionText = await readFile(uploadedFiles.transaction);
                const transactionData = parseCSV(transactionText);
                systemData.transactions = parseTransactionData(transactionData);
                
                // 家族構成処理
                const familyText = await readFile(uploadedFiles.family);
                const familyData = parseCSV(familyText);
                systemData.family = parseFamilyData(familyData);
                
                // 住所履歴処理
                const addressText = await readFile(uploadedFiles.address);
                const addressData = parseCSV(addressText);
                systemData.addresses = parseAddressData(addressData);
                
                // データ分析実行
                await analyzeData();
                
                // 結果表示
                document.getElementById('analysisContainer').style.display = 'block';
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('exportAnnotatedBtn').classList.remove('hidden');
                
                updateAllViews();
                showStatus('分析が完了しました', 'success');
                
                // 分析結果へスクロール
                document.getElementById('analysisContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                showStatus('エラーが発生しました: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }
        
        // 取引データ解析
        function parseTransactionData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const transactions = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 13) {
                    transactions.push({
                        id: i,
                        bank: row[0] || '',
                        branch: row[1] || '',
                        name: row[2] || '',
                        accountType: row[3] || '',
                        accountNumber: row[4] || '',
                        date: row[5] || '',
                        time: row[6] || '',
                        withdrawal: parseFloat(row[7]) || 0,
                        deposit: parseFloat(row[8]) || 0,
                        location: row[9] || '',
                        machineId: row[10] || '',
                        description: row[11] || '',
                        balance: parseFloat(row[12]) || 0,
                        flags: [],
                        annotations: []
                    });
                }
            }
            
            return transactions.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare !== 0) return dateCompare;
                // 同日の場合は時刻でソート
                return (a.time || '00:00:00').localeCompare(b.time || '00:00:00');
            });
        }
        
        // 家族データ解析
        function parseFamilyData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const family = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 4) {
                    const member = {
                        name: row[0] || '',
                        relationship: row[1] || '',
                        birthDate: row[2] || '',
                        inheritanceInfo: row[3] || ''
                    };
                    
                    // 被相続人の判定と相続開始日の取得
                    if (member.relationship.includes('被相続人')) {
                        member.isDeceased = true;
                        // D列に日付形式があれば相続開始日として設定
                        if (member.inheritanceInfo && member.inheritanceInfo.match(/\d{4}-\d{2}-\d{2}/)) {
                            systemData.inheritanceDate = member.inheritanceInfo;
                        }
                    } else {
                        // その他の人は年齢として扱う
                        const ageMatch = member.inheritanceInfo.match(/(\d+)歳?/);
                        if (ageMatch) {
                            member.ageAtInheritance = parseInt(ageMatch[1]);
                        }
                    }
                    
                    // 性別推定
                    const rel = member.relationship;
                    if (rel.includes('夫') || rel.includes('父') || rel.includes('男') || 
                        rel.includes('息子') || rel.includes('長男') || rel.includes('次男') || rel.includes('三男')) {
                        member.gender = 'male';
                    } else if (rel.includes('妻') || rel.includes('母') || rel.includes('女') || 
                               rel.includes('娘') || rel.includes('長女') || rel.includes('次女') || rel.includes('三女')) {
                        member.gender = 'female';
                    } else {
                        member.gender = 'unknown';
                    }
                    
                    family.push(member);
                }
            }
            
            return family;
        }
        
        // 住所データ解析
        function parseAddressData(rawData) {
            if (!rawData || rawData.length < 2) return [];
            
            const addresses = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length >= 3) {
                    addresses.push({
                        name: row[0] || '',
                        address: row[1] || '',
                        startDate: row[2] || '',
                        endDate: row[3] || ''
                    });
                }
            }
            
            // 終了日が無い場合の補完処理
            const peopleNames = [...new Set(addresses.map(a => a.name))];
            peopleNames.forEach(name => {
                const personAddresses = addresses
                    .filter(a => a.name === name)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                for (let i = 0; i < personAddresses.length - 1; i++) {
                    if (!personAddresses[i].endDate) {
                        const nextStartDate = new Date(personAddresses[i + 1].startDate);
                        nextStartDate.setDate(nextStartDate.getDate() - 1);
                        personAddresses[i].endDate = nextStartDate.toISOString().split('T')[0];
                    }
                }
            });
            
            return addresses;
        }
        
        // 改良版データ分析
        async function analyzeData() {
            const inheritanceDate = systemData.inheritanceDate;
            const largeAmountThreshold = parseInt(document.getElementById('largeAmountThreshold').value);
            const unknownSourceThreshold = parseInt(document.getElementById('unknownSourceThreshold').value);
            const transferDays = parseInt(document.getElementById('transferDays').value);
            const transferErrorRate = parseInt(document.getElementById('transferErrorRate').value) / 100;
            const inheritancePeriod = parseInt(document.getElementById('inheritancePeriod').value);
            
            // 取引フラグ付けと注記作成
            addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod);
            
            // 残高推移分析（補完機能付き）
            analyzeBalanceHistory();
            
            // 高精度資金移動検出
            detectMoneyTransfers(transferDays, transferErrorRate);
            
            // 原資不明取引検出（摘要空白含む）
            detectUnknownSources(unknownSourceThreshold);
            
            // 注記情報の生成
            generateAnnotations();
        }
        
        // 改良版取引フラグ付け
        function addTransactionFlags(inheritanceDate, largeAmountThreshold, unknownSourceThreshold, inheritancePeriod) {
            const inhDate = new Date(inheritanceDate);
            
            systemData.transactions.forEach(tx => {
                tx.flags = [];
                tx.annotations = [];
                const amount = Math.max(tx.withdrawal, tx.deposit);
                const txDate = new Date(tx.date);
                
                // 大額取引
                if (amount >= largeAmountThreshold) {
                    tx.flags.push('大額取引');
                    tx.annotations.push(`★大額取引(${amount.toLocaleString()}円)`);
                }
                
                // 摘要空白チェック（重要）
                if (!tx.description || tx.description.trim() === '') {
                    tx.flags.push('摘要空白');
                    tx.annotations.push('★摘要欄空白(窓口取引の可能性)');
                }
                
                // 原資不明（改良版）
                if (tx.deposit >= unknownSourceThreshold) {
                    if (!tx.description || 
                        tx.description.trim() === '' || 
                        tx.description === '入金' || 
                        tx.description.includes('現金') ||
                        tx.description.includes('ATM')) {
                        
                        tx.flags.push('原資不明');
                        tx.annotations.push(`★原資不明入金(${tx.deposit.toLocaleString()}円)`);
                        
                        // 住所移動直後チェック
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('★住所移動後30日以内の入金');
                        }
                    }
                }
                
                // 相続前後期間
                const daysDiff = Math.abs(txDate - inhDate) / (1000 * 60 * 60 * 24);
                if (daysDiff <= inheritancePeriod) {
                    tx.flags.push('相続前後');
                    if (amount >= 100000) {
                        tx.annotations.push(`★相続前後${Math.round(daysDiff)}日の取引`);
                    }
                }
                
                // 口座開設・解約
                if (tx.description && (tx.description.includes('開設') || tx.description.includes('新規'))) {
                    tx.flags.push('口座開設');
                    tx.annotations.push('★口座開設');
                }
                if (tx.description && (tx.description.includes('解約') || tx.description.includes('閉鎖'))) {
                    tx.flags.push('口座解約');
                    tx.annotations.push('★口座解約');
                }
                
                // 未成年判定（改良版）
                const person = systemData.family.find(f => f.name === tx.name);
                if (person && person.birthDate) {
                    const age = calculateAge(person.birthDate, tx.date);
                    if (age < 20) {
                        tx.flags.push('未成年');
                        tx.annotations.push(`★未成年取引(${age}歳)`);
                        
                        // 口座開設時の管理者推定
                        if (tx.flags.includes('口座開設')) {
                            const cohabitants = getCohabitantsAtDate(tx.name, tx.date);
                            if (cohabitants.length > 0) {
                                tx.annotations.push(`★推定管理者: ${cohabitants.join(', ')}`);
                            }
                        }
                    }
                }
                
                // 被相続人同居判定
                if (isSameAddressAsDeceased(tx.name, tx.date)) {
                    tx.flags.push('被相続人同居');
                    tx.annotations.push('★被相続人と同居');
                }
            });
        }
        
        // 年齢計算
        function calculateAge(birthDate, targetDate) {
            const birth = new Date(birthDate);
            const target = new Date(targetDate);
            let age = target.getFullYear() - birth.getFullYear();
            const monthDiff = target.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && target.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        // 最近の住所変更チェック
        function checkRecentAddressChange(name, date, days) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const startDate = new Date(addr.startDate);
                const daysDiff = (targetDate - startDate) / (1000 * 60 * 60 * 24);
                if (daysDiff >= 0 && daysDiff <= days) {
                    return true;
                }
            }
            return false;
        }
        
        // 特定日の同居人取得
        function getCohabitantsAtDate(name, date) {
            const address = getAddressAtDate(name, date);
            if (!address) return [];
            
            const cohabitants = [];
            systemData.family.forEach(person => {
                if (person.name !== name) {
                    const personAddr = getAddressAtDate(person.name, date);
                    if (personAddr === address) {
                        cohabitants.push(person.name);
                    }
                }
            });
            
            return cohabitants;
        }
        
        // 被相続人同居判定
        function isSameAddressAsDeceased(personName, date) {
            const deceased = systemData.family.find(f => f.isDeceased);
            if (!deceased) return false;
            
            const deceasedAddr = getAddressAtDate(deceased.name, date);
            const personAddr = getAddressAtDate(personName, date);
            
            return deceasedAddr && personAddr && deceasedAddr === personAddr;
        }
        
        // 特定日の住所取得
        function getAddressAtDate(name, date) {
            const targetDate = new Date(date);
            const addresses = systemData.addresses.filter(a => a.name === name);
            
            for (let addr of addresses) {
                const start = new Date(addr.startDate);
                const end = addr.endDate ? new Date(addr.endDate) : new Date('9999-12-31');
                
                if (targetDate >= start && targetDate <= end) {
                    return addr.address;
                }
            }
            
            return null;
        }
        
        // 改良版残高推移分析（補完機能付き）
        function analyzeBalanceHistory() {
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            systemData.processedData.balanceByPerson = {};
            
            // 人ごとにグループ化
            systemData.family.forEach(person => {
                const personData = {
                    name: person.name,
                    accounts: {},
                    yearlyTotal: {},
                    inheritanceTotal: 0
                };
                
                // その人の全取引を取得
                const personTx = systemData.transactions.filter(tx => tx.name === person.name);
                
                // 口座ごとにグループ化
                personTx.forEach(tx => {
                    const accountKey = `${tx.bank}_${tx.branch}_${tx.accountNumber}`;
                    if (!personData.accounts[accountKey]) {
                        personData.accounts[accountKey] = {
                            bank: tx.bank,
                            branch: tx.branch,
                            accountNumber: tx.accountNumber,
                            accountType: tx.accountType,
                            transactions: [],
                            yearlyBalance: {},
                            inheritanceBalance: 0,
                            openDate: null,
                            closeDate: null
                        };
                    }
                    personData.accounts[accountKey].transactions.push(tx);
                    
                    // 口座開設・解約日の記録
                    if (tx.flags.includes('口座開設')) {
                        personData.accounts[accountKey].openDate = tx.date;
                    }
                    if (tx.flags.includes('口座解約')) {
                        personData.accounts[accountKey].closeDate = tx.date;
                    }
                });
                
                // 各口座の年末残高を計算（補完機能付き）
                Object.values(personData.accounts).forEach(account => {
                    // 5年分の年末残高
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const yearEnd = `${year}-12-31`;
                        const balance = getBalanceAtDate(account.transactions, yearEnd, true);
                        account.yearlyBalance[year] = balance;
                        
                        if (!personData.yearlyTotal[year]) {
                            personData.yearlyTotal[year] = 0;
                        }
                        if (balance.value !== null) {
                            personData.yearlyTotal[year] += balance.value;
                        }
                    }
                    
                    // 相続開始日残高
                    const inhBalance = getBalanceAtDate(account.transactions, inheritanceDate, true);
                    account.inheritanceBalance = inhBalance;
                    if (inhBalance.value !== null) {
                        personData.inheritanceTotal += inhBalance.value;
                    }
                });
                
                systemData.processedData.balanceByPerson[person.name] = personData;
            });
        }
        
        // 改良版：特定日の残高取得（補完機能付き）
        function getBalanceAtDate(transactions, targetDate, withInterpolation = false) {
            const target = new Date(targetDate);
            let result = { value: null, isInterpolated: false };
            
            // 残高が記録されている取引のみ
            const balanceTx = transactions.filter(tx => tx.balance > 0);
            if (balanceTx.length === 0) return result;
            
            // 対象日以前で最も近い残高
            let closestBefore = null;
            let closestBeforeDate = null;
            
            // 対象日以降で最も近い残高
            let closestAfter = null;
            let closestAfterDate = null;
            
            balanceTx.forEach(tx => {
                const txDate = new Date(tx.date);
                
                if (txDate <= target) {
                    if (!closestBeforeDate || txDate > closestBeforeDate) {
                        closestBeforeDate = txDate;
                        closestBefore = tx;
                    }
                } else {
                    if (!closestAfterDate || txDate < closestAfterDate) {
                        closestAfterDate = txDate;
                        closestAfter = tx;
                    }
                }
            });
            
            // 対象日以前に残高があればそれを使用
            if (closestBefore) {
                result.value = closestBefore.balance;
                
                // 年末時点の補完チェック
                if (withInterpolation && targetDate.endsWith('-12-31')) {
                    const yearEnd = new Date(targetDate);
                    const daysDiff = (yearEnd - closestBeforeDate) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 30) {
                        result.isInterpolated = true;
                    }
                }
                
                return result;
            }
            
            // 口座開設前なら0
            const firstTx = transactions[0];
            if (firstTx && new Date(firstTx.date) > target) {
                result.value = 0;
                return result;
            }
            
            // 対象日以降の残高を補完として使用
            if (closestAfter && withInterpolation) {
                result.value = closestAfter.balance;
                result.isInterpolated = true;
                return result;
            }
            
            return result;
        }
        
        // 改良版：高精度資金移動検出
        function detectMoneyTransfers(maxDays, errorRate) {
            systemData.processedData.transfers = [];
            systemData.processedData.suspiciousTransfers = [];
            
            // 出金取引を抽出
            const withdrawals = systemData.transactions.filter(tx => tx.withdrawal > 0);
            
            withdrawals.forEach(withdrawal => {
                const wDate = new Date(withdrawal.date);
                const wAmount = withdrawal.withdrawal;
                
                // 対象期間内の入金を検索
                const potentialDeposits = systemData.transactions.filter(tx => {
                    if (tx.deposit === 0) return false;
                    
                    const dDate = new Date(tx.date);
                    const daysDiff = (dDate - wDate) / (1000 * 60 * 60 * 24);
                    
                    // 日数条件
                    if (daysDiff < 0 || daysDiff > maxDays) return false;
                    
                    // 金額誤差条件
                    const amountDiff = Math.abs(tx.deposit - wAmount) / wAmount;
                    if (amountDiff > errorRate) return false;
                    
                    return true;
                });
                
                // マッチング候補をスコア付けして評価
                const matches = potentialDeposits.map(deposit => {
                    const dDate = new Date(deposit.date);
                    const daysDiff = (dDate - wDate) / (1000 * 60 * 60 * 24);
                    const amountDiff = Math.abs(deposit.deposit - wAmount);
                    const amountDiffRate = amountDiff / wAmount;
                    
                    // スコア計算（低いほど良い）
                    let score = daysDiff * 10 + amountDiffRate * 100;
                    
                    // 同一人物間なら低スコア
                    if (withdrawal.name === deposit.name) {
                        score += 50;
                    }
                    
                    // 親子関係チェック
                    const isFamily = checkFamilyRelation(withdrawal.name, deposit.name);
                    if (isFamily) {
                        score -= 20;
                    }
                    
                    // 時刻考慮（同日の場合）
                    if (daysDiff === 0 && withdrawal.time && deposit.time) {
                        const wTime = withdrawal.time.split(':').map(Number);
                        const dTime = deposit.time.split(':').map(Number);
                        const wMinutes = wTime[0] * 60 + wTime[1];
                        const dMinutes = dTime[0] * 60 + dTime[1];
                        
                        if (dMinutes < wMinutes) {
                            score += 100; // 入金が出金より前は不自然
                        }
                    }
                    
                    return {
                        deposit: deposit,
                        score: score,
                        daysDiff: daysDiff,
                        amountDiff: amountDiff,
                        amountDiffRate: amountDiffRate,
                        isFamily: isFamily
                    };
                });
                
                // 最良のマッチを選択
                if (matches.length > 0) {
                    matches.sort((a, b) => a.score - b.score);
                    const bestMatch = matches[0];
                    
                    const transfer = {
                        date: withdrawal.date,
                        from: withdrawal.name,
                        to: bestMatch.deposit.name,
                        amount: withdrawal.withdrawal,
                        fromBank: `${withdrawal.bank} ${withdrawal.branch}`,
                        toBank: `${bestMatch.deposit.bank} ${bestMatch.deposit.branch}`,
                        fromAccount: withdrawal.accountNumber,
                        toAccount: bestMatch.deposit.accountNumber,
                        depositDate: bestMatch.deposit.date,
                        daysDiff: bestMatch.daysDiff,
                        amountDiff: bestMatch.amountDiff,
                        amountDiffRate: bestMatch.amountDiffRate,
                        isFamily: bestMatch.isFamily,
                        score: bestMatch.score
                    };
                    
                    // 疑わしい資金移動の判定
                    if (bestMatch.score < 30 && withdrawal.name !== bestMatch.deposit.name) {
                        systemData.processedData.transfers.push(transfer);
                        
                        // フラグとアノテーション追加
                        withdrawal.flags.push('資金移動(出)');
                        bestMatch.deposit.flags.push('資金移動(入)');
                        
                        const annotation = `★資金移動: ${withdrawal.name}→${bestMatch.deposit.name} (${bestMatch.daysDiff}日後, 誤差${(bestMatch.amountDiffRate * 100).toFixed(1)}%)`;
                        withdrawal.annotations.push(annotation);
                        bestMatch.deposit.annotations.push(annotation);
                        
                        // 特に疑わしいパターン
                        if (bestMatch.isFamily && bestMatch.daysDiff <= 1 && bestMatch.amountDiffRate < 0.01) {
                            systemData.processedData.suspiciousTransfers.push(transfer);
                            withdrawal.annotations.push('★要注意：家族間即日資金移動');
                            bestMatch.deposit.annotations.push('★要注意：家族間即日資金移動');
                        }
                    }
                }
            });
        }
        
        // 家族関係チェック
        function checkFamilyRelation(name1, name2) {
            const person1 = systemData.family.find(f => f.name === name1);
            const person2 = systemData.family.find(f => f.name === name2);
            
            if (!person1 || !person2) return false;
            
            // 親子関係の判定（続柄から推定）
            const rel1 = person1.relationship;
            const rel2 = person2.relationship;
            
            // 被相続人と配偶者
            if ((person1.isDeceased && rel2.includes('配偶者')) ||
                (person2.isDeceased && rel1.includes('配偶者'))) {
                return true;
            }
            
            // 親子関係
            if ((rel1.includes('子') && !rel1.includes('孫')) || 
                (rel2.includes('子') && !rel2.includes('孫'))) {
                return true;
            }
            
            return false;
        }
        
        // 改良版：原資不明取引検出
        function detectUnknownSources(threshold) {
            systemData.processedData.unknownSources = [];
            
            systemData.transactions.forEach(tx => {
                if (tx.deposit >= threshold) {
                    let isUnknown = false;
                    let reason = '';
                    
                    // 摘要空白（最重要）
                    if (!tx.description || tx.description.trim() === '') {
                        isUnknown = true;
                        reason = '摘要欄空白（窓口取引）';
                    }
                    // 一般的な入金表記
                    else if (tx.description === '入金' || 
                             tx.description === '現金' || 
                             tx.description === '現金入金' ||
                             tx.description.includes('ATM')) {
                        isUnknown = true;
                        reason = `入金種別: ${tx.description}`;
                    }
                    
                    if (isUnknown) {
                        systemData.processedData.unknownSources.push({
                            ...tx,
                            reason: reason
                        });
                        
                        if (!tx.flags.includes('原資不明')) {
                            tx.flags.push('原資不明');
                        }
                        
                        // 追加の疑義チェック
                        const recentMove = checkRecentAddressChange(tx.name, tx.date, 30);
                        if (recentMove) {
                            tx.annotations.push('★住所移動直後の原資不明入金（要確認）');
                        }
                        
                        // 未成年への入金
                        if (tx.flags.includes('未成年')) {
                            tx.annotations.push('★未成年口座への原資不明入金（贈与の可能性）');
                        }
                    }
                }
            });
        }
        
        // 注記情報の生成
        function generateAnnotations() {
            systemData.processedData.annotations.clear();
            
            systemData.transactions.forEach(tx => {
                if (tx.annotations.length > 0) {
                    const key = `${tx.id}`;
                    systemData.processedData.annotations.set(key, tx.annotations.join(' / '));
                }
            });
        }
        
        // ビュー更新
        function updateAllViews() {
            updateSummaryView();
            updateBalanceView();
            updateTransfersView();
            updateUnknownView();
            updateAddressView();
            updateAnnotatedView();
            updateFamilyView();
        }
        
        // 総括ビュー
        function updateSummaryView() {
            const container = document.getElementById('summary-content');
            const inheritanceDate = systemData.inheritanceDate;
            
            const totalTx = systemData.transactions.length;
            const flaggedTx = systemData.transactions.filter(tx => tx.flags.length > 0).length;
            const transfers = systemData.processedData.transfers.length;
            const suspiciousTransfers = systemData.processedData.suspiciousTransfers.length;
            const unknownSources = systemData.processedData.unknownSources.length;
            const blankMemo = systemData.transactions.filter(tx => tx.flags.includes('摘要空白')).length;
            
            let html = `
                <div class="info-card">
                    <h3>📊 調査結果サマリー</h3>
                    <p><strong>相続開始日：</strong>${inheritanceDate}</p>
                    <p><strong>分析対象期間：</strong>${systemData.transactions[0]?.date || 'N/A'} ～ ${systemData.transactions[systemData.transactions.length-1]?.date || 'N/A'}</p>
                    <p><strong>対象人数：</strong>${systemData.family.length}名</p>
                </div>
                
                <div class="alert-card ${flaggedTx > totalTx * 0.1 ? 'danger' : 'warning'}">
                    <h4>🔍 検出結果</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>総取引件数：<strong>${totalTx}</strong>件</li>
                        <li>要注意取引：<strong>${flaggedTx}</strong>件（${(flaggedTx/totalTx*100).toFixed(1)}%）</li>
                        <li>資金移動検出：<strong>${transfers}</strong>件${suspiciousTransfers > 0 ? ` <span style="color: #c62828;">（うち要注意 ${suspiciousTransfers}件）</span>` : ''}</li>
                        <li>原資不明取引：<strong>${unknownSources}</strong>件</li>
                        <li>摘要空白取引：<strong>${blankMemo}</strong>件 <span style="color: #f57c00;">（窓口取引の可能性）</span></li>
                    </ul>
                </div>
            `;
            
            // 各人の残高サマリー
            html += `
                <div class="info-card">
                    <h3>💰 各人の残高状況</h3>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>氏名</th>
                                    <th>続柄</th>
                                    <th>相続時残高</th>
                                    <th>口座数</th>
                                    <th>要注意取引</th>
                                    <th>原資不明</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            systemData.family.forEach(person => {
                const balanceData = systemData.processedData.balanceByPerson[person.name];
                const flaggedCount = systemData.transactions.filter(tx => 
                    tx.name === person.name && tx.flags.length > 0
                ).length;
                const unknownCount = systemData.processedData.unknownSources.filter(tx => 
                    tx.name === person.name
                ).length;
                
                const rowClass = person.isDeceased ? 'highlight-row' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="font-bold">${person.name}</td>
                        <td>${person.relationship}</td>
                        <td class="text-right">${balanceData ? balanceData.inheritanceTotal.toLocaleString() : 0}円</td>
                        <td class="text-center">${balanceData ? Object.keys(balanceData.accounts).length : 0}</td>
                        <td class="text-center">${flaggedCount > 0 ? `<span class="annotation-badge badge-large-amount">${flaggedCount}</span>` : '0'}</td>
                        <td class="text-center">${unknownCount > 0 ? `<span class="annotation-badge badge-unknown-source">${unknownCount}</span>` : '0'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            
            // 重要な注意事項
            if (suspiciousTransfers > 0 || blankMemo > 10) {
                html += `
                    <div class="alert-card danger">
                        <h4>⚠️ 重要な確認事項</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                `;
                
                if (suspiciousTransfers > 0) {
                    html += '<li>家族間での即日資金移動が検出されました。贈与の可能性があるため、契約書等の確認が必要です。</li>';
                }
                
                if (blankMemo > 10) {
                    html += '<li>摘要欄が空白の取引が多数検出されました。銀行窓口での取引記録を確認してください。</li>';
                }
                
                html += '</ul></div>';
            }
            
            container.innerHTML = html;
        }
        
        // 残高推移表ビュー（改良版）
        function updateBalanceView() {
            const container = document.getElementById('balance-content');
            const baseYear = parseInt(document.getElementById('baseYear').value);
            const inheritanceDate = systemData.inheritanceDate;
            
            let html = '<h3 style="margin: 20px 0;">💰 各人別残高推移表</h3>';
            html += '<p style="color: #7986cb; font-style: italic; margin-bottom: 20px;">※ 斜体の数値は年内最終取引日の残高を表示（補完値）</p>';
            
            Object.entries(systemData.processedData.balanceByPerson).forEach(([name, personData]) => {
                const person = systemData.family.find(f => f.name === name);
                const cardClass = person && person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${name} の残高推移</h4>
                        <div class="balance-table-wrapper">
                            <table class="balance-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 220px;">口座情報</th>
                `;
                
                // 年度ヘッダー
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    html += `<th style="min-width: 140px;">${year}年末</th>`;
                }
                html += `<th class="inheritance-date" style="min-width: 160px;">相続開始日<br>(${inheritanceDate})</th>`;
                html += '</tr></thead><tbody>';
                
                // 各口座の残高
                Object.values(personData.accounts).forEach(account => {
                    html += '<tr>';
                    html += `<td class="account-row">
                        ${account.bank} ${account.branch}<br>
                        ${account.accountType} ${account.accountNumber}
                        ${account.openDate ? `<br><small>開設: ${account.openDate}</small>` : ''}
                        ${account.closeDate ? `<br><small>解約: ${account.closeDate}</small>` : ''}
                    </td>`;
                    
                    let prevBalance = 0;
                    for (let year = baseYear - 4; year <= baseYear; year++) {
                        const balanceData = account.yearlyBalance[year] || { value: null, isInterpolated: false };
                        
                        if (balanceData.value !== null) {
                            const change = balanceData.value - prevBalance;
                            const changeClass = change > 0 ? 'balance-positive' : change < 0 ? 'balance-negative' : '';
                            const interpolatedClass = balanceData.isInterpolated ? 'balance-interpolated' : '';
                            
                            html += `<td class="${interpolatedClass}">
                                ${balanceData.value.toLocaleString()}
                                ${prevBalance > 0 && !balanceData.isInterpolated ? 
                                    `<span class="balance-change ${changeClass}">(${change > 0 ? '+' : ''}${change.toLocaleString()})</span>` 
                                    : ''}
                            </td>`;
                            prevBalance = balanceData.value;
                        } else {
                            html += '<td>-</td>';
                        }
                    }
                    
                    const inhBalance = account.inheritanceBalance;
                    if (inhBalance.value !== null) {
                        html += `<td class="inheritance-date ${inhBalance.isInterpolated ? 'balance-interpolated' : ''}">
                            ${inhBalance.value.toLocaleString()}
                        </td>`;
                    } else {
                        html += '<td class="inheritance-date">-</td>';
                    }
                    
                    html += '</tr>';
                });
                
                // 合計行
                html += '<tr class="total-row">';
                html += '<td>合計</td>';
                
                for (let year = baseYear - 4; year <= baseYear; year++) {
                    const total = personData.yearlyTotal[year] || 0;
                    html += `<td>${total.toLocaleString()}</td>`;
                }
                html += `<td class="inheritance-date">${personData.inheritanceTotal.toLocaleString()}</td>`;
                html += '</tr></tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // 資金移動ビュー（改良版）
        function updateTransfersView() {
            const container = document.getElementById('transfers-content');
            const transfers = systemData.processedData.transfers;
            const suspicious = systemData.processedData.suspiciousTransfers;
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="alert-card info"><h3>資金移動は検出されませんでした</h3></div>';
                return;
            }
            
            let html = `
                <div class="alert-card ${suspicious.length > 0 ? 'danger' : 'warning'}">
                    <h3>💸 資金移動分析結果（${transfers.length}件）</h3>
                    <p>設定期間内（${document.getElementById('transferDays').value}日以内）で金額誤差${document.getElementById('transferErrorRate').value}%以内の入出金を検出しました。</p>
                    ${suspicious.length > 0 ? `<p style="color: #c62828; font-weight: 600;">★ 特に注意が必要な資金移動が${suspicious.length}件検出されました。</p>` : ''}
                </div>
            `;
            
            if (suspicious.length > 0) {
                html += `
                    <div class="info-card danger-highlight">
                        <h4>⚠️ 要注意資金移動</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>出金日</th>
                                        <th>送金者</th>
                                        <th>受取人</th>
                                        <th>関係</th>
                                        <th>金額</th>
                                        <th>入金日</th>
                                        <th>日数</th>
                                        <th>誤差</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                suspicious.forEach(transfer => {
                    html += `
                        <tr class="danger-highlight">
                            <td>${transfer.date}</td>
                            <td>${transfer.from}</td>
                            <td>${transfer.to}</td>
                            <td>${transfer.isFamily ? '<span class="annotation-badge badge-cohabit">家族</span>' : '-'}</td>
                            <td class="text-right">${transfer.amount.toLocaleString()}円</td>
                            <td>${transfer.depositDate}</td>
                            <td class="text-center">${transfer.daysDiff}日</td>
                            <td class="text-center">${(transfer.amountDiffRate * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            html += `
                <div class="info-card">
                    <h4>全資金移動一覧</h4>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>出金日</th>
                                    <th>送金者</th>
                                    <th>送金元</th>
                                    <th>受取人</th>
                                    <th>受取先</th>
                                    <th>金額</th>
                                    <th>入金日</th>
                                    <th>誤差</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            transfers.forEach(transfer => {
                const isSuspicious = suspicious.some(s => 
                    s.date === transfer.date && 
                    s.from === transfer.from && 
                    s.to === transfer.to
                );
                
                html += `
                    <tr ${isSuspicious ? 'class="highlight-row"' : ''}>
                        <td>${transfer.date}</td>
                        <td>${transfer.from}</td>
                        <td>${transfer.fromBank}</td>
                        <td>${transfer.to}</td>
                        <td>${transfer.toBank}</td>
                        <td class="text-right">${transfer.amount.toLocaleString()}円</td>
                        <td>${transfer.depositDate}</td>
                        <td class="text-right">${transfer.amountDiff.toLocaleString()}円</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // 原資不明ビュー（改良版）
        function updateUnknownView() {
            const container = document.getElementById('unknown-content');
            const unknownSources = systemData.processedData.unknownSources;
            
            if (unknownSources.length === 0) {
                container.innerHTML = '<div class="alert-card success"><h3>原資不明の取引は検出されませんでした</h3></div>';
                return;
            }
            
            // 理由別に分類
            const byReason = {};
            unknownSources.forEach(tx => {
                if (!byReason[tx.reason]) {
                    byReason[tx.reason] = [];
                }
                byReason[tx.reason].push(tx);
            });
            
            let html = `
                <div class="alert-card danger">
                    <h3>❓ 原資不明取引（${unknownSources.length}件）</h3>
                    <p>入金元が不明または確認が必要な取引を検出しました。</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
            `;
            
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `<li>${reason}：<strong>${txs.length}</strong>件</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            // 理由別詳細
            Object.entries(byReason).forEach(([reason, txs]) => {
                html += `
                    <div class="info-card">
                        <h4>${reason}（${txs.length}件）</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>日付</th>
                                        <th>氏名</th>
                                        <th>銀行・支店</th>
                                        <th>金額</th>
                                        <th>残高</th>
                                        <th>特記事項</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                txs.forEach(tx => {
                    const specialNotes = [];
                    if (tx.flags.includes('相続前後')) specialNotes.push('相続前後');
                    if (tx.flags.includes('未成年')) specialNotes.push('未成年');
                    if (tx.flags.includes('被相続人同居')) specialNotes.push('同居');
                    
                    html += `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.name}</td>
                            <td>${tx.bank} ${tx.branch}</td>
                            <td class="text-right">${tx.deposit.toLocaleString()}円</td>
                            <td class="text-right">${tx.balance.toLocaleString()}円</td>
                            <td>
                                ${specialNotes.map(note => 
                                    `<span class="annotation-badge badge-${note === '相続前後' ? 'inheritance-period' : note === '未成年' ? 'minor' : 'cohabit'}">${note}</span>`
                                ).join(' ')}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // 住所履歴ビュー（改良版）
        function updateAddressView() {
            const container = document.getElementById('addresses-content');
            const inheritanceDate = systemData.inheritanceDate;
            const deceased = systemData.family.find(f => f.isDeceased);
            const deceasedInhAddr = deceased ? getAddressAtDate(deceased.name, inheritanceDate) : null;
            
            let html = '<h3 style="margin: 20px 0;">🏠 住所移転状況一覧</h3>';
            
            // 相続開始時の同居状況サマリー
            if (deceased && deceasedInhAddr) {
                const cohabitants = [];
                systemData.family.forEach(person => {
                    if (!person.isDeceased) {
                        const addr = getAddressAtDate(person.name, inheritanceDate);
                        if (addr === deceasedInhAddr) {
                            cohabitants.push(person.name);
                        }
                    }
                });
                
                if (cohabitants.length > 0) {
                    html += `
                        <div class="alert-card warning">
                            <h4>相続開始時の同居状況</h4>
                            <p>被相続人（${deceased.name}）と同居していた相続人：<strong>${cohabitants.join('、')}</strong></p>
                            <p>住所：${deceasedInhAddr}</p>
                        </div>
                    `;
                }
            }
            
            // 各人の住所履歴
            systemData.family.forEach(person => {
                const addresses = systemData.addresses.filter(a => a.name === person.name);
                if (addresses.length === 0) return;
                
                const cardClass = person.isDeceased ? 'danger-highlight' : '';
                
                html += `
                    <div class="info-card ${cardClass}">
                        <h4>${person.name} （${person.relationship}）</h4>
                        <div class="data-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>期間</th>
                                        <th>住所</th>
                                        <th>居住年数</th>
                                        <th>相続時</th>
                                        <th>備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                addresses.forEach(addr => {
                    const start = new Date(addr.startDate);
                    const end = addr.endDate ? new Date(addr.endDate) : new Date();
                    const years = Math.floor((end - start) / (365.25 * 24 * 60 * 60 * 1000));
                    const months = Math.floor(((end - start) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
                    
                    const isCurrent = !addr.endDate;
                    const inhDate = new Date(inheritanceDate);
                    const wasLivingHereDuringInheritance = start <= inhDate && (addr.endDate ? new Date(addr.endDate) >= inhDate : true);
                    
                    const isSameAsDeceased = deceased && deceasedInhAddr === addr.address && wasLivingHereDuringInheritance;
                    
                    html += `
                        <tr ${wasLivingHereDuringInheritance ? 'class="highlight-row"' : ''}>
                            <td>${addr.startDate} ～ ${addr.endDate || '現在'}</td>
                            <td>${addr.address}</td>
                            <td>${years}年${months > 0 ? `${months}ヶ月` : ''}</td>
                            <td>${wasLivingHereDuringInheritance ? '○' : '-'}</td>
                            <td>
                                ${isCurrent ? '<span class="annotation-badge badge-account-open">現住所</span>' : ''}
                                ${isSameAsDeceased ? '<span class="annotation-badge badge-cohabit">被相続人同居</span>' : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // 注記付き明細ビュー
        function updateAnnotatedView() {
            const container = document.getElementById('annotated-content');
            
            let html = `
                <h3 style="margin: 20px 0;">📝 注記付き取引明細</h3>
                <div class="alert-card info">
                    <p>★マークが付いた項目は相続税調査において特に注意が必要な取引です。</p>
                    <p>この一覧は元データに注記を追加したもので、エクスポート機能で出力できます。</p>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table" style="min-width: 1200px;">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>時刻</th>
                                <th>氏名</th>
                                <th>銀行</th>
                                <th>支店</th>
                                <th>科目</th>
                                <th>口座番号</th>
                                <th>出金</th>
                                <th>入金</th>
                                <th>残高</th>
                                <th>摘要</th>
                                <th style="min-width: 300px;">注記</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // 注記がある取引のみ表示
            systemData.transactions.filter(tx => tx.annotations.length > 0).forEach(tx => {
                const rowClass = tx.annotations.some(a => a.includes('要注意')) ? 'danger-highlight' : 'highlight-row';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${tx.date}</td>`;
                html += `<td>${tx.time || ''}</td>`;
                html += `<td>${tx.name}</td>`;
                html += `<td>${tx.bank}</td>`;
                html += `<td>${tx.branch}</td>`;
                html += `<td>${tx.accountType}</td>`;
                html += `<td>${tx.accountNumber}</td>`;
                html += `<td class="text-right">${tx.withdrawal > 0 ? tx.withdrawal.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.deposit > 0 ? tx.deposit.toLocaleString() : ''}</td>`;
                html += `<td class="text-right">${tx.balance > 0 ? tx.balance.toLocaleString() : ''}</td>`;
                html += `<td>${tx.description}</td>`;
                html += `<td style="font-weight: 600; color: #c62828;">${tx.annotations.join(' / ')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // 家系図ビュー
        function updateFamilyView() {
            const container = document.getElementById('family-content');
            const inheritanceDate = systemData.inheritanceDate;
            
            let html = '<div class="family-tree-wrapper">';
            html += '<h2 class="family-tree-title">相続関係図</h2>';
            html += '<div class="family-tree">';
            
            // 簡易的な家系図（実装は元のコードを参考に改良）
            const deceased = systemData.family.find(f => f.isDeceased);
            const spouse = systemData.family.find(f => f.relationship.includes('配偶者'));
            const children = systemData.family.filter(f => 
                f.relationship.includes('長男') || 
                f.relationship.includes('次男') || 
                f.relationship.includes('三男') ||
                f.relationship.includes('長女') || 
                f.relationship.includes('次女') || 
                f.relationship.includes('三女') ||
                (f.relationship.includes('子') && !f.relationship.includes('孫'))
            );
            
            // 被相続人世代
            html += '<div class="generation">';
            html += '<div class="generation-label">被相続人世代</div>';
            
            if (deceased) {
                html += createFamilyMemberCard(deceased, inheritanceDate);
            }
            if (spouse) {
                html += createFamilyMemberCard(spouse, inheritanceDate);
            }
            
            html += '</div>';
            
            // 子世代
            if (children.length > 0) {
                html += '<div class="generation">';
                html += '<div class="generation-label">子世代</div>';
                
                children.forEach(child => {
                    html += createFamilyMemberCard(child, inheritanceDate);
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }
        
        // 家族メンバーカード作成
        function createFamilyMemberCard(person, inheritanceDate) {
            const currentAge = person.birthDate ? calculateAge(person.birthDate, new Date()) : null;
            const inhAge = person.ageAtInheritance || (person.birthDate ? calculateAge(person.birthDate, inheritanceDate) : null);
            const currentAddress = getAddressAtDate(person.name, new Date());
            const inhAddress = getAddressAtDate(person.name, inheritanceDate);
            
            const deceased = systemData.family.find(f => f.isDeceased);
            const isSameAddressCurrent = deceased && currentAddress === getAddressAtDate(deceased.name, new Date());
            const isSameAddressInh = deceased && inhAddress === getAddressAtDate(deceased.name, inheritanceDate);
            
            let html = `
                <div class="family-member ${person.isDeceased ? 'deceased' : ''} ${person.gender || 'unknown'}">
                    <div class="member-name">${person.name}</div>
                    <div class="member-info">
                        <div class="member-info-row">
                            <span class="member-info-label">続柄：</span>
                            <span>${person.relationship}</span>
                        </div>
                        <div class="member-info-row">
                            <span class="member-info-label">生年月日：</span>
                            <span>${person.birthDate || '不明'}</span>
                        </div>
                        ${inhAge !== null ? `
                        <div class="member-info-row">
                            <span class="member-info-label">相続時年齢：</span>
                            <span>${inhAge}歳</span>
                        </div>
                        ` : ''}
                        ${!person.isDeceased && currentAge !== null ? `
                        <div class="member-info-row">
                            <span class="member-info-label">現在年齢：</span>
                            <span>${currentAge}歳</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="address-info">
                        <div style="font-weight: 600; margin-bottom: 8px;">住所情報</div>
                        ${inhAddress ? `
                        <div style="margin: 4px 0;">
                            <strong>相続時：</strong><br>
                            ${inhAddress}
                            ${isSameAddressInh ? '<span class="address-status same-address">同居</span>' : ''}
                        </div>
                        ` : ''}
                        ${!person.isDeceased && currentAddress ? `
                        <div style="margin: 4px 0;">
                            <strong>現在：</strong><br>
                            ${currentAddress}
                            ${isSameAddressCurrent ? '<span class="address-status same-address">同居</span>' : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // タブ切り替え
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }
        
        // 結果エクスポート（サマリー）
        function exportResults() {
            const inheritanceDate = systemData.inheritanceDate;
            
            let csv = '\uFEFF'; // BOM
            csv += '相続税調査分析システム 分析結果\n';
            csv += `分析日時,${new Date().toLocaleString('ja-JP')}\n`;
            csv += `相続開始日,${inheritanceDate}\n\n`;
            
            // 要注意取引
            csv += '【要注意取引一覧】\n';
            csv += '日付,時刻,氏名,銀行,支店,出金,入金,残高,摘要,フラグ,注記\n';
            
            systemData.transactions.filter(tx => tx.flags.length > 0).forEach(tx => {
                csv += `"${tx.date}","${tx.time || ''}","${tx.name}","${tx.bank}","${tx.branch}",`;
                csv += `${tx.withdrawal},${tx.deposit},${tx.balance},"${tx.description}","${tx.flags.join('・')}","${tx.annotations.join(' / ')}"\n`;
            });
            
            csv += '\n【資金移動】\n';
            csv += '出金日,送金者,受取人,金額,入金日,日数差,金額差,家族間\n';
            systemData.processedData.transfers.forEach(t => {
                csv += `"${t.date}","${t.from}","${t.to}",${t.amount},"${t.depositDate}",${t.daysDiff},${t.amountDiff},${t.isFamily ? '○' : ''}\n`;
            });
            
            csv += '\n【原資不明取引】\n';
            csv += '日付,氏名,銀行,金額,摘要,理由\n';
            systemData.processedData.unknownSources.forEach(tx => {
                csv += `"${tx.date}","${tx.name}","${tx.bank} ${tx.branch}",${tx.deposit},"${tx.description}","${tx.reason}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `相続税調査結果_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('分析結果をエクスポートしました', 'success');
        }
        
        // 注記付き元データエクスポート
        function exportAnnotatedData() {
            let csv = '\uFEFF'; // BOM
            csv += '銀行名,支店名,氏名,科目,口座番号,日付,時刻,出金,入金,取扱店,機番,摘要,残高,注記\n';
            
            systemData.transactions.forEach(tx => {
                csv += `"${tx.bank}","${tx.branch}","${tx.name}","${tx.accountType}","${tx.accountNumber}",`;
                csv += `"${tx.date}","${tx.time || ''}",${tx.withdrawal || ''},${tx.deposit || ''},`;
                csv += `"${tx.location}","${tx.machineId}","${tx.description}",${tx.balance || ''},`;
                csv += `"${tx.annotations.join(' / ')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `注記付き取引明細_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showStatus('注記付き元データをエクスポートしました', 'success');
        }
    </script>
</body>
</html>